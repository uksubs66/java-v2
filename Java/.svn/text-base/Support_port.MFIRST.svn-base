/***************************************************************************************     
 *   Support_port:  This servlet will port a text file containing member & handicap info
 *                  to the database tables.  The text file is generated by the GHIN system.
 *
 *
 *
 *   Meadowbrook CC - MFirst
 *
 ***************************************************************************************
 */
    
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
import java.util.*;
import java.sql.*;


public class Support_port extends HttpServlet {
                           
 String rev = SystemUtils.REVLEVEL;       // Software Revision Level (Version)

 
 public void doPost(HttpServletRequest req, HttpServletResponse resp)
         throws ServletException, IOException {
           
   resp.setContentType("text/html");
   PrintWriter out = resp.getWriter();
        
   Connection con = null;                 // init DB objects
   Statement stmt = null;
   ResultSet rs = null;
     
   HttpSession session = null; 

   //
   // Make sure user didn't enter illegally
   //
   session = req.getSession(false);  // Get user's session object (no new one)

   if (session == null) {

      invalidUser(out);            // Intruder - reject
      return;
   }

   String support = "support";

   String user = (String)session.getAttribute("user");   // get username

   if (!user.equals( support )) {

      invalidUser(out);            // Intruder - reject
      return;
   }

   //
   // Load the JDBC Driver and connect to DB
   //
   String club = (String)session.getAttribute("club");   // get club name

   try {
      con = SystemUtils.Connect(club);

   }
   catch (Exception exc) {

      // Error connecting to db....

      out.println("<HTML><HEAD><TITLE>DB Connection Error Received</TITLE></HEAD>");
      out.println("<BODY><CENTER><H3>DB Connection Error</H3>");
      out.println("<BR><BR>Unable to connect to the DB.");
      out.println("<BR>Exception: "+ exc.getMessage());
      out.println("<BR><BR> <A HREF=\"/" +rev+ "/support_main.htm\">Return</A>.");
      out.println("</CENTER></BODY></HTML>");
      return;
   }

   String line = "";
   String name = "";
   String fname = "";
   String lname = "";
   String mi = "";
   String sex = "";
   String ghin = "";         // GHIN number
   String mem_id = "";       // user name - 'local number' on ghin system
   String mNum = "";         // member # derived from local number
   String mem_type = "";     // 'MENS' 'LADIES' 'MENS 18'  etc.?
   String holes = "";        // 9 or 18
   String u_hndcp = "";
   String c_hndcp = "";
   String password = "";
   String mship = "Golf";    // default
   String mtype = "";
   String status = "";
   String bag = "";
   String email = "";        // default
   String wc = "WA";         // default
   float course = 0;
   float usga = 0;
   float u_hcap = 0;           // usga hndcp
   float c_hcap = 0;          // course hndcp
   int count = 0;
   int i = 0;
   int dup = 0;
   boolean replace = false;


   //
   //  There are 2 calls to this class:
   //
   //     submit=add - to add or update the member table 
   //
   //     submit=replace - to delete the member table and then replace it
   //
   if (req.getParameter("replace") != null) {

      replace = true;

      try {

         stmt = con.createStatement();        // create a statement

         stmt.executeUpdate("DELETE FROM member2b");          // delete all records from the table

         stmt.close();              // close the stmt

      }
      catch (Exception ignore) {

      }
   }

   //
   //  read in the text file - must be named 'ghin.txt'
   //
   boolean failed = false;
   FileReader fr = null;

   try {

      fr = new FileReader("//usr//local//tomcat//webapps//" +club+ "//ghin.txt");

   }
   catch (Exception e1) {

      failed = true;
   }

   if (failed == true) {

      try {

         fr = new FileReader("c:\\java\\tomcat4\\webapps\\" + club + "\\ghin.txt");

      }
      catch (Exception e2) {

         out.println("<HTML><HEAD><TITLE>Text File Port Failed</TITLE></HEAD>");
         out.println("<BODY><CENTER><H3>Text File Conversion Failed</H3>");
         out.println("<BR><BR>File Read Failed for  " + club);
         out.println("<BR><BR>Exception Received: "+ e2.getMessage());
         out.println("<BR><BR> <A HREF=\"/v2/support_main.htm\">Return</A>");
         out.println("</CENTER></BODY></HTML>");
         return;
      }
   }

   try {

      BufferedReader bfrin = new BufferedReader(fr);
      line = new String();

      //********************************************************************
      //   format of each line in the file:
      //
      //      local#, mem#, fname, mi, lname, email, ghin#
      //********************************************************************
      //
      while ((line = bfrin.readLine()) != null) {            // get one line of text

         //  parse the line to gather all the info

         StringTokenizer tok = new StringTokenizer( line, "," );     // delimiters are comma

         mem_id = tok.nextToken();       // local#
         mNum = tok.nextToken();         // member#
         fname = tok.nextToken();        // first name 
         mi = tok.nextToken();           // mi
         lname = tok.nextToken();        // last name
            
         email = "";
         ghin = "";
           
         if ( tok.countTokens() == 1 ) {

            email = tok.nextToken();         // email
         }

         if ( tok.countTokens() == 2 ) {

            email = tok.nextToken();        // email
            ghin = tok.nextToken();         // ghin#
         }

         if (mi.equals( "?" )) {   

            mi = "";                       // null if not there
         }
         if (email.equals( "?" )) {

            email = "";                       // null if not there
         }
         if (ghin.equals( "?" )) {

            ghin = "";                       // null if not there
         }

         lname = toTitleCase( lname );                     // convert name to Title Case (Bob P...)

         fname = toTitleCase( fname );                     

         lname = lname.replace(' ', '_');                  // replace spaces in last name with an underscore


         //
         //  Process the member number (nnn, nnnA, or nnnB-E)
         //
         if (mNum.endsWith( "A" )) {

            mNum = stripA(mNum);        // strip the letter
            mtype = "Spouse Female";
          
         } else {
           
            if (mNum.endsWith( "B" ) || mNum.endsWith( "C" ) || mNum.endsWith( "D" ) || mNum.endsWith( "E" )) {

               mNum = stripA(mNum);        // strip the letter
               mtype = "Juniors";

            } else {
              
               mtype = "Member Male";
            }
         }

         //
         //  determine mship type
         //
         mship = "Golf";      // default

         u_hcap = -99;                    // indicate no hndcp
         c_hcap = -99;                    // indicate no c_hndcp

         password = lname;

         //
         //  if lname is less than 4 chars, fill with 1's
         //
         int length = password.length();

         while (length < 4) {

            password = password + "1";
            length++;
         }

         //
         // add member
         //
         PreparedStatement pstmt2 = con.prepareStatement (
            "INSERT INTO member2b (username, password, name_last, name_first, name_mi, " +
            "m_ship, m_type, email, count, c_hancap, g_hancap, wc, message, emailOpt, memNum, " +
            "ghin, locker, bag, birth, posid, msub_type) VALUES (?,?,?,?,?,?,?,?,0,?,?,?,'',1,?,?,'',?,0,'','')");

         pstmt2.clearParameters();        // clear the parms
         pstmt2.setString(1, mem_id);        // put the parm in stmt
         pstmt2.setString(2, password);
         pstmt2.setString(3, lname);
         pstmt2.setString(4, fname);
         pstmt2.setString(5, mi);
         pstmt2.setString(6, mship);
         pstmt2.setString(7, mtype);
         pstmt2.setString(8, email);
         pstmt2.setFloat(9, c_hcap);
         pstmt2.setFloat(10, u_hcap);
         pstmt2.setString(11, wc);
         pstmt2.setString(12, mNum);
         pstmt2.setString(13, ghin);
         pstmt2.setString(14, bag);
         pstmt2.executeUpdate();          // execute the prepared stmt

         pstmt2.close();              // close the stmt

      }   // end of while

   }
   catch (Exception e3) {

      out.println("<HTML><HEAD><TITLE>Text File Port Failed</TITLE></HEAD>");
      out.println("<BODY><CENTER><H3>Text File Conversion Failed</H3>");
      out.println("<BR><BR>DB Add or Update Failed for  " + club);
      out.println("<BR><BR>Exception Received: "+ e3.getMessage());
      out.println("<BR><BR> <A HREF=\"/" +rev+ "/support_main.htm\">Return</A>");
      out.println("</CENTER></BODY></HTML>");
      return;
   }

   out.println("<HTML><HEAD><TITLE>Text File Ported to DB</TITLE></HEAD>");
   out.println("<BODY><CENTER><H3>Text File Conversion Complete</H3>");
   out.println("<BR><BR>The GHIN Text File has Been Converted.");
   out.println("<BR><BR> <A HREF=\"/" +rev+ "/support_main.htm\">Return</A>");
   out.println("</CENTER></BODY></HTML>");
 }   
                                 
 // *********************************************************
 //  Strip letter 'A' from end of string
 // *********************************************************

 private final static String stripA( String s ) {
      
      char[] ca = s.toCharArray();
      char[] ca2 = new char [ca.length - 1];

          
      for ( int i=0; i<ca.length; i++ ) {
         char oldLetter = ca[i];
         if ( oldLetter <= '9' ) {
            ca2[i] = oldLetter;
         }
      } // end for
         
      return new String (ca2);

 } // end stripA


 // *********************************************************
 //  Convert Upper case names to title case (Bob P...)
 // *********************************************************

 private final static String toTitleCase( String s ) {

      char[] ca = s.toCharArray();

      boolean changed = false;
      boolean capitalise = true;

      for ( int i=0; i<ca.length; i++ ) {
         char oldLetter = ca[i];
         if ( oldLetter <= '/'
              || ':' <= oldLetter && oldLetter <= '?'
              || ']' <= oldLetter && oldLetter <= '`' ) {
            /* whitespace, control chars or punctuation */
            /* Next normal char should be capitalized */
            capitalise = true;
         } else {
            char newLetter  = capitalise
                              ? Character.toUpperCase(oldLetter)
                              : Character.toLowerCase(oldLetter);
            ca[i] = newLetter;
            changed |= (newLetter != oldLetter);
            capitalise = false;
         }
      } // end for

      return new String (ca);

 } // end toTitleCase


 // *********************************************************
 //  Remove leading zeros in member id string
 // *********************************************************

 private final static String remZero( String s ) {


      int memid = 0;
      String newS = "";
           
      //
      //  convert string to int to drop leading zeros
      //
      try {
         memid = Integer.parseInt(s);
      }
      catch (NumberFormatException e) {
         // ignore error
      }

      newS = String.valueOf( memid );      // convert back to string

      return new String (newS);

 } // end remZero


 // *********************************************************
 // Illegal access by user - force user to login....
 // *********************************************************

 private void invalidUser(PrintWriter out) {

   out.println(SystemUtils.HeadTitle("Access Error - Redirect"));
   out.println("<BODY><CENTER><img src=\"/" +rev+ "/images/foretees.gif\"><BR>");
   out.println("<hr width=\"40%\">");
   out.println("<BR><H2>Access Error</H2><BR>");
   out.println("<BR><BR>Sorry, you must login before attempting to access these features.<BR>");
   out.println("<BR><BR> <A HREF=\"/" +rev+ "/support_main.htm\">Return</A>");
   out.println("</CENTER></BODY></HTML>");

 }


 // *********************************************************
 // Database Error
 // *********************************************************

 private void dbError(PrintWriter out, Exception e) {

   out.println(SystemUtils.HeadTitle("Database Error"));
   out.println("<BODY><CENTER>");
   out.println("<BR><BR><H3>Database Access Error</H3>");
   out.println("<BR><BR>Sorry, we are unable to access the database at this time.");
   out.println("<BR><BR>" + e.getMessage());
   out.println("<BR><BR><a href=\"/" +rev+ "/support_main.htm\">Return</a>");
   out.println("</CENTER></BODY></HTML>");

 }

}
