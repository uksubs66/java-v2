/***************************************************************************************
 *   Proshop_sheet_pos:  This servlet will process the POS CHarge requests.
 *
 *     Called By:
 *                 Proshop_sheet
 *                 Proshop_oldsheets
 *                 SystemUtils (custom timer)
 *
 *
 *   created: 7/01/2011   Bob P.
 *
 *   last updated:       ******* keep this accurate *******
 *
<<<<<<< .mine
 *     9/30/11  Olympic Club (olyclub) - Updated Member and Guest fees for their new fiscal year. 
=======
 *     9/23/11  Add PCS Group POS Interface for Ironwood.
>>>>>>> .r1348
 *     8/07/11  Olympic Club (olyclub) - Updated custom processing to base Ocean Course twilight rate start time on DST and if it's before/after 9/01.
 *     8/01/11  Updated pos_hist insert statement to include the new date_time field.
 *     7/27/11  Phillyh Cricket - only charge 'No Golf' members on the St Martins course.
 *     7/20/11  Set the 'One Chit Per Res Num' option for all Jonas POS clubs.
 *     7/20/11  Allow for NorthStar POS charges to be built from a custom timer mechanism in SystemUtils (Philly Cricket case 2006).
 *     7/19/11  Add St. Martins course to custom for Philly Cricket.
 *     7/14/11  Add custom processing for the Olympic Club (olyclub) that will automatically create a charge 
 *              file each night and save it where the club can pull it.
 *
 ***************************************************************************************
 */

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
import java.util.*;
import java.sql.*;
import java.lang.Math;
import java.math.BigDecimal; 
import java.math.RoundingMode;

// ForeTees imports
import com.foretees.common.Utilities;
import com.foretees.common.parmCourse;
import com.foretees.common.parmClub;
import com.foretees.common.getParms;
import com.foretees.common.parmPOS;
import com.foretees.common.getClub;
import com.foretees.common.verifyCustom;
import com.foretees.common.congressionalCustom;
import com.foretees.common.ProcessConstants;


public class Proshop_sheet_pos {

   static String rev = SystemUtils.REVLEVEL;       // Software Revision Level (Version)

   static int filen = 0;                             // Jonas filename (unique id)
   static int resn = 0;                              // Jonas reservation number (unique id)
   static int ttidn = 0;                             // Jonas tee time id (unique id)

   //
   //  Holidays
   //
   private static long Hdate1 = ProcessConstants.memDay;     // Memorial Day
   private static long Hdate2 = ProcessConstants.july4;      // 4th of July - Monday
   private static long Hdate2b = ProcessConstants.july4b;    // 4th of July - other
   private static long Hdate3 = ProcessConstants.laborDay;   // Labor Day
   private static long Hdate4 = ProcessConstants.gFriDay;    // Good Friday
   private static long Hdate5 = ProcessConstants.tgDay;      // Thanksgiving Day


   
 
 // ********************************************************************************************
 //  Process the POS charges for the day requested
 //
 //     Prompt the user to confirm this request, then build the charges and sent to POS.
 //
 //     Caller = 'today' from Proshop_sheet to process charges for today
 //              'old' from Proshop_oldsheets to process previous days' charges
 //
 // ********************************************************************************************

 public static void promptPOS2(String caller, HttpServletRequest req, HttpServletResponse resp, PrintWriter out, HttpSession session, Connection con)
         throws ServletException, IOException {

    
   PreparedStatement pstmt = null;
   PreparedStatement pstmt2s = null;

   ResultSet rs = null;

   String override = "";
   String index = "";
   String sdate = "";
   String stime = "";
   String sfb = "";

   long date = 0;

   int hr = 0;
   int min = 0;
   int sec = 0;

   //
   //  get the club name from the session
   //
   String club = (String)session.getAttribute("club");      // get club name
   String user = (String)session.getAttribute("user");      // get proshop user
   
   
   //
   //  parm block to hold the course parameters
   //
   //parmCourse parmc = new parmCourse();

   //
   //  parm block to hold the POS parameters
   //
   parmPOS parmp = new parmPOS();

   //
   //  Get the golf course name requested
   //
   String course = req.getParameter("course");
   

   if (req.getParameter("index") != null) {
      
      index = req.getParameter("index");         // get the index value of the day selected (if from Proshop_sheet)
   }

   if (req.getParameter("date") != null) {
      
      sdate = req.getParameter("date");         // get date (if from Proshop_oldsheets)
      
      date = Long.parseLong(sdate);
   }

   if (req.getParameter("time") != null) {

      stime = req.getParameter("time");         // get time if provided (CSG)
   }

   if (req.getParameter("fb") != null) {

      sfb = req.getParameter("fb");            // get fb if provided (CSG)
   }


   try {
      //
      //  Get the POS System Parameters for this Club & Course
      //
      getClub.getPOS(con, parmp, course);

   }
   catch (Exception e1) {

      resp.setContentType("text/html");                   // normal html response

      out.println(SystemUtils.HeadTitle("Proshop - POS Prompt"));
      out.println("<BODY><CENTER><img src=\"/" +rev+ "/images/foretees.gif\"><BR>");
      out.println("<hr width=\"40%\">");
      out.println("<BR><H3>Database Access Error</H3>");
      out.println("<BR><BR>Error processing the POS Request");
      out.println("<BR><BR>Error: " + e1.getMessage());
      out.println("<BR><BR>");
      out.println("<form>");
      out.println("<input type=\"button\" style=\"text-decoration:underline; background:#8B8970\" Value=\"  Close  \" onClick='self.close()' alt=\"Close\">");
      out.println("</form>");
      out.println("</CENTER></BODY></HTML>");
      out.close();
      return;
   }

   //
   //  Check if first time here, or we should build the report
   //
   if (req.getParameter("POScontinue") == null) {

      //  First time here - prompt to continue

      resp.setContentType("text/html");                   // normal html response

      out.println(SystemUtils.HeadTitle("Proshop - POS Prompt"));
      out.println("<BODY><CENTER><img src=\"/" +rev+ "/images/foretees.gif\"><BR>");
      out.println("<hr width=\"40%\">");
      if (parmp.posType.equals( "PCS Group" )) {
         out.println("<BR><H3>Send Player Data Request</H3>");
         out.println("You have requested that all current Player Information be sent to the PCS system.<br><br>");
         out.println("Only players that have been 'Checked In' will be transferred.");
      } else {
         out.println("<BR><H3>Send POS Charges Request</H3>");
         out.println("You have requested that all current POS related charges be sent to the POS system.<br><br>");
         out.println("Only charges for players that have been 'Checked In' will be transferred.");
      }
      out.println("<BR><BR><strong>Please be patient</strong> as this could take several minutes.");
      out.println("<BR><BR>Would you like to proceed with this process?");
      out.println("<BR><BR>");
      out.println("<font size=\"2\">");

      if (parmp.posType.equals( "Jonas" )) {

         out.println("<a href=\"javascript:void(0)\" onClick=\"window.open ('/" +rev+ "/proshop_help_sheet_jonas.htm', 'newwindow', 'height=540, width=500, toolbar=no, menubar=no, scrollbars=auto, resizable=no, location=no directories=no, status=no')\">");
         out.println("Click Here For Instructions</a>");
         out.println("<BR><BR>");
      }

      if (parmp.posType.equals( "Abacus21" )) {

         out.println("<a href=\"javascript:void(0)\" onClick=\"window.open ('/" +rev+ "/proshop_help_sheet_abacus21.htm', 'newwindow', 'height=540, width=500, toolbar=no, menubar=no, scrollbars=auto, resizable=no, location=no directories=no, status=no')\">");
         out.println("Click Here For Instructions</a>");
         out.println("<BR><BR>");
      }

      if (parmp.posType.equals( "ClubSystems Group" )) {

         out.println("<a href=\"javascript:void(0)\" onClick=\"window.open ('/" +rev+ "/proshop_help_sheet_csg.htm', 'newwindow', 'height=540, width=560, toolbar=no, menubar=no, scrollbars=auto, resizable=no, location=no directories=no, status=no')\">");
         out.println("Click Here For Instructions</a>");
         out.println("<BR><BR>");
      }

      if (parmp.posType.equals( "TAI Club Management" )) {

         out.println("<a href=\"javascript:void(0)\" onClick=\"window.open ('/" +rev+ "/proshop_help_sheet_tai.htm', 'newwindow', 'height=540, width=560, toolbar=no, menubar=no, scrollbars=auto, resizable=no, location=no directories=no, status=no')\">");
         out.println("Click Here For Instructions</a>");
         out.println("<BR><BR>");
      }

      if (parmp.posType.equals( "IBS" )) {

         out.println("<a href=\"javascript:void(0)\" onClick=\"window.open ('/" +rev+ "/proshop_help_sheet_ibs.htm', 'newwindow', 'height=540, width=560, toolbar=no, menubar=no, scrollbars=auto, resizable=no, location=no directories=no, status=no')\">");
         out.println("Click Here For Instructions</a>");
         out.println("<BR><BR>");
      }

      if (parmp.posType.equals( "ClubSoft" )) {

         out.println("<a href=\"javascript:void(0)\" onClick=\"window.open ('/" +rev+ "/proshop_help_sheet_clubsoft.htm', 'newwindow', 'height=540, width=560, toolbar=no, menubar=no, scrollbars=auto, resizable=no, location=no directories=no, status=no')\">");
         out.println("Click Here For Instructions</a>");
         out.println("<BR><BR>");
      }


      if (caller.equals("today")) {
         
         out.println("<form method=\"post\" action=\"/" +rev+ "/servlet/Proshop_sheet\" id=frmPOS>");
         out.println("<input type=\"hidden\" name=\"print\" value=\"pos\">");
         out.println("<input type=\"hidden\" name=\"index\" value=\"" + index + "\">");    // used by Proshop_sheet
         
      } else {
         
         out.println("<form method=\"post\" action=\"/" +rev+ "/servlet/Proshop_oldsheets\" id=frmPOS>");
         out.println("<input type=\"hidden\" name=\"sendpos\" value=\"yes\">");
         out.println("<input type=\"hidden\" name=\"date\" value=\"" + date + "\">");      // used by Proshop_oldsheets
      }

      out.println("<b>NOTE:</b> If you send the charges, please wait until the transfer is complete before returning to the tee sheet.");
      out.println("<BR><BR>");

      out.println("<input type=\"hidden\" name=\"POScontinue\" value=\"yes\">");
      out.println("<input type=\"hidden\" name=\"course\" value=\"" + course + "\">");
      out.println("<input type=\"hidden\" name=\"time\" value=\"" + stime + "\">");
      out.println("<input type=\"hidden\" name=\"fb\" value=\"" + sfb + "\">");
      // out.println("<input type=\"hidden\" name=\"jump\" value=\"0\">");
      // out.println("<input type=\"button\" name=\"btnSubmit\" value=\"Yes - Continue\" name=\"return\" style=\"text-decoration:underline; background:#8B8970\" onclick=\"submitForm()\">");
      out.println("<input type=\"submit\" name=\"btnSubmit\" value=\"Yes - Continue\" name=\"return\" style=\"text-decoration:underline; background:#8B8970\">");
      out.println("</font><br><br>");

      out.println("<input type=\"button\" style=\"text-decoration:underline; background:#8B8970\" name=\"btnClose\" value=\"Return\" onclick=\"self.close()\" alt=\"Close\">");
      out.println("</form></CENTER></BODY></HTML>");
      out.close();
      return;
   }

   
   
   //
   //   User has requested that we process and send the charges.
   //
   //
   //  Check for the override parm - if user wants to override the busy warning
   //
   if (req.getParameter("override") != null) {

      override = req.getParameter("override");  
   }

   //
   //  Get today's date
   //
   Calendar cal = new GregorianCalendar();       // get todays date

   int year = cal.get(Calendar.YEAR);
   int month = cal.get(Calendar.MONTH) +1;
   int daynum = cal.get(Calendar.DAY_OF_MONTH);
   hr = cal.get(Calendar.HOUR_OF_DAY);           // 24 hr clock (0 - 23)
   min = cal.get(Calendar.MINUTE);
   sec = cal.get(Calendar.SECOND);

   long today_date = year * 10000;                     // create a date field of yyyymmdd
   today_date = today_date + (month * 100);
   today_date = today_date + daynum;                   // date = yyyymmdd

   if (date == 0) {

      date = today_date;       // if not from Proshop_oldsheets, then use today's date

   } else {                    // use the date passed from oldsheets

      year = (int)date / 10000;       
      month = (int)(date - (year * 10000)) / 100;
      daynum = (int)date - ((year * 10000) + (month * 100));                 
   }

   //
   //   Check if this action is already in-progress and active (prevent duplicate sends)
   //
   String prouser = "";
   int pos_progress_id = 0;
   int prog_date = (int)today_date;
   int start_time = 0;
   int end_time = (hr * 10000) + (min * 100) + sec;     // use current time for end time

   try {

      pstmt2s = con.prepareStatement (
         "SELECT pos_progress_id, start_time, user " +
         "FROM pos_progress WHERE date = ? AND in_progress = 1");  // send pos already in progress today?

      pstmt2s.clearParameters();       
      pstmt2s.setInt(1, prog_date);         
      rs = pstmt2s.executeQuery();      // execute the prepared stmt

      if (rs.next()) {

         pos_progress_id = rs.getInt("pos_progress_id");     
         start_time = rs.getInt("start_time");     
         prouser = rs.getString("user"); 
      }
      pstmt2s.close();

      if (start_time > 0) {    // if send already in progress

         //  Send in Progress - see if user selected the override option

         if (override.equals("yes")) {           // if override requested

            //   end the send that was in process
            pstmt = con.prepareStatement (
               "UPDATE pos_progress SET end_time = ?, in_progress = 0, override = 1 " +
               "WHERE pos_progress_id = ?");

            pstmt.clearParameters();          
            pstmt.setInt(1, end_time);
            pstmt.setInt(2, pos_progress_id);
            pstmt.executeUpdate();              // end the previous send and flag as over-ridden

            pstmt.close();

         } else {

            //  send already in progress - ask if user wants to override it

            hr = start_time / 10000;        // break down the start time for message
            min = (start_time - (hr * 10000)) / 100;
            sec = start_time - ((hr * 10000) + (min * 100));  

            start_time = SystemUtils.adjustTime(con, ((hr * 100) + min));   // adjust the time for time zone

            hr = start_time / 100;             // get adjusted hr & min
            min = start_time - (hr * 100);

            resp.setContentType("text/html");                   // normal html response

            out.println(SystemUtils.HeadTitle("Proshop - POS Prompt"));
            out.println("<BODY><CENTER><img src=\"/" +rev+ "/images/foretees.gif\"><BR>");
            out.println("<hr width=\"40%\">");
            out.println("<BR><H3>Send POS Charges Request</H3>");
            out.println("<BR><strong>WARNING:</strong> A POS transfer is already in progress!");
            out.println("<BR><BR>Last transfer began at " +hr+ ":" +SystemUtils.ensureDoubleDigit(min)+ ":" +SystemUtils.ensureDoubleDigit(sec));
            out.println("<BR>Initiated by: " +user);
            out.println("<BR><BR>Starting another transfer could result in duplicate charges.");
            out.println("<BR><BR>Are you sure you would like to start the process again?");
            out.println("<BR><BR>");
            out.println("<font size=\"2\">");

            if (caller.equals("today")) {

               out.println("<form method=\"post\" action=\"/" +rev+ "/servlet/Proshop_sheet\" id=frmPOS>");

            } else {

               out.println("<form method=\"post\" action=\"/" +rev+ "/servlet/Proshop_oldsheets\" id=frmPOS>");
            }

            out.println("<input type=\"hidden\" name=\"override\" value=\"yes\">");        // indicate an override request
            out.println("<input type=\"hidden\" name=\"POScontinue\" value=\"yes\">");
            out.println("<input type=\"hidden\" name=\"print\" value=\"pos\">");
            out.println("<input type=\"hidden\" name=\"index\" value=\"" + index + "\">");
            out.println("<input type=\"hidden\" name=\"course\" value=\"" + course + "\">");
            out.println("<input type=\"hidden\" name=\"time\" value=\"" + stime + "\">");
            out.println("<input type=\"hidden\" name=\"fb\" value=\"" + sfb + "\">");
            out.println("<input type=\"submit\" name=\"btnSubmit\" value=\"YES - Continue\" name=\"return\" style=\"text-decoration:underline; background:#8B8970\">");
            out.println("</font><br><br>");

            out.println("<input type=\"button\" style=\"text-decoration:underline; background:#8B8970\" name=\"btnClose\" value=\"Return to Tee Sheet\" onclick=\"self.close()\" alt=\"Close\">");
            out.println("</form></CENTER></BODY></HTML>");
            out.close();
            return;
         }
      }

      //  Start a new send process - track it

      start_time = (hr * 10000) + (min * 100) + sec;     // use current time for start time

      pstmt = con.prepareStatement("" +
              "INSERT INTO pos_progress " +
                  "(date, start_time, end_time, in_progress, override, user) " +
              "VALUES (?,?,0,1,0,?)");

      pstmt.clearParameters();
      pstmt.setInt(1, prog_date);
      pstmt.setInt(2, start_time);
      pstmt.setString(3, user);
      pstmt.executeUpdate();         // indicate Send is in Progress

   }
   catch (Exception e1) {

      String errorMsg1 = "Error in Proshop_sheet_pos.promptPOS2 (busy check): ";
      errorMsg1 = errorMsg1 + e1.getMessage();                                // build error msg
      SystemUtils.logError(errorMsg1);                                       // log it
   }


   //
   //  Check for any charges and send them to the POS 
   //
   sendCharges(caller, club, course, user, date, resp, out, con);

 }                   // end of promptPOS2


 
 // ********************************************************************************************
 //  Check for POS charges and send them to the POS
 //
 //     Caller = 'today' from Proshop_sheet to process charges for today
 //              'old' from Proshop_oldsheets to process previous days' charges
 //              'timer' from SystemUtils timer processing for custom 
 //
 // ********************************************************************************************

 public static void sendCharges(String caller, String club, String course, String user, long date, 
                                HttpServletResponse resp, PrintWriter out, Connection con) {


   Statement stmt = null;
   PreparedStatement pstmt = null;
   PreparedStatement pstmt2s = null;

   ResultSet rs = null;

   String player1 = "";
   String player2 = "";
   String player3 = "";
   String player4 = "";
   String player5 = "";
   String user1 = "";
   String user2 = "";
   String user3 = "";
   String user4 = "";
   String user5 = "";
   String p1cw = "";
   String p2cw = "";
   String p3cw = "";
   String p4cw = "";
   String p5cw = "";
   String userg1 = "";
   String userg2 = "";
   String userg3 = "";
   String userg4 = "";
   String userg5 = "";
   String mNum1 = "";
   String mNum2 = "";
   String mNum3 = "";
   String mNum4 = "";
   String mNum5 = "";
  
   String filename = "";
   String temp = "";
   String day = "";
   String ampm = "";

   int guest = 0;
   int p91 = 0;
   int p92 = 0;
   int p93 = 0;
   int p94 = 0;
   int p95 = 0;
   int show1 = 0;
   int show2 = 0;
   int show3 = 0;
   int show4 = 0;
   int show5 = 0;
   int pos1 = 0;
   int pos2 = 0;
   int pos3 = 0;
   int pos4 = 0;
   int pos5 = 0;
   int i = 0;
   //int p = 0;
   int ttid = 0;
   int fb = 0;
   int time = 0;
   int time2 = 0;
   int done = 0;
   int masterDone = 0;
   int singleDone = 0;

   long resnum = 0;
   long resnum2 = 0;
   long ttidnum = 0;
   long ttidnum2 = 0;

   double salestax = 0;
   double salestaxCurr = 0;
   
   boolean IBSerror = false;
   boolean JonasResnumOpt = false;

   //
   //  parm block to hold the club parameters
   //
   parmClub parm = new parmClub(0, con);

   //
   //  parm block to hold the POS parameters
   //
   parmPOS parmp = new parmPOS();

   try {
      //
      // Get the Guest Types from the club db
      //
      getClub.getParms(con, parm);        // get the club parms

      //
      //  Get the POS System Parameters for this Club & Course
      //
      getClub.getPOS(con, parmp, course);

   }
   catch (Exception e1) {
   }

   //
   //   Save club name in parmp
   //
   parmp.club = club;

   
      
   //
   //  See if club wants to use the Jonas resnum option to increment the resnum for each member  - chits
   //     
   //  NOTE:  This requires that the corresponding option be set in Jonas ('One Chit per Reservation Number' in 'Tee Time Reservations' options)
   //
  // if ((club.equals( "engineerscc" ) || club.equals( "metropoliscc" ) || club.equals( "sawgrass" )) && parmp.posType.equals( "Jonas" )) {   
   if (parmp.posType.equals( "Jonas" )) {   

      JonasResnumOpt = true;      // do this for ALL Jonas clubs 
   }


   //
   //  Break down the date provided
   //
   int year = (int)date / 10000;       
   int month = (int)(date - (year * 10000)) / 100;
   int daynum = (int)date - ((year * 10000) + (month * 100));   
      
   //
   //  Get the current time
   //
   Calendar cal = new GregorianCalendar();       // get current date/time
   int hr = cal.get(Calendar.HOUR_OF_DAY);       // 24 hr clock (0 - 23)
   int min = cal.get(Calendar.MINUTE);
   int sec = cal.get(Calendar.SECOND);


   if (parmp.posType.equals( "Abacus21" ) || parmp.posType.equals( "Jonas" ) || parmp.posType.equals( "TAI Club Management" ) ||
       parmp.posType.equals( "ClubSoft" )) {

      //
      //  Set the values for the Reservation Number and Tee Time Id fields (yymmddnn, where nn changes)
      //
      resnum2 = date - 20000000;                     // resnum = yymmdd
      resnum = resnum2 * 1000;                        // shift over for nnn (1 - 990)
      ttidnum = resnum;                             // ditto
      ttidnum2 = resnum;                            // ditto - save this portion

      resn++;                                       // get the next res #
      ttidn++;                                      // get the next tee time num

      if (resn > 990) {
         resn = 1;          // init
      }
      if (ttidn > 990) {
         ttidn = 1;          // init
      }

      resnum += resn;                               // create new res num
      ttidnum += ttidn;                             // create new tee time id num

      parmp.sdate = String.valueOf(date);           // save string value of date for file

      filen++;                                                     // get next unique id value
      if (filen > 999) {
         filen = 1;         // reset
      }

      //
      // establish an ASCII filename
      //
      if (club.equals( "medinahcc" ) && parmp.posType.equals( "Abacus21" )) {    // if Medinah and Abacus21

         filename = String.valueOf( resnum2 );           // yymmdd
         temp = String.valueOf( filen );                 // nnn

         if (course.endsWith( "1" )) {                    // file name based on course (No 1, No 2, or No 3)

            filename = "C1-" + filename + "-" + temp + ".ASC";  // C1-yymmdd-nnn.ASC (where nnn = sequential value)

         } else {

            if (course.endsWith( "2" )) {

               filename = "C2-" + filename + "-" + temp + ".ASC";  // C2-yymmdd-nnn.ASC (where nnn = sequential value)

            } else {

               filename = "C3-" + filename + "-" + temp + ".ASC";  // C3-yymmdd-nnn.ASC (where nnn = sequential value)
            }
         }

      } else {     // NOT Medinah & Abacus

         filename = String.valueOf( filen );

         if (parmp.posType.equals( "ClubSoft" )) {

        //    filename = "ForeTees" + filename + ".CSV";         // name = ForeTeesnn.CSV
        //    filename = "ForeTees" + filename + ".ASC";         // changed for testing to fix a problem where leading zeros were stripped
            filename = "ForeTees" + filename + ".TXT";         // name = ForeTeesnn.TXT - changed per Club Soft's request

         } else {

            filename = "ForeTees" + filename + ".ASC";         // name = ForeTeesnn.ASC
         }
      }

      if (parmp.posType.equals( "TAI Club Management" ) || parmp.posType.equals( "ClubSoft" )) {

         if (daynum < 10) {

            parmp.sdate = String.valueOf(month) + "/0" + String.valueOf(daynum) + "/" + String.valueOf(year);  // date for file

         } else {

            parmp.sdate = String.valueOf(month) + "/" + String.valueOf(daynum) + "/" + String.valueOf(year);  // date for file
         }
      }


   } else if (parmp.posType.equals( "ClubSystems Group" )) {    // if CSG 

      parmp.count = 0;                 // init record counter

      parmp.sdate = String.valueOf((date-20000000));              // yymmdd

      //
      //  File name for new interface (AR Uload) is arupload.mas
      //
      filename = "arupload.mas";         // MUST use this name
      
      if (!caller.equals("timer")) {     // if not from custom timer (Olympic Club)

         //
         //  Set the output type to Text File - must do this now!!
         //
         // resp.setContentType("text/plain");                         // text file - this casues some browsers to add '.txt' to the end of the file name!!!!!!!!
         resp.setContentType("application/octet-stream");                   // bit stream - seems to work for all browsers tested (IE 6, 7, 8 & 9, Firefox, Safari)
         resp.setHeader("Content-Disposition", "attachment;filename=\"" +filename+ "\"");         // default file name
      }


   } else if (parmp.posType.equals( "IBS" )) {    // if IBS, all we need is the date

      parmp.count = 0;                 // init record counter

      parmp.sdate = String.valueOf(year + "-" + month + "-" + daynum);     // yyyy-mm-dd

   } else if (parmp.posType.equals( "PCS Group" )) {    // if PCS just set the filename

      //
      //  establish an ASCII filename       (foretees-yyyymmdd-hhmmss.csv)
      //
      String tempNS = "foretees-" + String.valueOf(year);

      if (month < 10) {

         tempNS += "0" + String.valueOf(month);
         
      } else {
         
         tempNS += String.valueOf(month);
      }

      if (daynum < 10) {

         tempNS += "0" + String.valueOf(daynum);
         
      } else {
         
         tempNS += String.valueOf(daynum);
      }

      if (hr < 10) {

         tempNS += "-0" + String.valueOf(hr);
         
      } else {
         
         tempNS += "-" + String.valueOf(hr);
      }

      if (min < 10) {

         tempNS += "0" + String.valueOf(min);
         
      } else {
         
         tempNS += String.valueOf(min);
      }

      if (sec < 10) {

         tempNS += "0" + String.valueOf(sec) + ".csv";
         
      } else {
         
         tempNS += String.valueOf(sec) + ".csv";
      }

      resp.setContentType("text/csv");                         // text file
      resp.setHeader("Content-Disposition", "attachment;filename=\"" +tempNS+ "\"");         // default file name


   } else {

      parmp.count = 0;                 // init record counter

      //
      //  build the header for the text file - mm/dd/yyyy hh:mm:ss
      //
      //  establish an ASCII filename       (clubname-mmddyyyy-hhmmss.txt)
      //
      String tempNS = String.valueOf(month);

      if (month < 10) {

         tempNS = "0" + String.valueOf(month);
      }

      //if (parmp.posType.equals( "IBS" )) {    // if IBS

      //   filename = "FT_" + tempNS;          // FT_mm

      //} else {

         filename = club + "-" + tempNS;          // clubname-mm
      //}

      parmp.sdate = tempNS + "/";              // mm/

      tempNS = String.valueOf(daynum);

      if (daynum < 10) {

         tempNS = "0" + String.valueOf(daynum);
      }

      filename = filename + tempNS + String.valueOf(year) + "-";                 // clubname-mmddyyyy-  OR FT_mmddyyyy-

      parmp.sdate = parmp.sdate + tempNS + "/" + String.valueOf(year);     // mm/dd/yyyy

      tempNS = String.valueOf(hr);

      if (hr < 10) {

         tempNS = "0" + String.valueOf(hr);
      }

      filename = filename + tempNS;                           // clubname-mmddyy-hh

      //if (!parmp.posType.equals( "IBS" )) {    // if NOT IBS

         parmp.sdate = parmp.sdate + " " + tempNS + ":";         // mm/dd/yyyy hh:
      //}

      tempNS = String.valueOf(min);

      if (min < 10) {

         tempNS = "0" + String.valueOf(min);
      }

      filename = filename + tempNS;                           // clubname-mmddyy-hhmm

      //if (!parmp.posType.equals( "IBS" )) {    // if NOT IBS

         parmp.sdate = parmp.sdate + tempNS + ":";               // mm/dd/yyyy hh:mm:
      //}

      tempNS = String.valueOf(sec);

      if (sec < 10) {

         tempNS = "0" + String.valueOf(sec);
      }

      filename = filename + tempNS;                      // clubname-mmddyy-hhmmss (".txt" to be added below)

      //if (parmp.posType.equals( "IBS" )) {    // if IBS

      //   filename = filename + ".asc";                   // IBS = FT_mmddyy-hhmmss.asc

      //} else {

         parmp.sdate = parmp.sdate + tempNS;                // mm/dd/yyyy hh:mm:ss
      //}

   }

   masterDone = 0;             // init master done flag

   //
   // create text file (one row per charge)
   //
   //  Get today's tee sheet and process the players one at a time.
   //
   try {

      String last_user = "";            // User assciated with the last charges sent
      String last_mNum = "";            // mNum associated with the last charge
      String sqlTable = "teecurr2";     // default to use teecurr2 (today)

      if (caller.equals("old")) {        // if called from Proshop_oldsheets

         sqlTable = "teepast2";       
      }       

      pstmt2s = con.prepareStatement (
         "SELECT * " +
         "FROM " +sqlTable+ " WHERE date = ? AND courseName = ? AND " +
         "((show1 = 1 AND pos1 = 0) OR (show2 = 1 AND pos2 = 0) OR (show3 = 1 AND pos3 = 0) OR (show4 = 1 AND pos4 = 0) OR (show5 = 1 AND pos5 = 0)) " +
         "ORDER BY time, fb");

      pstmt2s.clearParameters();        // clear the parms
      pstmt2s.setLong(1, date);
      pstmt2s.setString(2, course);


      rs = pstmt2s.executeQuery();      // execute the prepared stmt

      while (rs.next()) {

         ttid = rs.getInt("teecurr_id");       // get tid for CSG
         day = rs.getString("day");
         hr = rs.getInt("hr");
         min = rs.getInt("min");
         time = rs.getInt("time");
         player1 = rs.getString("player1");
         player2 = rs.getString("player2");
         player3 = rs.getString("player3");
         player4 = rs.getString("player4");
         user1 = rs.getString("username1");
         user2 = rs.getString("username2");
         user3 = rs.getString("username3");
         user4 = rs.getString("username4");
         p1cw = rs.getString("p1cw");
         p2cw = rs.getString("p2cw");
         p3cw = rs.getString("p3cw");
         p4cw = rs.getString("p4cw");
         show1 = rs.getInt("show1");
         show2 = rs.getInt("show2");
         show3 = rs.getInt("show3");
         show4 = rs.getInt("show4");
         fb = rs.getInt("fb");
         player5 = rs.getString("player5");
         user5 = rs.getString("username5");
         p5cw = rs.getString("p5cw");
         show5 = rs.getInt("show5");
         userg1 = rs.getString("userg1");
         userg2 = rs.getString("userg2");
         userg3 = rs.getString("userg3");
         userg4 = rs.getString("userg4");
         userg5 = rs.getString("userg5");
         mNum1 = rs.getString("mNum1");
         mNum2 = rs.getString("mNum2");
         mNum3 = rs.getString("mNum3");
         mNum4 = rs.getString("mNum4");
         mNum5 = rs.getString("mNum5");
         p91 = rs.getInt("p91");
         p92 = rs.getInt("p92");
         p93 = rs.getInt("p93");
         p94 = rs.getInt("p94");
         p95 = rs.getInt("p95");
         pos1 = rs.getInt("pos1");
         pos2 = rs.getInt("pos2");
         pos3 = rs.getInt("pos3");
         pos4 = rs.getInt("pos4");
         pos5 = rs.getInt("pos5");

         done = 0;            // init done some flag for this tee time
         singleDone = 0;      // init single tee time done flag

         parmp.day = day;       // save tee time values in parmp
         parmp.time = time;
         parmp.date = date;
         parmp.course = course;
         parmp.hist_fb = fb;

         parmp.charges.clear();

         last_user = "";         // init player position users
         last_mNum = "";

         if (parmp.posType.equals( "Abacus21" ) || parmp.posType.equals( "Jonas" )) {

            //
            //  Determine the time and save string for charge records
            //
            StringBuffer tempSB = null;
            time2 = time;                    // save time

            if (time2 > 1159) {               // if PM

               if (time2 > 1259) {            // if 1 PM or later

                  time2 = time2 - 1200;
               }

               parmp.stime = String.valueOf( time2 );      // convert time to string value
               tempSB = new StringBuffer(parmp.stime);     // put in string buffer
               tempSB.append(",P,");                       // indicate PM

            } else {

               parmp.stime = String.valueOf( time2 );      // convert time to string value
               tempSB = new StringBuffer(parmp.stime);     // put in string buffer
               tempSB.append(",A,");                       // indicate AM
            }
            parmp.stime = tempSB.toString();               // save as string value

            //
            //  Set the output type to Text File - must do this now!!
            //
            resp.setContentType("text/csv");                         // text file
            resp.setHeader("Content-Disposition", "attachment;filename=\"" +filename+ "\"");         // default file name
         }

         if (parmp.posType.equals( "TAI Club Management" ) || parmp.posType.equals( "IBS" ) || parmp.posType.equals( "ClubSoft" )) {

            if (min < 10) {

               parmp.stime = String.valueOf(hr) + ":0" + String.valueOf(min);  // tee time for file

            } else {

               parmp.stime = String.valueOf(hr) + ":" + String.valueOf(min);  // tee time for file
            }

            if (!parmp.posType.equals( "IBS" )) {       // no file for IBS

               //
               //  Set the output type to Text File - must do this now!!
               //
               resp.setContentType("text/csv");                         // text file
               resp.setHeader("Content-Disposition", "attachment;filename=\"" +filename+ "\"");         // default file name
            }
         }


         //
         //  Process one player at a time to determine any charges
         //
         if (!player1.equalsIgnoreCase( "x" ) && !player1.equals( "" ) && show1 == 1) {

            //
            //  Check if player name is member or guest
            //
            i = 0;
            guest = 0;

            if (user1.equals( "" )) {            // if no username for this player

               ploop1:
               while (i < parm.MAX_Guests) {
                  if (player1.startsWith( parm.guest[i] )) {

                     guest = 1;       // indicate player1 is a guest name
                     break ploop1;
                  }
                  i++;
               }
            }
            parmp.pcw = p1cw;
            parmp.p9 = p91;

            if (guest == 0) {        // if member

               if (!user1.equals( "" ) && pos1 == 0) {      // skip if no user name found or already processed

                  parmp.player = "";           // indicate member
                  parmp.user = user1;

                  if (parmp.posType.equals( "Abacus21" ) || parmp.posType.equals( "Jonas" )) {

                     done = buildJonas(parmp, out, con, resnum, ttidnum, club);
                  }

                  if (parmp.posType.equals( "TAI Club Management" )) {

                     done = buildTAI(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "IBS" )) {

                     done = buildIBS(parmp, out, con, club);                        
                  }

                  if (parmp.posType.equals( "ClubSoft" )) {

                     done = buildClubSoft(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     done = buildCSG(parmp, out, con, club, ttid, caller);
                  }

                  if (parmp.posType.equals( "NorthStar" )) {

                     done = buildLineNS(parmp, filename, out, con);      // add charges to file, if any
                  }

                  if (parmp.posType.equals( "PCS Group" )) {

                     done = buildPCS(parmp, out, con, club);
                  }

                  if (done == 1) {        // if 'done some' returned
                     pos1 = 3;            // set as processed and sent
                     singleDone = 1;      // set single tee time done flag
                     masterDone = 1;      // set master done flag
                     last_user = user1;              // user to get charged
                     last_mNum = mNum1;

                     ttidnum = ttidnum2 + ttidn;    // create new tee time id num

                  } else {

                     pos1 = 1;            // set as processed, not sent
                  }
               }

            } else {          // else guest

               if (!userg1.equals( "" ) && pos1 == 0) {      // skip if no member associated with this guest

                  parmp.player = player1;       // indicate guest - pass the guest type
                  parmp.user = userg1;

                  if (parmp.posType.equals( "Abacus21" ) || parmp.posType.equals( "Jonas" )) {

                     done = buildJonas(parmp, out, con, resnum, ttidnum, club);
                  }

                  if (parmp.posType.equals( "TAI Club Management" )) {

                     done = buildTAI(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "IBS" )) {

                     done = buildIBS(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSoft" )) {

                     done = buildClubSoft(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     done = buildCSG(parmp, out, con, club, ttid, caller);
                  }

                  if (parmp.posType.equals( "NorthStar" )) {

                     done = buildLineNS(parmp, filename, out, con);      // add charges to file, if any
                  }

                  if (parmp.posType.equals( "PCS Group" )) {

                     done = buildPCS(parmp, out, con, club);
                  }

                  if (done == 1) {        // if 'done some' returned
                     pos1 = 3;            // set as processed and sent
                     singleDone = 1;      // set single tee time done flag
                     masterDone = 1;      // set master done flag
                     last_user = userg1;              // user to get charged

                     ttidnum = ttidnum2 + ttidn;    // create new tee time id num

                  } else {

                     pos1 = 1;            // set as processed, not sent
                  }
               }
            }   // end of IF member or guest
         }      // end of IF player not X and not null


         if (!player2.equalsIgnoreCase( "x" ) && !player2.equals( "" ) && show2 == 1) {

            //
            //  Check if player name is member or guest
            //
            i = 0;
            guest = 0;

            if (user2.equals( "" )) {            // if no username for this player

               ploop2:
               while (i < parm.MAX_Guests) {
                  if (player2.startsWith( parm.guest[i] )) {

                     guest = 1;       // indicate player2 is a guest name
                     break ploop2;
                  }
                  i++;
               }
            }
            parmp.pcw = p2cw;
            parmp.p9 = p92;

            if (guest == 0) {        // if member

               if (!user2.equals( "" ) && pos2 == 0) {      // skip if no user name found

                  parmp.player = "";            // indicate member
                  parmp.user = user2;

                  if (parmp.posType.equals( "Abacus21" ) || parmp.posType.equals( "Jonas" )) {

                     if (JonasResnumOpt == true && !mNum2.equals(last_mNum)) {   

                        resnum++;                 // new member to be charged - increment the resnum to start new chit
                        resn++;                   //    NOTE: this is used in conjunction with the "Combine Charges" option in Jonas

                        if (resn > 990) {         // don't let resn get too big

                           resn = 1;              // start over
                        }
                     }

                     done = buildJonas(parmp, out, con, resnum, ttidnum, club);
                  }

                  if (parmp.posType.equals( "TAI Club Management" )) {

                     done = buildTAI(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "IBS" )) {

                     done = buildIBS(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSoft" )) {

                     done = buildClubSoft(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     done = buildCSG(parmp, out, con, club, ttid, caller);
                  }

                  if (parmp.posType.equals( "NorthStar" )) {

                     done = buildLineNS(parmp, filename, out, con);      // add charges to file, if any
                  }

                  if (parmp.posType.equals( "PCS Group" )) {

                     done = buildPCS(parmp, out, con, club);
                  }

                  if (done == 1) {        // if 'done some' returned
                     pos2 = 3;            // set as processed and sent
                     singleDone = 1;      // set single tee time done flag
                     masterDone = 1;      // set master done flag
                     last_user = user2;              // user to get charged
                     last_mNum = mNum2;

                     ttidnum = ttidnum2 + ttidn;    // create new tee time id num

                  } else {

                     pos2 = 1;            // set as processed, not sent
                  }
               }

            } else {          // else guest

               if (!userg2.equals( "" ) && pos2 == 0) {      // skip if no member associated with this guest

                  parmp.player = player2;   // indicate guest - pass the guest type
                  parmp.user = userg2;

                  if (parmp.posType.equals( "Abacus21" ) || parmp.posType.equals( "Jonas" )) {

                     if (JonasResnumOpt == true && !userg2.equals(last_user)) {   

                        resnum++;                 // new member to be charged - increment the resnum to start new chit
                        resn++;                   //    NOTE: this is used in conjunction with the "Combine Charges" option in Jonas

                        if (resn > 990) {         // don't let resn get too big

                           resn = 1;              // start over
                        }
                     }

                     done = buildJonas(parmp, out, con, resnum, ttidnum, club);
                  }

                  if (parmp.posType.equals( "TAI Club Management" )) {

                     done = buildTAI(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "IBS" )) {

                     done = buildIBS(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSoft" )) {

                     done = buildClubSoft(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     done = buildCSG(parmp, out, con, club, ttid, caller);
                  }

                  if (parmp.posType.equals( "NorthStar" )) {

                     done = buildLineNS(parmp, filename, out, con);      // add charges to file, if any
                  }

                  if (parmp.posType.equals( "PCS Group" )) {

                     done = buildPCS(parmp, out, con, club);
                  }

                  if (done == 1) {        // if 'done some' returned
                     pos2 = 3;            // set as processed and sent
                     singleDone = 1;      // set single tee time done flag
                     masterDone = 1;      // set master done flag
                     last_user = userg2;              // user to get charged

                     ttidnum = ttidnum2 + ttidn;    // create new tee time id num

                  } else {

                     pos2 = 1;            // set as processed, not sent
                  }
               }
            }   // end of IF member or guest
         }      // end of IF player not X and not null


         if (!player3.equalsIgnoreCase( "x" ) && !player3.equals( "" ) && show3 == 1) {

            //
            //  Check if player name is member or guest
            //
            i = 0;
            guest = 0;

            if (user3.equals( "" )) {            // if no username for this player

               ploop3:
               while (i < parm.MAX_Guests) {
                  if (player3.startsWith( parm.guest[i] )) {

                     guest = 1;       // indicate player3 is a guest name
                     break ploop3;
                  }
                  i++;
               }
            }
            parmp.pcw = p3cw;
            parmp.p9 = p93;

            if (guest == 0) {        // if member

               if (!user3.equals( "" ) && pos3 == 0) {      // skip if no user name found

                  parmp.player = "";   // indicate member
                  parmp.user = user3;

                  if (parmp.posType.equals( "Abacus21" ) || parmp.posType.equals( "Jonas" )) {

                     if (JonasResnumOpt == true && !mNum3.equals(last_mNum)) {   

                        resnum++;                 // new member to be charged - increment the resnum to start new chit
                        resn++;                   //    NOTE: this is used in conjunction with the "Combine Charges" option in Jonas

                        if (resn > 990) {         // don't let resn get too big

                           resn = 1;              // start over
                        }
                     }

                     done = buildJonas(parmp, out, con, resnum, ttidnum, club);
                  }

                  if (parmp.posType.equals( "TAI Club Management" )) {

                     done = buildTAI(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "IBS" )) {

                     done = buildIBS(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSoft" )) {

                     done = buildClubSoft(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     done = buildCSG(parmp, out, con, club, ttid, caller);
                  }

                  if (parmp.posType.equals( "NorthStar" )) {

                     done = buildLineNS(parmp, filename, out, con);      // add charges to file, if any
                  }

                  if (parmp.posType.equals( "PCS Group" )) {

                     done = buildPCS(parmp, out, con, club);
                  }

                  if (done == 1) {        // if 'done some' returned
                     pos3 = 3;            // set as processed and sent
                     singleDone = 1;      // set single tee time done flag
                     masterDone = 1;      // set master done flag
                     last_user = user3;              // user to get charged
                     last_mNum = mNum3;

                     ttidnum = ttidnum2 + ttidn;    // create new tee time id num

                  } else {

                     pos3 = 1;            // set as processed, not sent
                  }
               }

            } else {          // else guest

               if (!userg3.equals( "" ) && pos3 == 0) {      // skip if no member associated with this guest

                  parmp.player = player3;   // indicate guest - pass the guest type
                  parmp.user = userg3;

                  if (parmp.posType.equals( "Abacus21" ) || parmp.posType.equals( "Jonas" )) {

                     if (JonasResnumOpt == true && !userg3.equals(last_user)) {   

                        resnum++;                 // new member to be charged - increment the resnum to start new chit
                        resn++;                   //    NOTE: this is used in conjunction with the "Combine Charges" option in Jonas

                        if (resn > 990) {         // don't let resn get too big

                           resn = 1;              // start over
                        }
                     }

                     done = buildJonas(parmp, out, con, resnum, ttidnum, club);
                  }

                  if (parmp.posType.equals( "TAI Club Management" )) {

                     done = buildTAI(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "IBS" )) {

                     done = buildIBS(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSoft" )) {

                     done = buildClubSoft(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     done = buildCSG(parmp, out, con, club, ttid, caller);
                  }

                  if (parmp.posType.equals( "NorthStar" )) {

                     done = buildLineNS(parmp, filename, out, con);      // add charges to file, if any
                  }

                  if (parmp.posType.equals( "PCS Group" )) {

                     done = buildPCS(parmp, out, con, club);
                  }

                  if (done == 1) {        // if 'done some' returned
                     pos3 = 3;            // set as processed and sent
                     singleDone = 1;      // set single tee time done flag
                     masterDone = 1;      // set master done flag
                     last_user = userg3;              // user to get charged                     

                     ttidnum = ttidnum2 + ttidn;    // create new tee time id num

                  } else {

                     pos3 = 1;            // set as processed, not sent
                  }
               }
            }   // end of IF member or guest
         }      // end of IF player not X and not null


         if (!player4.equalsIgnoreCase( "x" ) && !player4.equals( "" ) && show4 == 1) {

            //
            //  Check if player name is member or guest
            //
            i = 0;
            guest = 0;

            if (user4.equals( "" )) {            // if no username for this player

               ploop4:
               while (i < parm.MAX_Guests) {
                  if (player4.startsWith( parm.guest[i] )) {

                     guest = 1;       // indicate player4 is a guest name
                     break ploop4;
                  }
                  i++;
               }
            }
            parmp.pcw = p4cw;
            parmp.p9 = p94;

            if (guest == 0) {        // if member

               if (!user4.equals( "" ) && pos4 == 0) {      // skip if no user name found

                  parmp.player = "";   // indicate member
                  parmp.user = user4;

                  if (parmp.posType.equals( "Abacus21" ) || parmp.posType.equals( "Jonas" )) {

                     if (JonasResnumOpt == true && !mNum4.equals(last_mNum)) {   

                        resnum++;                 // new member to be charged - increment the resnum to start new chit
                        resn++;                   //    NOTE: this is used in conjunction with the "Combine Charges" option in Jonas

                        if (resn > 990) {         // don't let resn get too big

                           resn = 1;              // start over
                        }
                     }

                     done = buildJonas(parmp, out, con, resnum, ttidnum, club);
                  }

                  if (parmp.posType.equals( "TAI Club Management" )) {

                     done = buildTAI(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "IBS" )) {

                     done = buildIBS(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSoft" )) {

                     done = buildClubSoft(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     done = buildCSG(parmp, out, con, club, ttid, caller);
                  }

                  if (parmp.posType.equals( "NorthStar" )) {

                     done = buildLineNS(parmp, filename, out, con);      // add charges to file, if any
                  }

                  if (parmp.posType.equals( "PCS Group" )) {

                     done = buildPCS(parmp, out, con, club);
                  }

                  if (done == 1) {        // if 'done some' returned
                     pos4 = 3;            // set as processed and sent
                     singleDone = 1;      // set single tee time done flag
                     masterDone = 1;      // set master done flag
                     last_user = user4;              // user to get charged
                     last_mNum = mNum4;

                     ttidnum = ttidnum2 + ttidn;    // create new tee time id num

                  } else {

                     pos4 = 1;            // set as processed, not sent
                  }
               }

            } else {          // else guest

               if (!userg4.equals( "" ) && pos4 == 0) {      // skip if no member associated with this guest

                  parmp.player = player4;   // indicate guest - pass the guest type
                  parmp.user = userg4;

                  if (parmp.posType.equals( "Abacus21" ) || parmp.posType.equals( "Jonas" )) {

                     if (JonasResnumOpt == true && !userg4.equals(last_user)) {   

                        resnum++;                 // new member to be charged - increment the resnum to start new chit
                        resn++;                   //    NOTE: this is used in conjunction with the "Combine Charges" option in Jonas

                        if (resn > 990) {         // don't let resn get too big

                           resn = 1;              // start over
                        }
                     }

                     done = buildJonas(parmp, out, con, resnum, ttidnum, club);
                  }

                  if (parmp.posType.equals( "TAI Club Management" )) {

                     done = buildTAI(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "IBS" )) {

                     done = buildIBS(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSoft" )) {

                     done = buildClubSoft(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     done = buildCSG(parmp, out, con, club, ttid, caller);
                  }

                  if (parmp.posType.equals( "NorthStar" )) {

                     done = buildLineNS(parmp, filename, out, con);      // add charges to file, if any
                  }

                  if (parmp.posType.equals( "PCS Group" )) {

                     done = buildPCS(parmp, out, con, club);
                  }

                  if (done == 1) {        // if 'done some' returned
                     pos4 = 3;            // set as processed and sent
                     singleDone = 1;      // set single tee time done flag
                     masterDone = 1;      // set master done flag
                     last_user = userg4;              // user to get charged

                     ttidnum = ttidnum2 + ttidn;    // create new tee time id num

                  } else {

                     pos4 = 1;            // set as processed, not sent
                  }
               }
            }   // end of IF member or guest
         }      // end of IF player not X and not null


         if (!player5.equalsIgnoreCase( "x" ) && !player5.equals( "" ) && show5 == 1) {

            //
            //  Check if player name is member or guest
            //
            i = 0;
            guest = 0;

            if (user5.equals( "" )) {            // if no username for this player

               ploop5:
               while (i < parm.MAX_Guests) {
                  if (player5.startsWith( parm.guest[i] )) {

                     guest = 1;       // indicate player5 is a guest name
                     break ploop5;
                  }
                  i++;
               }
            }
            parmp.pcw = p5cw;
            parmp.p9 = p95;

            if (guest == 0) {        // if member

               if (!user5.equals( "" ) && pos5 == 0) {      // skip if no user name found

                  parmp.player = "";   // indicate member
                  parmp.user = user5;

                  if (parmp.posType.equals( "Abacus21" ) || parmp.posType.equals( "Jonas" )) {

                     if (JonasResnumOpt == true && !mNum5.equals(last_mNum)) {   

                        resnum++;                 // new member to be charged - increment the resnum to start new chit
                        resn++;                   //    NOTE: this is used in conjunction with the "Combine Charges" option in Jonas

                        if (resn > 990) {         // don't let resn get too big

                           resn = 1;              // start over
                        }
                     }

                     done = buildJonas(parmp, out, con, resnum, ttidnum, club);
                  }

                  if (parmp.posType.equals( "TAI Club Management" )) {

                     done = buildTAI(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "IBS" )) {

                     done = buildIBS(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSoft" )) {

                     done = buildClubSoft(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     done = buildCSG(parmp, out, con, club, ttid, caller);
                  }

                  if (parmp.posType.equals( "NorthStar" )) {

                     done = buildLineNS(parmp, filename, out, con);      // add charges to file, if any
                  }

                  if (parmp.posType.equals( "PCS Group" )) {

                     done = buildPCS(parmp, out, con, club);
                  }

                  if (done == 1) {        // if 'done some' returned
                     pos5 = 3;            // set as processed and sent
                     singleDone = 1;      // set single tee time done flag
                     masterDone = 1;      // set master done flag
                     last_user = user5;              // user to get charged
                     last_mNum = mNum5;

                     ttidnum = ttidnum2 + ttidn;    // create new tee time id num

                  } else {

                     pos5 = 1;            // set as processed, not sent
                  }
               }

            } else {          // else guest

               if (!userg5.equals( "" ) && pos5 == 0) {      // skip if no member associated with this guest

                  parmp.player = player5;   // indicate guest - pass the guest type
                  parmp.user = userg5;

                  if (parmp.posType.equals( "Abacus21" ) || parmp.posType.equals( "Jonas" )) {

                     if (JonasResnumOpt == true && !userg5.equals(last_user)) {   

                        resnum++;                 // new member to be charged - increment the resnum to start new chit
                        resn++;                   //    NOTE: this is used in conjunction with the "Combine Charges" option in Jonas

                        if (resn > 990) {         // don't let resn get too big

                           resn = 1;              // start over
                        }
                     }

                     done = buildJonas(parmp, out, con, resnum, ttidnum, club);
                  }

                  if (parmp.posType.equals( "TAI Club Management" )) {

                     done = buildTAI(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "IBS" )) {

                     done = buildIBS(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSoft" )) {

                     done = buildClubSoft(parmp, out, con, club);
                  }

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     done = buildCSG(parmp, out, con, club, ttid, caller);
                  }

                  if (parmp.posType.equals( "NorthStar" )) {

                     done = buildLineNS(parmp, filename, out, con);      // add charges to file, if any
                  }

                  if (parmp.posType.equals( "PCS Group" )) {

                     done = buildPCS(parmp, out, con, club);
                  }

                  if (done == 1) {        // if 'done some' returned
                     pos5 = 3;            // set as processed and sent
                     singleDone = 1;      // set single tee time done flag
                     masterDone = 1;      // set master done flag
                     last_user = userg5;              // user to get charged

                     ttidnum = ttidnum2 + ttidn;    // create new tee time id num

                  } else {

                     pos5 = 1;            // set as processed, not sent
                  }
               }
            }   // end of IF member or guest
         }      // end of IF player not X and not null

         //
         //  Now set this tee time as processed (if we did)
         //
         if (singleDone == 1) {          // if we did any in this tee time

            PreparedStatement pstmt3 = con.prepareStatement (
                "UPDATE " +sqlTable+ " SET pos1 = ?, pos2 = ?, pos3 = ?, pos4 = ?, pos5 = ? " +
                "WHERE date = ? AND time = ? AND fb = ? AND courseName = ?");

            //
            //  execute the prepared statement to update the tee time slot
            //
            pstmt3.clearParameters();        // clear the parms
            pstmt3.setInt(1, pos1);
            pstmt3.setInt(2, pos2);
            pstmt3.setInt(3, pos3);
            pstmt3.setInt(4, pos4);
            pstmt3.setInt(5, pos5);

            pstmt3.setLong(6, date);
            pstmt3.setInt(7, time);
            pstmt3.setInt(8, fb);
            pstmt3.setString(9, course);
            pstmt3.executeUpdate();

            pstmt3.close();

            //
            //  If POS uses Reservation Numbers (identifies each tee time)
            //
            //if (parmp.posType.equals( "Abacus21" ) || parmp.posType.equals( "Jonas" ) || parmp.posType.equals( "TAI Club Management" )) {
            //if (club.equals("altolakes") || club.equals("pattersonclub")) {
            //
            //  5/29/08 - NOT SURE why this was ever changed for Jonas, but some clubs want us to change the res num for each tee time.
            //            This is necessary to use the "Quick Check-In" feture in Jonas POS - see P. 20 of their user doc.
            //            We may need to change this to not update resnum for any club that complains.
            //
            if (parmp.posType.equals( "Jonas" )) {

               //
               //  Increment Reservation Number for next Tee Time
               //
               resnum++;             // res num for records in file (this can keep incrementing)
               resn++;

               if (resn > 990) {         // don't let resn get too big

                  resn = 1;              // start over
               }

            } else if (parmp.posType.equals( "IBS" )) {

               //
               //  IBS - send the charges after each tee time - process the responses when all done
               //
               IBSerror = Proshop_sheet_checkin.sendChargeIBS(parmp, con);
            }

         }

      }     // end of WHILE loop of teecurr2 data

      pstmt2s.close();

   }
   catch (Exception e1) {

      String errorMsg1 = "Error1 in Proshop_sheet_pos.sendCharges: ";
      errorMsg1 = errorMsg1 + e1.getMessage();                                // build error msg

      SystemUtils.logError(errorMsg1);                                       // log it
   }

   
   if (caller.equals("timer")) {      // if initiated by the custom timer (SystemUtils) 
      
      if (masterDone == 1 && parmp.posType.equals( "NorthStar" )) {   // if we built any records and its NorthStar

         //
         //  NorthStar - close out the file (add counter and footer)
         //
         String counts = String.valueOf( parmp.count );     // create string value from count

         addLineNS(filename, counts);                       // put in file

         addLineNS(filename, "EOF");                        // add End Of File indicator (footer)
      }
      
   } else {    // NOT timer call - normal Send POS from tee sheet
      
      //
      //  Get current time (must get here to get an accurate time value)
      //
      cal = new GregorianCalendar();       // get todays date
      year = cal.get(Calendar.YEAR);
      month = cal.get(Calendar.MONTH) +1;
      daynum = cal.get(Calendar.DAY_OF_MONTH);
      hr = cal.get(Calendar.HOUR_OF_DAY);           // 24 hr clock (0 - 23)
      min = cal.get(Calendar.MINUTE);
      sec = cal.get(Calendar.SECOND);

      int today_date = (year * 10000) + (month * 100) + daynum;      // create a date field of yyyymmdd

      int end_time = (hr * 10000) + (min * 100) + sec;  

      try {

         //   end the send that was in process
         pstmt = con.prepareStatement (
            "UPDATE pos_progress SET end_time = ?, in_progress = 0 " +
            "WHERE date = ? AND in_progress = 1");

         pstmt.clearParameters();          
         pstmt.setInt(1, end_time);
         pstmt.setInt(2, today_date);
         pstmt.executeUpdate();           

         pstmt.close();

      }
      catch (Exception e2) {

         String errorMsg2 = "Error2 in Proshop_sheet_pos.promptPOS2 (end progress): ";
         errorMsg2 = errorMsg2 + e2.getMessage();                                // build error msg
         SystemUtils.logError(errorMsg2);                                       // log it
      }


      //
      // done with text file - check if we built any records
      //
      if (masterDone == 1) {   // if we built any records

         if (parmp.posType.equals( "NorthStar" )) {

            //
            //  NorthStar - close out the file (add counter and footer)
            //
            String counts = String.valueOf( parmp.count );     // create string value from count

            addLineNS(filename, counts);                       // put in file

            addLineNS(filename, "EOF");                        // add End Of File indicator (footer)

            resp.setContentType("text/html");                   // normal html response
            resp.setHeader("Content-Disposition", "inline");    // undo attachment change from above

            out.println(SystemUtils.HeadTitle("Proshop - POS Prompt"));
            out.println("<BODY><CENTER><img src=\"/" +rev+ "/images/foretees.gif\"><BR>");
            out.println("<hr width=\"40%\">");
            out.println("<BR><H3>POS Charges Sent</H3>");
            out.println("<br>The POS charges have been sent to the POS system.");
            out.println("<BR><BR>");
            out.println("<input type=\"button\" style=\"text-decoration:underline; background:#8B8970\" Value=\"  Return  \" onClick='self.close()' alt=\"Close\">");
            out.println("</CENTER></BODY></HTML>");

         } else if (parmp.posType.equals( "IBS" )) {

            //
            //  IBS - inform user the charges have been sent.  Display any errors received.
            //
            resp.setContentType("text/html");                   // normal html response
            resp.setHeader("Content-Disposition", "inline");    // undo attachment change from above

            out.println(SystemUtils.HeadTitle("Proshop - POS Prompt"));
            out.println("<BODY><CENTER><img src=\"/" +rev+ "/images/foretees.gif\"><BR>");
            out.println("<hr width=\"40%\">");
            out.println("<BR><H3>POS Charges Sent</H3>");
            out.println("<br>The POS charges have been sent to the POS system.");
            out.println("<BR><BR>");

            if (!parmp.returnCode1.equals("") && parmp.returnCode1 != null) {       // if any errors returned from IBS

               out.println("<strong>NOTICE:</strong> The following errors were received from the IBS System.");
               out.println("<BR>You may need to verify that the charges were properly processed in the IBS System.");
               out.println("<BR><BR>" +parmp.returnCode1);                     
            }
            out.println("<BR><BR>");            
            out.println("<input type=\"button\" style=\"text-decoration:underline; background:#8B8970\" Value=\"  Return  \" onClick='self.close()' alt=\"Close\">");
            out.println("</CENTER></BODY></HTML>");
         }

      } else {

         resp.setContentType("text/html");                   // normal html response
         resp.setHeader("Content-Disposition", "inline");    // undo attachment change from above

         out.println(SystemUtils.HeadTitle("Proshop - POS Prompt"));
         out.println("<BODY><CENTER><img src=\"/" +rev+ "/images/foretees.gif\"><BR>");
         out.println("<hr width=\"40%\">");

         if (parmp.posType.equals( "PCS Group" )) {

            out.println("<BR><H3>No Player Data To Send</H3>");
            out.println("<br>There are new players to send at this time.");
            
         } else {
            
            out.println("<BR><H3>No POS Charges To Send</H3>");
            out.println("<br>There are no new POS charges to send at this time.");
         }
         out.println("<BR><BR>");
         out.println("<input type=\"button\" style=\"text-decoration:underline; background:#8B8970\" Value=\"  Return  \" onClick='self.close()' alt=\"Close\">");
         out.println("</CENTER></BODY></HTML>");
      }

      out.close();              // close the file

      try {

         resp.flushBuffer();      // make sure the repsonse completes

      }
      catch (Exception ignore) {
      }
   }      // end of IF Not timer

 }                   // end of sendCharges


 // ********************************************************************
 //  Process the Abacus or Jonas POS charges for an individual member
 //
 //  Build an ASCII file containing the following:
 //
 //   Columns:
 //       1 Member Number or POSID                                Alpha 10
 //       2 Member? (Y/N)     (always 'Y')                        Alpha 1
 //       3 Number Of Guests                                      Alpha 3
 //       4 Last Name                                             Alpha 30
 //       5 First Name                                            Alpha 20
 //       6 Telephone Number   (skip)                             Alpha 15
 //       7 Tee off Date                                          Date YYYYMMDD
 //       8 Tee Off Time                                          Alpha HHMM
 //       9 AM / PM (A or P)                                      Alpha 1
 //       10 Course Code       ('A' if only 1 course)             Alpha 2
 //       11 Start Tee/Group Number    (skip)                     Alpha 3
 //       12 UNUSED (reserved for Deposit Amount)                 Numeric 0000.00
 //       13 Credit Card Type          (skip)                     Alpha 4
 //       14 Credit Card Number        (skip)                     Alpha 20
 //       15 Credit Card Expiry        (skip)                     Alpha YYYYMM
 //       16 Tee Time Sales Item                                  Alpha 6
 //       17 Units Sold                                           Numeric 0000
 //       18 Confirmation/Reservation Number                      Alpha 10
 //       19 UNUSED (Tee Time Sales Item Price) (skip)            Numeric 0000.00
 //       20 Tee-Time ID number                                   Alpha 10
 //       21 Green Fee Credit Card Authorization Code  (skip)     Alpha 9
 //       22 Credit Card Authorization Date            (skip)     Date YYYYMMDD
 //       23 Prepaid Indicator (Y-yes, N-no)           ('N')      Alpha 1
 //       24 Res. Fee Credit Card Authorization Code   (skip)     Alpha 9
 //       25 Reservation Fee Amount                    (skip)     Numeric ####.00
 //       26 Checked In Indicator (Y-yes, N-no)        ('Y')      Alpha 1
 //
 //    Check the mode of trans for charges
 // ********************************************************************

 private static int buildJonas(parmPOS parmp, PrintWriter out, Connection con, long resnum, long ttidnum, String club) {


   ResultSet rs = null;

   String mship = "";
   String mnum = "";
   String posid = "";
   String fname = "";
   String lname = "";
   String tpos = "";
   String mpos = "";
   String mposc = "";
   String gpos = "";
   String gtype = "";
   String tmode = "";
   String tmodea = "";
   String item = "";
   String line = "";
   String tcourse = "";        // temp course name for customs

   int i = 0;
   int p9c = 0;
   int done = 0;
   int daynum = (int)(parmp.date - ((parmp.date / 100) * 100));    // dd = yyyymmdd - yyyymm00


   try {
      //
      //  get the member's mship info
      //
      PreparedStatement pstmtc = con.prepareStatement (
         "SELECT name_last, name_first, m_ship, memNum, posid FROM member2b WHERE username= ?");

      pstmtc.clearParameters();        // clear the parms
      pstmtc.setString(1, parmp.user);

      rs = pstmtc.executeQuery();

      if (rs.next()) {

         lname = rs.getString(1);
         fname = rs.getString(2);
         mship = rs.getString(3);
         mnum = rs.getString(4);
         posid = rs.getString(5);
      }
      pstmtc.close();

   }
   catch (Exception e1) {

      String errorMsg1 = "Error1 in Proshop_sheet_pos.buildJonas for club: " + club;
      errorMsg1 = errorMsg1 + ", Exception: " + e1.getMessage();      // build error msg

      SystemUtils.logError(errorMsg1);                                       // log it
   }

   //
   //  if Lakewood CC - use the member posid instead of the mnum
   //
   if ((club.equals( "lakewood" ) || club.equals( "pinnaclepeak" ) || club.equals("engineerscc")) & !posid.equals( "" )) {

      mnum = posid;
   }

   //
   //  Skip if no mNum/posid - otherwise entire file will fail
   //
   if (!mnum.equals( "" )) {

      try {

         //*******************************************************************************************
         //  First check if there is a charge amount associated with this member's mode of trans
         //*******************************************************************************************
         //
         if (club.equals( "medinahcc" )) {      // if Medinah do manual item codes

            if (!parmp.player.startsWith( "Comp" ) && !parmp.player.startsWith( "PGA" ) &&
                !parmp.player.startsWith( "Country Club" ) && !parmp.player.startsWith( "Credit Card" )) {  // DO NOT charge these guest types

               if (parmp.pcw.equals( "4BG" )) {          // 4 Bagger

                  item = "20190";
               }

               if (parmp.pcw.equals( "CAR" )) {          // Half Cart

                  if (parmp.p9 == 1) {                   // if 9 holes
                     item = "20130";
                  } else {
                     item = "20110";
                  }
               }

               if (parmp.pcw.equals( "FCA" )) {          // Full Cart

                  if (parmp.p9 == 1) {                   // if 9 holes
                     item = "20120";
                  } else {
                     item = "20100";
                  }
               }

               if (parmp.pcw.equals( "2CA" )) {          //  Two Cart

                  item = "20000";
               }

               if (parmp.pcw.equals( "1.5" )) {         //  One & a half cart Cart

                  item = "20105";
               }

               if (parmp.pcw.equals( "PC" )) {          //  Pull Cart

                  item = "20140";
               }

            }

         } else {        // not Medinah

            i = 0;
            loop1:
            while (i < parmp.MAX_Tmodes) {

               if (parmp.tmodea[i].equals( parmp.pcw )) {     // if matching mode of trans found

                  tmode = parmp.tmode[i];             // get full description of tmode
                  if (parmp.p9 == 1) {                   // if 9 holes
                     item = parmp.t9pos[i];               // get Item Group # for tmode
                  } else {
                     item = parmp.tpos[i];               // get Item Group # for tmode
                  }
                  break loop1;
               }
               i++;
            }
         }

         //
         // If Long Cove and a certain Guest Type, then do not charge for mode of trans
         //
         if (club.equals( "longcove" )) {

            if (parmp.player.startsWith( "Comp A" ) || parmp.player.startsWith( "PGA" ) || parmp.player.startsWith( "Recip Guest" ) ||
                parmp.player.startsWith( "Employee" ) || parmp.player.startsWith( "Tournament Guest" )) {

               item = "";        // no charge
            }
         }


         //
         // If Virginia CC and a certain Guest Type, then do not charge for mode of trans
         //
         if (club.equals( "virginiacc" )) {

//            if (parmp.player.startsWith( "Employee" ) || parmp.player.startsWith( "Industry Comp" ) || parmp.player.startsWith( "Reciprocal" ) ||
//                parmp.player.startsWith( "Outing Guest" ) || parmp.player.startsWith( "Guest" ) || parmp.player.startsWith( "VCU" ) ||
//                parmp.player.startsWith( "U of R" ) || parmp.player.startsWith( "St Chris" ) || parmp.player.startsWith( "Collegiate" ) ||
//                parmp.player.startsWith( "St Catherines" ) || parmp.player.startsWith( "Assoc Guest" )) {

            if (parmp.player.startsWith( "Reciprocal" )) {

               item = "";        // no charge
            }
         }


         if (!item.equals( "" ) && !item.equals( "0" )) {   // if pos charge found for Mode of Trans selected

            //
            //  We can now build the charge string for Mode of Trans charge
            //
            StringBuffer tempSB = new StringBuffer(mnum);     // put member # in string buffer
            tempSB.append(",Y,1,");                           // indicator, # of guests (players?)
            tempSB.append(lname);                             // last name
            tempSB.append(",");
            tempSB.append(fname);                             // first name
            tempSB.append(",,");                              // skip phone #
            tempSB.append(parmp.sdate);                       // date of tee time
            tempSB.append(",");
            tempSB.append(parmp.stime);                       // time (includes A or P for AM or PM and ,)
            tempSB.append(parmp.courseid);                    // Course Code
            tempSB.append(",,,,,,");                          // skips
            tempSB.append(item);                              // Sales Item #
            tempSB.append(",1,");                             // units sold
            tempSB.append(resnum);                            // Reservation #
            tempSB.append(",,");                              // unused
            tempSB.append(ttidnum);                           // Tee Time Id #
            tempSB.append(",,,N,,,Y");                        // units sold, skips, Prepaid, Checked-in

            line = tempSB.toString();                         // save as string value

            out.print(line);
            out.println();      // output the line

            done = 1;           // indicate charge sent

            ttidn++;            // bump tee time id number
            ttidnum++;

            //
            //  Save charge data in pos_hist for reports
            //
            parmp.hist_posid = mnum;
            if (!parmp.player.equals( "" )) {
               parmp.hist_player = parmp.player;          // if guest
            } else {
               parmp.hist_player = fname + " " + lname;   // else use member name
            }
            parmp.hist_price = "";
            parmp.hist_item_name = parmp.pcw;
            parmp.hist_item_num = item;

            add_POS_hist(parmp, con);       // go make the entry
         }


         //
         //*******************************************************************************************
         //  get the mship class and charge amount, if any and if member!
         //*******************************************************************************************
         //
         i = 0;
         item = "";

         if (parmp.player.equals( "" )) {       // if member

            loop2:
            while (i < parmp.MAX_Mships) {

               if (parmp.mship[i].equalsIgnoreCase( mship )) {     // if matching mode mship type

                  if (parmp.p9 == 1) {                   // if 9 holes
                     item = parmp.mship9I[i];               // get mship item group #
                  } else {
                     item = parmp.mshipI[i];               // get mship item group #
                  }
                  break loop2;
               }
               i++;
            }

            if (!item.equals( "" ) && !item.equals( "0" )) {   // if pos charge found for membership (non-golf mship charge)

               //
               //  IF Congressional - check for custom codes based on Course
               //
               if (club.equals( "congressional" )) {

                  if (mship.equals( "Non Resident" )) {

                     tcourse = congressionalCustom.getFullCourseName(parmp.date, daynum, parmp.course);   // get course name for this date

                     item = "000G39";                     // item code for Blue course

                     if (tcourse.endsWith( "Gold" )) {

                        item = "000G40";                 // item code for Gold course
                     }
                  }
               }       // end of IF Congressional


               //
               //  IF St. Clair CC - check for custom codes based on Course
               //
               if (club.equals( "stclaircc" )) {

                  if (parmp.course.equals( "Championship" )) {

                      if (mship.equals( "Voting" ) || mship.equals( "Senior" ) || mship.equals( "Intermediate" ) ||
                              mship.equals( "Spouse Golf" ) || mship.equals( "Junior Golf" ) || mship.equals( "Assoc20" ) ||
                              mship.equals( "Assoc Spouse20" ) || mship.equals( "Assoc Jr20" ) || mship.equals( "Associate Golf" ) ||
                              mship.equals( "Associate Spouse" ) || mship.equals( "Associate Jr" )) {

                          item = "18MNON";

                          if (parmp.p9 == 1) {                   // if 9 holes

                              item = "09MNON";
                          }

                     } else if (mship.equals( "Limited Golf" ) || mship.equals( "Spouse Golf 9" )  || mship.equals( "NR Golf" ) ||
                                mship.equals( "Limited Spouse" ) || mship.equals( "Limited Jr" )) {

                         item = "18MPAR";

                         if (parmp.p9 == 1) {                   // if 9 holes

                             item = "09MPAR";
                         }

                     } else if (mship.equals("Social Golf") || mship.equals("Soc Golf Spouse") || mship.equals("Soc Jr Golf") ||
                                mship.equals("Emeritus")) {

                         item = "18MFUL";

                         if (parmp.p9 == 1) {

                             item = "09MFUL";
                         }

                     } else {                // Social or others

                          item = "";           // others entered as guest
                     }

                  } else {     // Terrace course - same for most mships


                     if (mship.equals("Emeritus")) {

                         item = "18TFUL";

                         if (parmp.p9 == 1) {                   // if 9 holes

                            item = "09TFUL";
                         }

                     } else {

                         item = "18TNON";

                         if (parmp.p9 == 1) {                   // if 9 holes

                            item = "09TNON";
                         }
                     }
                  }
               }       // end of IF St. Clair CC



               //
               //  If Royal Oaks Houston - process by mship and day
               //
               if (club.equals("royaloakscc")) {

                  if (mship.equals( "Golf" ) || mship.equals( "Sampler Golf" ) || mship.equals( "Preview Golf" )) {

                     if (parmp.day.equals( "Saturday" ) || parmp.day.equals( "Sunday" ) ||
                         parmp.date == Hdate1 || parmp.date == Hdate2 || parmp.date == Hdate3 ||
                         parmp.date == Hdate4 || parmp.date == Hdate5) {

                        item = "54GF03";

                        if (parmp.p9 == 1) {                   // if 9 holes

                           item = "54GF04";
                        }

                     } else {

                        if (parmp.day.equals( "Monday" ) || parmp.day.equals( "Tuesday" ) ||
                            parmp.day.equals( "Wednesday" ) || parmp.day.equals( "Thursday" )) {

                           item = "54GF21";

                           if (parmp.p9 == 1) {                   // if 9 holes

                              item = "54GF22";
                           }

                        } else {

                           if (parmp.time < 1200) {          // Friday - AM or PM?

                              item = "54GF23";

                              if (parmp.p9 == 1) {                   // if 9 holes

                                 item = "54GF24";
                              }

                           } else {

                              item = "54GF25";

                              if (parmp.p9 == 1) {                   // if 9 holes

                                 item = "54GF26";
                              }
                           }
                        }
                     }
                  }

                  if (mship.startsWith( "Executiv" ) || mship.endsWith( "Executive" )) {

                     if (parmp.day.equals( "Saturday" ) || parmp.day.equals( "Sunday" ) ||
                         parmp.date == Hdate1 || parmp.date == Hdate2 || parmp.date == Hdate3 ||
                         parmp.date == Hdate4 || parmp.date == Hdate5) {

                        item = "54GF07";

                        if (parmp.p9 == 1) {                   // if 9 holes

                           item = "54GF08";
                        }

                     } else {

                        if (parmp.day.equals( "Monday" ) || parmp.day.equals( "Tuesday" ) ||
                            parmp.day.equals( "Wednesday" ) || parmp.day.equals( "Thursday" )) {

                           item = "54GF11";

                           if (parmp.p9 == 1) {                   // if 9 holes

                              item = "54GF12";
                           }

                        } else {

                           if (parmp.time < 1200) {          // Friday - AM or PM?

                              item = "54GF13";

                              if (parmp.p9 == 1) {                   // if 9 holes

                                 item = "54GF14";
                              }

                           } else {

                              item = "54GF15";

                              if (parmp.p9 == 1) {                   // if 9 holes

                                 item = "54GF16";
                              }
                           }
                        }
                     }
                  }

                  if (mship.equals( "Honorary" )) {

                     if (parmp.day.equals( "Saturday" ) || parmp.day.equals( "Sunday" ) ||
                         parmp.date == Hdate1 || parmp.date == Hdate2 || parmp.date == Hdate3 ||
                         parmp.date == Hdate4 || parmp.date == Hdate5) {

                        item = "55GF03";

                        if (parmp.p9 == 1) {                   // if 9 holes

                           item = "55GF04";
                        }

                     } else {

                        if (parmp.day.equals( "Monday" ) || parmp.day.equals( "Tuesday" ) ||
                            parmp.day.equals( "Wednesday" ) || parmp.day.equals( "Thursday" )) {

                           item = "55GF10";

                           if (parmp.p9 == 1) {                   // if 9 holes

                              item = "55GF11";
                           }

                        } else {

                           if (parmp.time < 1200) {          // Friday - AM or PM?

                              item = "55GF12";

                              if (parmp.p9 == 1) {                   // if 9 holes

                                 item = "55GF13";
                              }

                           } else {

                              item = "55GF14";

                              if (parmp.p9 == 1) {                   // if 9 holes

                                 item = "55GF15";
                              }
                           }
                        }
                     }
                  }

                  if (mship.startsWith( "Sports Club" )) {

                     if (parmp.day.equals( "Monday" ) || parmp.day.equals( "Tuesday" ) ||
                         parmp.day.equals( "Wednesday" ) || parmp.day.equals( "Thursday" )) {

                        item = "54GF17";

                        if (parmp.p9 == 1) {                   // if 9 holes

                           item = "54GF18";
                        }

                     } else {

                        if (parmp.day.equals( "Friday" ) && parmp.time < 1200) {          // Friday - AM or PM?

                           item = "54GF19";

                           if (parmp.p9 == 1) {                   // if 9 holes

                              item = "54GF20";
                           }

                        } else {

                           item = "49GF03";
                        }
                     }
                  }
               }        // end of IF Royal Oaks CC



               if (!item.equals("")) {

                  //
                  //  We can now build the charge string
                  //
                  StringBuffer tempSB = new StringBuffer(mnum);     // put member # in string buffer
                  tempSB.append(",Y,1,");                           // indicator, # of guests (players?)
                  tempSB.append(lname);                             // last name
                  tempSB.append(",");
                  tempSB.append(fname);                             // first name
                  tempSB.append(",,");                              // skip phone #
                  tempSB.append(parmp.sdate);                       // date of tee time
                  tempSB.append(",");
                  tempSB.append(parmp.stime);                       // time (includes A or P for AM or PM and ,)
                  tempSB.append(parmp.courseid);                    // Course Code
                  tempSB.append(",,,,,,");                          // skips
                  tempSB.append(item);                              // Sales Item #
                  tempSB.append(",1,");                             // units sold
                  tempSB.append(resnum);                            // Reservation #
                  tempSB.append(",,");                              // unused
                  tempSB.append(ttidnum);                           // Tee Time Id #
                  tempSB.append(",,,N,,,Y");                        // units sold, skips, Prepaid, Checked-in

                  line = tempSB.toString();                         // save as string value

                  out.print(line);
                  out.println();      // output the line

                  done = 1;           // indicate charge sent

                  ttidn++;            // bump tee time id number
                  ttidnum++;

                  //
                  //  Save charge data in pos_hist for reports
                  //
                  parmp.hist_posid = mnum;
                  parmp.hist_player = fname + " " + lname;   // use member name
                  parmp.hist_price = "";
                  parmp.hist_item_name = "Green Fee";
                  parmp.hist_item_num = item;

                  add_POS_hist(parmp, con);       // go make the entry
               }

            }      // end of Mship Charge processing

         } else {


            //
            //*******************************************************************************************
            //  player passed is a GUEST - charge the member for this too
            //*******************************************************************************************
            //
            loop3:
            while (i < parmp.MAX_Guests) {

               if (parmp.player.startsWith( parmp.gtype[i] )) {

                  gtype = parmp.gtype[i];               // set guest type description
                  if (parmp.p9 == 1) {                   // if 9 holes
                     item = parmp.gst9I[i];                 // set guest item group #
                  } else {
                     item = parmp.gstI[i];                 // set guest item group #
                  }
                  break loop3;
               }
               i++;
            }

            //
            //  Custom item codes
            //
            if (club.equals( "medinahcc" )) {      // if Medinah do manual item codes

               if (parmp.course.equals( "No 1" )) {         // Course #1

                  if (parmp.player.startsWith( "Guest" )) {         // normal Guest

                     if (parmp.time > 1600) {

                        item = "120100";              // after 4 PM

                     } else {

                        if ((parmp.day.equals( "Saturday" ) || parmp.day.equals( "Sunday" ) ||
                            parmp.date == Hdate1 || parmp.date == Hdate2 || parmp.date == Hdate3) && parmp.time < 1100) {
//                            parmp.date == Hdate1 || parmp.date == Hdate2 || parmp.date == Hdate3) && parmp.time < 1200) {  // changed 6/05/07

                           item = "130100";           // S-S-H before noon

                        } else {

                           item = "110100";           // T-F and others
                        }
                     }
                  }

                  if (parmp.player.startsWith( "Unaccom" )) {       // Unaccompanied Guest

                     item = "140100";
                  }

                  if (parmp.player.startsWith( "Replay" )) {        // Replay Guest

                     item = "140400";
                  }
               }                             // end of course #1

               if (parmp.course.equals( "No 2" )) {         // Course #2

                  if (parmp.player.startsWith( "Guest" )) {         // normal Guest

                     if (parmp.time > 1600) {

                        item = "120200";              // after 4 PM

                     } else {

                        if ((parmp.day.equals( "Saturday" ) || parmp.day.equals( "Sunday" ) ||
                            parmp.date == Hdate1 || parmp.date == Hdate2 || parmp.date == Hdate3) && parmp.time < 1100) {
//                            parmp.date == Hdate1 || parmp.date == Hdate2 || parmp.date == Hdate3) && parmp.time < 1200) {  // changed 6/05/07

                           item = "130200";           // S-S-H before noon

                        } else {

                           item = "110200";           // T-F and others
                        }
                     }
                  }

                  if (parmp.player.startsWith( "Unaccom" )) {       // Unaccompanied Guest

                     item = "140200";
                  }

                  if (parmp.player.startsWith( "Replay" )) {        // Replay Guest

                     item = "140400";
                  }
               }                             // end of course #2

               if (parmp.course.equals( "No 3" )) {         // Course #3

                  if (parmp.player.startsWith( "Guest" )) {         // normal Guest

                     //  changed on 10/16/07 as follows
                     //
                     //   1.  After 4:00 PM every day = 120300 CHANGE to After 2:00PM on Weekends and
                     //       Holidays and after 4:00PM on Weekdays
                     //
                     //   2.  Before 11:00 AM on Sat, Sun and holidays = 130300- CHANGE to 130400
                     //
                     //   3.  If not 1 or 2, then = 110300 CORRECT

                     item = "110300";             // default

                     if (parmp.day.equals( "Saturday" ) || parmp.day.equals( "Sunday" ) ||
                         parmp.date == Hdate1 || parmp.date == Hdate2 || parmp.date == Hdate3) {

                        if (parmp.time > 1400) {

                           item = "120300";              // after 2 PM on w/e & holidays

                        } else {

                           if (parmp.time < 1100) {

                              item = "130400";              // before 11 AM on w/e & holidays
                           }
                        }

                     } else {      // Week Day

                        if (parmp.time > 1600) {

                           item = "120300";              // after 4 PM on weekdays
                        }
                     }
                  }

                  if (parmp.player.startsWith( "Unaccom" )) {       // Unaccompanied Guest

                     item = "140300";
                  }
               }                             // end of course #3
            }

            //
            //  Custom item codes for Virginia CC
            //
            if (club.equals( "virginiacc" )) {      // if Virginia CC do manual item codes

               item = "";                           // init item code

               if (parmp.course.equals( "James River" )) {         // James River Course

                  if (parmp.player.startsWith( "Weekday" )) {

                     item = "FEEGFJRWD";
                  }
                  if (parmp.player.startsWith( "Weekend" )) {

                     item = "FEEGFJRWE";
                  }
                  if (parmp.player.startsWith( "WkDay Family" )) {

                     item = "FEEGFJRFWD";

                     if (parmp.p9 == 1) {

                        item = "FEEGXFWDF";
                     }
                  }
                  if (parmp.player.startsWith( "WkEnd Family" )) {

                     item = "FEEGFWEF";

                     if (parmp.p9 == 1) {

                        item = "FEEGFJRWEF";
                     }
                  }
                  if (parmp.player.startsWith( "Junior WkDay" )) {

                     item = "FEEGFJRWDJ";
                  }
                  if (parmp.player.startsWith( "Junior WkEnd" )) {

                     item = "FEEGFJRWEJ";
                  }

                  if (!item.equals( "" )) {

                     if (parmp.p9 == 1) {                   // if 9 holes

                        item = item + "9";

                     } else {

                        item = item + "18";
                     }
                  }

                  if (parmp.player.startsWith( "Employee" ) || parmp.player.startsWith( "Industry Comp" ) ||
                      parmp.player.startsWith( "VCU" ) || parmp.player.startsWith( "Collegiate" ) ||
                      parmp.player.startsWith( "U of R" ) || parmp.player.startsWith( "St Chris" ) ||
                      parmp.player.startsWith( "Reciprocal" ) ||
                      parmp.player.startsWith( "St Catherines" ) || parmp.player.startsWith( "Assoc Guest" )) {

                     item = "FEEGFJRCOMP";
                  }
               }                             // end of James River

               if (parmp.course.equals( "Tuckahoe Creek" )) {         // Tuckahoe Creek Course

                  if (parmp.player.startsWith( "Weekday" )) {

                     item = "GFTCWD";

                     if (parmp.p9 == 1) {

                        item = "FEEGFTCWD";
                     }
                  }
                  if (parmp.player.startsWith( "Weekend" )) {

                     item = "FEEGFTCWE";
                  }
                  if (parmp.player.startsWith( "WkDay Family" )) {

                     item = "FEEGFTCWDF";
                  }
                  if (parmp.player.startsWith( "WkEnd Family" )) {

                     item = "FEEGFTCWEF";
                  }
                  if (parmp.player.startsWith( "Junior WkDay" )) {

                     item = "FEEGFTCWDJ";
                  }
                  if (parmp.player.startsWith( "Junior WkEnd" )) {

                     item = "FEEGFTCWEJ";
                  }


                  if (!item.equals( "" )) {

                     if (parmp.p9 == 1) {                   // if 9 holes

                        item = item + "9";

                     } else {

                        item = item + "18";
                     }
                  }

                  if (parmp.player.startsWith( "Employee" ) || parmp.player.startsWith( "Industry Comp" ) ||
                      parmp.player.startsWith( "VCU" ) || parmp.player.startsWith( "Collegiate" ) ||
                      parmp.player.startsWith( "U of R" ) || parmp.player.startsWith( "St Chris" ) ||
                      parmp.player.startsWith( "Reciprocal" ) ||
                      parmp.player.startsWith( "St Catherines" ) || parmp.player.startsWith( "Assoc Guest" )) {

                     item = "FEEGFTCCOMP";
                  }
               }                             // end of Tuckahoe Creek

               if (parmp.course.equals( "Westhampton" )) {         // Westhampton Course

                  if (parmp.player.startsWith( "Weekday" )) {

                     item = "FEEGFWHWK";

                     if (parmp.p9 == 1) {

                        item = "FEEGFWHWDAY";
                     }
                  }
                  if (parmp.player.startsWith( "Weekend" )) {

                     item = "FEEGFWHWE";
                  }
                  if (parmp.player.startsWith( "WkDay Family" )) {

                     item = "FEEGFWHWDF";

                     if (parmp.p9 == 1) {

                        item = "FEEGFWHWD";
                     }
                  }
                  if (parmp.player.startsWith( "WkEnd Family" )) {

                     item = "FEEGFWHWEF";
                  }
                  if (parmp.player.startsWith( "Junior WkDay" )) {

                     item = "FEEGFWHWDJ";
                  }
                  if (parmp.player.startsWith( "Junior WkEnd" )) {

                     item = "FEEGFWHWEJ";
                  }

                  if (!item.equals( "" )) {

                     if (parmp.p9 == 1) {                   // if 9 holes

                        item = item + "9";

                     } else {

                        item = item + "18";
                     }
                  }

                  if (parmp.player.startsWith( "Employee" ) || parmp.player.startsWith( "Industry Comp" ) ||
                      parmp.player.startsWith( "VCU" ) || parmp.player.startsWith( "Collegiate" ) ||
                      parmp.player.startsWith( "U of R" ) || parmp.player.startsWith( "St Chris" ) ||
                      parmp.player.startsWith( "Reciprocal" ) ||
                      parmp.player.startsWith( "St Catherines" ) || parmp.player.startsWith( "Assoc Guest" )) {

                     item = "FEEGFWHCOMP";
                  }
               }                             // end of Westhampton Course
            }        // end of Virginia CC


            //
            //  St. Clair CC - custom guest codes based on course
            //
            if (club.equals( "stclaircc" )) {

               if (parmp.course.equals( "Championship" )) {         // Championship Course

                  if (parmp.player.startsWith( "Regular GST" ) || parmp.player.startsWith( "Unaccomp" ) ||
                      parmp.player.startsWith( "Reciprocal" )) {

                     item = "18MFUL";

                     if (parmp.p9 == 1) {

                        item = "09MFUL";
                     }
                  }

                  if (parmp.player.startsWith( "Family GST" )) {

                     item = "18MPAR";

                     if (parmp.p9 == 1) {

                        item = "09MPAR";
                     }
                  }

                  if (parmp.player.startsWith( "PGA" ) || parmp.player.startsWith( "Employees" ) ||
                      parmp.player.startsWith( "Comp" ) || parmp.player.startsWith( "High School Golf" ) ) {

                     item = "18MNON";

                     if (parmp.p9 == 1) {

                        item = "09MNON";
                     }
                  }


               } else {


                  //
                  // Terrace Course
                  //
                  if (parmp.player.startsWith( "Regular GST" ) || parmp.player.startsWith( "Unaccomp" ) ||
                      parmp.player.startsWith( "Reciprocal" ) || parmp.player.startsWith( "Family GST" )) {

                     item = "18TFUL";

                     if (parmp.p9 == 1) {

                        item = "09TFUL";
                     }
                  }

                  if (parmp.player.startsWith( "PGA" ) || parmp.player.startsWith( "Employees" ) ||
                      parmp.player.startsWith( "Comp" ) || parmp.player.startsWith( "High School Golf" ) ) {

                     item = "18TNON";

                     if (parmp.p9 == 1) {

                        item = "09TNON";
                     }
                  }
               }
            }          // end of IF St. Clair CC



            //
            //  Continue if item code found
            //
            if (!item.equals( "" ) && !item.equals( "0" )) {   // if GUEST pos charge found

               //
               //  IF Congressional - check for custom codes based on Course
               //
               if (club.equals( "congressional" )) {

                  tcourse = congressionalCustom.getFullCourseName(parmp.date, daynum, parmp.course);   // get course name for this date

                  if (parmp.player.startsWith( "Local Guest" )) {

                     item = "000G42";                     // item code for Blue course

                     if (tcourse.endsWith( "Gold" )) {

                        item = "000G43";                 // item code for Gold course
                     }
                  }
                  if (parmp.player.startsWith( "Non Local Guest" )) {

                     item = "000G42";                     // item code for Blue course

                     if (tcourse.endsWith( "Gold" )) {

                        item = "000G43";                 // item code for Gold course
                     }
                  }
                  if (parmp.player.startsWith( "Blue Coupon" ) || parmp.player.startsWith( "Gold Coupon" )) {

                     item = "000G42";                     // item code for Blue course

                     if (tcourse.endsWith( "Gold" )) {

                        item = "000G43";                 // item code for Gold course
                     }
                  }
                  if (parmp.player.startsWith( "Unaccomp Guest" )) {

                     item = "000G52";                     // item code for Blue course

                     if (tcourse.endsWith( "Gold" )) {

                        item = "000G53";                 // item code for Gold course
                     }
                  }
                  if (parmp.player.startsWith( "Cert Jr" )) {

                     item = "000G45";                     // item code for Blue course

                     if (tcourse.endsWith( "Gold" )) {

                        item = "000G44";                 // item code for Gold course
                     }
                  }
               }



               //
               //  If Royal Oaks Houston - process by guest type and day
               //
               if (club.equals("royaloakscc")) {

                  if (parmp.player.startsWith( "Guest" )) {

                     if (parmp.day.equals( "Saturday" ) || parmp.day.equals( "Sunday" ) ||
                         parmp.date == Hdate1 || parmp.date == Hdate2 || parmp.date == Hdate3 ||
                         parmp.date == Hdate4 || parmp.date == Hdate5) {

                        item = "49GF03";

                        if (parmp.p9 == 1) {                   // if 9 holes

                           item = "49GF04";
                        }

                     } else {

                        if (parmp.day.equals( "Monday" ) || parmp.day.equals( "Tuesday" ) ||
                            parmp.day.equals( "Wednesday" ) || parmp.day.equals( "Thursday" )) {

                           item = "49GF15";

                           if (parmp.p9 == 1) {                   // if 9 holes

                              item = "49GF16";
                           }

                        } else {

                           if (parmp.time < 1200) {          // Friday - AM or PM?

                              item = "49GF17";

                              if (parmp.p9 == 1) {                   // if 9 holes

                                 item = "49GF18";
                              }

                           } else {

                              item = "49GF19";

                              if (parmp.p9 == 1) {                   // if 9 holes

                                 item = "49GF20";
                              }
                           }
                        }
                     }
                  }

                  if (parmp.player.startsWith( "Hon Guest" )) {

                     if (parmp.day.equals( "Saturday" ) || parmp.day.equals( "Sunday" ) ||
                         parmp.date == Hdate1 || parmp.date == Hdate2 || parmp.date == Hdate3 ||
                         parmp.date == Hdate4 || parmp.date == Hdate5) {

                        item = "55GF16";

                        if (parmp.p9 == 1) {                   // if 9 holes

                           item = "55GF17";
                        }

                     } else {

                        if (parmp.day.equals( "Monday" ) || parmp.day.equals( "Tuesday" ) ||
                            parmp.day.equals( "Wednesday" ) || parmp.day.equals( "Thursday" )) {

                           item = "55GF18";

                           if (parmp.p9 == 1) {                   // if 9 holes

                              item = "55GF19";
                           }

                        } else {

                           if (parmp.time < 1200) {          // Friday - AM or PM?

                              item = "55GF20";

                              if (parmp.p9 == 1) {                   // if 9 holes

                                 item = "55GF21";
                              }

                           } else {

                              item = "55GF22";

                              if (parmp.p9 == 1) {                   // if 9 holes

                                 item = "55GF23";
                              }
                           }
                        }
                     }
                  }

                  if (parmp.player.startsWith( "Ext Family" )) {

                     if (parmp.day.equals( "Saturday" ) || parmp.day.equals( "Sunday" ) ||
                         parmp.date == Hdate1 || parmp.date == Hdate2 || parmp.date == Hdate3 ||
                         parmp.date == Hdate4 || parmp.date == Hdate5) {

                        item = "49GF07";

                        if (parmp.p9 == 1) {                   // if 9 holes

                           item = "49GF08";
                        }

                     } else {

                        if (parmp.day.equals( "Monday" ) || parmp.day.equals( "Tuesday" ) ||
                            parmp.day.equals( "Wednesday" ) || parmp.day.equals( "Thursday" )) {

                           item = "49GF21";

                           if (parmp.p9 == 1) {                   // if 9 holes

                              item = "49GF22";
                           }

                        } else {

                           if (parmp.time < 1200) {          // Friday - AM or PM?

                              item = "49GF23";

                              if (parmp.p9 == 1) {                   // if 9 holes

                                 item = "49GF24";
                              }

                           } else {

                              item = "49GF25";

                              if (parmp.p9 == 1) {                   // if 9 holes

                                 item = "49GF26";
                              }
                           }
                        }
                     }
                  }

                  if (parmp.player.startsWith( "Unaccomp" )) {

                     if (parmp.day.equals( "Saturday" ) || parmp.day.equals( "Sunday" ) ||
                         parmp.date == Hdate1 || parmp.date == Hdate2 || parmp.date == Hdate3 ||
                         parmp.date == Hdate4 || parmp.date == Hdate5) {

                        item = "49GF33";

                     } else {

                        if (parmp.day.equals( "Monday" ) || parmp.day.equals( "Tuesday" ) ||
                            parmp.day.equals( "Wednesday" ) || parmp.day.equals( "Thursday" )) {

                           item = "49GF27";

                        } else {

                           if (parmp.time < 1200) {          // Friday - AM or PM?

                              item = "49GF29";

                           } else {

                              item = "49GF31";
                           }
                        }
                     }
                  }
               }      // end of IF Royal Oaks CC




               //
               //  We can now build the charge string
               //
               StringBuffer tempSB = new StringBuffer(mnum);     // put member # in string buffer
               tempSB.append(",Y,1,");                           // indicator, # of guests (players?)
               tempSB.append(lname);                             // last name
               tempSB.append(",");
               tempSB.append(fname);                             // first name
               tempSB.append(",,");                              // skip phone #
               tempSB.append(parmp.sdate);                       // date of tee time
               tempSB.append(",");
               tempSB.append(parmp.stime);                       // time (includes A or P for AM or PM and ,)
               tempSB.append(parmp.courseid);                    // Course Code
               tempSB.append(",,,,,,");                          // skips
               tempSB.append(item);                              // Sales Item #
               tempSB.append(",1,");                             // units sold
               tempSB.append(resnum);                            // Reservation #
               tempSB.append(",,");                              // unused
               tempSB.append(ttidnum);                           // Tee Time Id #
               tempSB.append(",,,N,,,Y");                        // units sold, skips, Prepaid, Checked-in

               line = tempSB.toString();                         // save as string value

               out.print(line);
               out.println();      // output the line

               done = 1;           // indicate charge sent

               ttidn++;            // bump tee time id number
               ttidnum++;

               //
               //  Save charge data in pos_hist for reports
               //
               parmp.hist_posid = mnum;
               parmp.hist_player = parmp.player;          // if guest
               parmp.hist_price = "";
               parmp.hist_item_name = "Guest Fee";
               parmp.hist_item_num = item;

               add_POS_hist(parmp, con);       // go make the entry
            }
         }     // end of guest processing

      }
      catch (Exception e2) {

         String errorMsg2 = "Error2 in Proshop_sheet_pos.buildJonas for club: " +club;
         errorMsg2 = errorMsg2 + ", Exception: " + e2.getMessage();                 // build error msg

         SystemUtils.logError(errorMsg2);                                           // log it
      }
   }

   return(done);
 }                   // end of buildJonas


 // ********************************************************************
 //  Process the TAI POS charges for an individual member
 //
 //  Build an ASCII file containing the following:
 //
 //   Columns:
 //       1 Course Id
 //       2 Date of Tee Time (mm/dd/yyyy)
 //       3 Time of Tee Time (hh:mm)
 //       4 Member Id (mNum)
 //       5 Member Name (member responsible for the charge)
 //       6 Quantity (always 1)
 //       7 SKU Number (item charge code)
 //
 //    Check the mode of trans for charges
 // ********************************************************************

 private static int buildTAI(parmPOS parmp, PrintWriter out, Connection con, String club) {


   ResultSet rs = null;

   String mship = "";
   String mnum = "";
   String posid = "";
   String fname = "";
   String lname = "";
   String tpos = "";
   String mpos = "";
   String mposc = "";
   String gpos = "";
   String gtype = "";
   String tmode = "";
   String tmodea = "";
   String item = "";
   String line = "";

   int i = 0;
   int p9c = 0;
   int done = 0;


   try {
      //
      //  get the member's mship info
      //
      PreparedStatement pstmtc = con.prepareStatement (
         "SELECT name_last, name_first, m_ship, memNum, posid FROM member2b WHERE username= ?");

      pstmtc.clearParameters();        // clear the parms
      pstmtc.setString(1, parmp.user);

      rs = pstmtc.executeQuery();

      if (rs.next()) {

         lname = rs.getString(1);
         fname = rs.getString(2);
         mship = rs.getString(3);
         mnum = rs.getString(4);
         posid = rs.getString(5);
      }
      pstmtc.close();

   }
   catch (Exception e1) {

      String errorMsg1 = "Error1 in Proshop_sheet_pos.buildTAI for club: " + club;
      errorMsg1 = errorMsg1 + ", Exception: " + e1.getMessage();      // build error msg

      SystemUtils.logError(errorMsg1);                                       // log it
   }

   //
   //  Skip if no mNum/posid - otherwise entire file will fail
   //
   if (!mnum.equals( "" )) {

      try {

         //
         //  First check if there is a charge amount associated with this member's mode of trans
         //
         i = 0;
         loop1:
         while (i < parmp.MAX_Tmodes) {

            if (parmp.tmodea[i].equals( parmp.pcw )) {     // if matching mode of trans found

               tmode = parmp.tmode[i];             // get full description of tmode
               if (parmp.p9 == 1) {                   // if 9 holes
                  item = parmp.t9pos[i];               // get Item Group # for tmode
               } else {
                  item = parmp.tpos[i];               // get Item Group # for tmode
               }
               break loop1;
            }
            i++;
         }

         if (!item.equals( "" ) && !item.equals( "0" )) {   // if pos charge found for Mode of Trans selected

            //
            //  We can now build the charge string
            //
            StringBuffer tempSB = new StringBuffer(parmp.courseid);  // put Course Id in string buffer
            tempSB.append(",");
            tempSB.append(parmp.sdate);                              // date of tee time
            tempSB.append(",");
            tempSB.append(parmp.stime);                              // time (includes A or P for AM or PM and ,)
            tempSB.append(",");
            tempSB.append(mnum);                                     // member number
            tempSB.append(",");
            tempSB.append(fname);                                    // first name
            tempSB.append(" ");                                      // space
            tempSB.append(lname);                                    // last name
            tempSB.append(",1,");                                    // quantity
            tempSB.append(item);                                     // Sales Item Code

            line = tempSB.toString();                         // save as string value

            out.print(line);
            out.println();      // output the line

            done = 1;           // indicate charge sent

            //
            //  Save charge data in pos_hist for reports
            //
            parmp.hist_posid = mnum;
            if (!parmp.player.equals( "" )) {
               parmp.hist_player = parmp.player;          // if guest
            } else {
               parmp.hist_player = fname + " " + lname;   // else use member name
            }
            parmp.hist_price = "";
            parmp.hist_item_name = parmp.pcw;
            parmp.hist_item_num = item;

            add_POS_hist(parmp, con);       // go make the entry
         }

         //
         //  get the mship class and charge amount, if any and if player is a member!
         //
         if (parmp.player.equals( "" )) {    // if member

            i = 0;
            item = "";
            loop2:
            while (i < parmp.MAX_Mships) {

               if (parmp.mship[i].equalsIgnoreCase( mship )) {     // if matching mode mship type

                  if (parmp.p9 == 1) {                   // if 9 holes
                     item = parmp.mship9I[i];               // get mship item group #
                  } else {
                     item = parmp.mshipI[i];               // get mship item group #
                  }
                  break loop2;
               }
               i++;
            }

            if (!item.equals( "" ) && !item.equals( "0" )) {   // if pos charge found for membership (non-golf mship charge)

               //
               //  We can now build the charge string
               //
               StringBuffer tempSB = new StringBuffer(parmp.courseid);  // put Course Id in string buffer
               tempSB.append(",");
               tempSB.append(parmp.sdate);                              // date of tee time
               tempSB.append(",");
               tempSB.append(parmp.stime);                              // time (includes A or P for AM or PM and ,)
               tempSB.append(",");
               tempSB.append(mnum);                                     // member number
               tempSB.append(",");
               tempSB.append(fname);                                    // first name
               tempSB.append(" ");                                      // space
               tempSB.append(lname);                                    // last name
               tempSB.append(",1,");                                    // quantity
               tempSB.append(item);                                     // Sales Item Code

               line = tempSB.toString();                         // save as string value

               out.print(line);
               out.println();      // output the line

               done = 1;           // indicate charge sent

               //
               //  Save charge data in pos_hist for reports
               //
               parmp.hist_posid = mnum;
               parmp.hist_player = fname + " " + lname;   // use member name
               parmp.hist_price = "";
               parmp.hist_item_name = "Green Fee";
               parmp.hist_item_num = item;

               add_POS_hist(parmp, con);       // go make the entry

            }      // end of Mship Charge processing

         } else {

            //
            //  player passed is a guest - charge the member for this too
            //
            //
            //  First check if there is a charge amount associated with this guest type
            //
            i = 0;
            item = "";
            loop3:
            while (i < parmp.MAX_Guests) {

               if (parmp.player.startsWith( parmp.gtype[i] )) {

                  gtype = parmp.gtype[i];               // set guest type description
                  if (parmp.p9 == 1) {                   // if 9 holes
                     item = parmp.gst9I[i];                 // set guest item group #
                  } else {
                     item = parmp.gstI[i];                 // set guest item group #
                  }
                  break loop3;
               }
               i++;
            }

            if (!item.equals( "" ) && !item.equals( "0" )) {   // if pos charge found

               //
               //  We can now build the charge string
               //
               StringBuffer tempSB = new StringBuffer(parmp.courseid);  // put Course Id in string buffer
               tempSB.append(",");
               tempSB.append(parmp.sdate);                              // date of tee time
               tempSB.append(",");
               tempSB.append(parmp.stime);                              // time (includes A or P for AM or PM and ,)
               tempSB.append(",");
               tempSB.append(mnum);                                     // member number
               tempSB.append(",");
               tempSB.append(fname);                                    // first name
               tempSB.append(" ");                                      // space
               tempSB.append(lname);                                    // last name
               tempSB.append(",1,");                                    // quantity
               tempSB.append(item);                                     // Sales Item Code

               line = tempSB.toString();                         // save as string value

               out.print(line);
               out.println();      // output the line

               done = 1;           // indicate charge sent

               //
               //  Save charge data in pos_hist for reports
               //
               parmp.hist_posid = mnum;
               parmp.hist_player = parmp.player;          // if guest
               parmp.hist_price = "";
               parmp.hist_item_name = "Guest Fee";
               parmp.hist_item_num = item;

               add_POS_hist(parmp, con);       // go make the entry
            }
         }     // end of guest processing

      }
      catch (Exception e2) {

         String errorMsg2 = "Error2 in Proshop_sheet_pos.buildTAI for club: " +club;
         errorMsg2 = errorMsg2 + ", Exception: " + e2.getMessage();                 // build error msg

         SystemUtils.logError(errorMsg2);                                           // log it
      }
   }

   return(done);
 }                   // end of buildTAI


 
 // ********************************************************************
 //  Process the IBS POS charges for an individual member
 //
 //  Build individual charges into arrays to be placed into an XML file later:
 //
 //   Columns:
 //       1 Member Number
 //       2 Extension (000, 001, 002, etc. - 000 is default)
 //       3 Date of Tee Time (mm/dd/yyyy)
 //       4 Batch Code (Item Code)
 //       5 Fee (charge amount for item - dd.cc)
 //       6 Sales Tax amount
 //       7 Item Description
 //       8 Ticket # (we use the time)
 //
 // ********************************************************************

 private static int buildIBS(parmPOS parmp, PrintWriter out, Connection con, String club) {


   ResultSet rs = null;
   PreparedStatement pstmtc = null;

   String mship = "";
   String mnum = "";
   String posid = "";
   String fname = "";
   String lname = "";
   String tpos = "";
   String tposc = "";
   String mpos = "";
   String mposc = "";
   String gpos = "";
   String gtype = "";
   String tmode = "";
   String tmodea = "";
   String item = "";
   String cost = "";
   String line = "";
   String ext = "";
   String temp = "";

   int i = 0;
   int p9c = 0;
   int done = 0;

   double fee = 0;
   double salestax = 0;

   long sdate = parmp.date - ((parmp.date / 10000) * 10000);       // get mmdd (short date)
   

   try {
       
      //
      //  get the member's mship info
      //
      pstmtc = con.prepareStatement (
         "SELECT name_last, name_first, m_ship, memNum, posid FROM member2b WHERE username= ?");

      pstmtc.clearParameters();
      pstmtc.setString(1, parmp.user);

      rs = pstmtc.executeQuery();

      if (rs.next()) {

         lname = rs.getString(1);
         fname = rs.getString(2);
         mship = rs.getString(3);
         mnum = rs.getString(4);
         posid = rs.getString(5);
      }

   } catch (Exception exc) {

      Utilities.logError("Error1 in Proshop_sheet_pos.buildIBS for club: " + club + ", Exception: " + exc.getMessage());
      
   } finally {

        try { rs.close(); }
        catch (SQLException ignored) {}

        try { pstmtc.close(); }
        catch (SQLException ignored) {}

   }

   //
   //  Skip if no posid - posid MUST be mnum-ext (i.e.  6700-000)
   //
   if (!posid.equals( "" )) {

      try {

         //
         //  Check if there is a charge amount associated with this member's mode of trans
         //
         i = 0;
         loop1:
         while (i < parmp.MAX_Tmodes) {

            if (parmp.tmodea[i].equals( parmp.pcw )) {     // if matching mode of trans found

               salestax = parmp.salestaxt[i];          // get the sales tax rate for this tmode
               if (parmp.p9 == 1) {                    // if 9 holes
                  item = parmp.t9pos[i];               // get Item Group # for tmode
                  cost = parmp.t9posc[i];              // get Item Fee for tmode
               } else {
                  item = parmp.tpos[i];                // get Item Group # for tmode
                  cost = parmp.tposc[i];               // get Item Fee for tmode
               }
               break loop1;
            }
            i++;
            
         } // end tmode loop

         if (!item.equals( "" ) && !item.equals( "0" )) {   // if pos charge found for Mode of Trans selected

            fee = Double.parseDouble(cost);       // convert the item cost
               
            if (salestax != 0 && !cost.equals( "0" )) {     // if sales tax required

               salestax = (fee * (salestax / 100));         // calculate the sales tax amount

               salestax = roundST(salestax);        // round to dd.cc value
            }
               
               
            // add the charge to parmp
            addCharge(parmp, posid, item, fee, salestax, 1);

            // indicate charge sent
            done = 1;

            // save charge data in pos_hist for reports
            parmp.hist_posid = posid;
            parmp.hist_price = "$" + cost;
            parmp.hist_item_name = parmp.pcw;
            parmp.hist_item_num = item;
            // use guest name (parmp.player) or member name
            parmp.hist_player = (!parmp.player.equals( "" )) ? parmp.player : fname + " " + lname;
            
            // go make the entry
            add_POS_hist(parmp, con);
            
         } // end if charge found for tmode

         
         //
         //  get the mship class and charge amount, if any and if player is a member!
         //
         if (parmp.player.equals( "" )) {    // if member

            i = 0;
            salestax = 0;
            item = "";
            
            
            if (parmp.club.equals( "baltusrolgc" )) {

               //
               //  Baltusrol - certain mship types are charged at all times based on the course
               //
               salestax = 0;        // never a sales tax for Baltusrol
               cost = "0";          // default cost is zero
               
               if (parmp.course.equals( "Upper" )) {

                  if (mship.equals( "House" ) || mship.equals( "House Awaiting Golf" ) || mship.equals( "Special House" )) {

                     item = "1042001001";     
                     cost = "100.00"; 

                  } else if (parmp.p9 == 1) {       // if 9-hole round (all the same)

                     item = "1040001001";           // item code, but no fee 

                  } else if (mship.equals( "Class A" )) {

                     item = "1040001002";           // item code, but no fee 

                  } else if (mship.equals( "Emeritus" )) {

                     item = "1040001003";           // item code, but no fee 

                  } else if (mship.equals( "Executive" )) {

                     item = "1040001004";           // item code, but no fee 

                  } else if (mship.equals( "Exempt" )) {

                     item = "1040001005";           // item code, but no fee 

                  } else if (mship.equals( "Full Golf" )) {

                     item = "1040001006";           // item code, but no fee 

                  } else if (mship.equals( "Honorary" )) {

                     item = "1040001007";           // item code, but no fee 

                  } else if (mship.equals( "Junior" )) {

                     item = "1040001008";           // item code, but no fee 

                  } else if (mship.equals( "National" )) {

                     item = "1040001009";           // item code, but no fee 

                  } else if (mship.equals( "Non-Resident" )) {

                     item = "1040001010";           // item code, but no fee 

                  } else if (mship.equals( "Permit" )) {

                     item = "1040001011";           // item code, but no fee 

                  } else if (mship.equals( "Permit Holder" )) {

                     item = "1040001012";           // item code, but no fee 

                  } else if (mship.equals( "Senior" )) {

                     item = "1040001013";           // item code, but no fee 

                  } else if (mship.equals( "Special" )) {

                     item = "1040001014";           // item code, but no fee 
                  }
                  
               } else {       // Lower course
                  
                  if (mship.equals( "House" ) || mship.equals( "House Awaiting Golf" ) || mship.equals( "Special House" )) {

                     item = "1002001001";     
                     cost = "100.00"; 

                  } else if (parmp.p9 == 1) {       // if 9-hole round (all the same)

                     item = "1000001001";           // item code, but no fee 

                  } else if (mship.equals( "Class A" )) {

                     item = "1000001002";           // item code, but no fee 

                  } else if (mship.equals( "Emeritus" )) {

                     item = "1000001003";           // item code, but no fee 

                  } else if (mship.equals( "Executive" )) {

                     item = "1000001004";           // item code, but no fee 

                  } else if (mship.equals( "Exempt" )) {

                     item = "1000001005";           // item code, but no fee 

                  } else if (mship.equals( "Full Golf" )) {

                     item = "1000001006";           // item code, but no fee 

                  } else if (mship.equals( "Honorary" )) {

                     item = "1000001007";           // item code, but no fee 

                  } else if (mship.equals( "Junior" )) {

                     item = "1000001008";           // item code, but no fee 

                  } else if (mship.equals( "National" )) {

                     item = "1000001009";           // item code, but no fee 

                  } else if (mship.equals( "Non-Resident" )) {

                     item = "1000001010";           // item code, but no fee 

                  } else if (mship.equals( "Permit" )) {

                     item = "1000001011";           // item code, but no fee 

                  } else if (mship.equals( "Permit Holder" )) {

                     item = "1000001012";           // item code, but no fee 

                  } else if (mship.equals( "Senior" )) {

                     item = "1000001013";           // item code, but no fee 

                  } else if (mship.equals( "Special" )) {

                     item = "1000001014";           // item code, but no fee 
                  }
               }

            } else {   // NOT a custom

               loop2:
               while (i < parmp.MAX_Mships) {

                  if (parmp.mship[i].equalsIgnoreCase( mship )) {     // if matching mode mship type

                     salestax = parmp.salestaxm[i];            // get the sales tax rate for this mship type

                     if (parmp.p9 == 1) {                      // if 9 holes
                        item = parmp.mship9I[i];               // get mship item group #
                        cost = parmp.m9posc[i];                // get Item Fee
                     } else {
                        item = parmp.mshipI[i];                // get mship item group #
                        cost = parmp.mposc[i];                 // get Item Fee
                     }
                     break loop2;
                  }
                  i++;
               }
            }

            if (!item.equals( "" ) && !item.equals( "0" )) {    // if pos charge found for membership (non-golf mship charge)

               fee = Double.parseDouble(cost);               // convert the item cost

               if (salestax != 0 && !cost.equals( "0" )) {      // if sales tax required

                  salestax = (fee * (salestax / 100));          // calculate the sales tax amount
                  salestax = roundST(salestax);                 // round to dd.cc value
               }

               // add the charge to parmp
               addCharge(parmp, posid, item, fee, salestax, 1);
            
               // indicate charge sent
               done = 1;

               // save charge data in pos_hist for reports
               parmp.hist_posid = posid;
               parmp.hist_player = fname + " " + lname;   // use member name
               parmp.hist_price = "$" + cost;
               parmp.hist_item_name = "Green Fee";
               parmp.hist_item_num = item;

               add_POS_hist(parmp, con);       // go make the entry

            }      // end of Mship Charge processing

            
         } else {

            
            //
            //  player passed is a guest - charge the member for this too
            //
            //
            //  First check if there is a charge amount associated with this guest type
            //
            i = 0;
            salestax = 0;
            item = "";
            
            
            if (parmp.club.equals( "baltusrolgc" )) {

               //
               //  Baltusrol -  guest fees are based on the course (9 & 18 hole rounds are all charged the same)
               //
               salestax = 0;        // never a sales tax for Baltusrol
               cost = "0";          // default cost is zero
               
               if (parmp.course.equals( "Upper" )) {

                  if (parmp.player.startsWith( "Regular GST" )) {

                     item = "1044001001";     
                     cost = "150.00"; 

                  } else if (parmp.player.startsWith( "Family GST" )) {

                     item = "1046001001";        
                     cost = "75.00"; 

                  } else if (parmp.player.startsWith( "Winter GST" )) {

                     item = "1050001001";        
                     cost = "75.00"; 

                  } else if (parmp.player.startsWith( "Mini Outing" )) {

                     item = "1056001001";        
                     cost = "250.00"; 

                  } else if (parmp.player.startsWith( "Premier GST" )) {

                     item = "1058001001";        
                     cost = "350.00"; 

                  } else if (parmp.player.startsWith( "Outing" )) {

                     item = "9900001002";        
                     cost = "450.00"; 

                  } else if (parmp.player.startsWith( "Twilight Guest" )) {

                     item = "1048001001";        
                     cost = "90.00"; 

                  } else if (parmp.player.startsWith( "Club GST" )) {

                     item = "1044001002";        
                     cost = "0"; 

                  } else if (parmp.player.startsWith( "PGA Comp" )) {

                     item = "1090001001";        
                     cost = "0"; 

                  } else if (parmp.player.startsWith( "Family Links" )) {

                     item = "1040001018";        
                     cost = "0"; 

                  } else if (parmp.player.startsWith( "NJ State Seniors" )) {

                     item = "1052001001";        
                     cost = "0"; 

                  } else if (parmp.player.startsWith( "NCAA" ) || parmp.player.startsWith( "WMGA" ) || parmp.player.startsWith( "GCSAA" ) || 
                             parmp.player.startsWith( "BGC Invitational" ) || parmp.player.startsWith( "Carter Cup" ) || 
                             parmp.player.startsWith( "Junior Interclub" ) || parmp.player.startsWith( "Dayton High" ) ) {

                     item = "1044001002";        
                     cost = "0"; 
                  }
                  
               } else {       // Lower course
                  
                  if (parmp.player.startsWith( "Regular GST" )) {

                     item = "1004001001";     
                     cost = "150.00"; 

                  } else if (parmp.player.startsWith( "Family GST" )) {

                     item = "1006001001";        
                     cost = "75.00"; 

                  } else if (parmp.player.startsWith( "Winter GST" )) {

                     item = "1010001001";        
                     cost = "75.00"; 

                  } else if (parmp.player.startsWith( "Mini Outing" )) {

                     item = "1016001002";        
                     cost = "250.00"; 

                  } else if (parmp.player.startsWith( "Premier GST" )) {

                     item = "1018001001";        
                     cost = "350.00"; 

                  } else if (parmp.player.startsWith( "Outing" )) {

                     item = "1014001001";        
                     cost = "600.00"; 

                  } else if (parmp.player.startsWith( "Twilight Guest" )) {

                     item = "1008001001";        
                     cost = "90.00"; 

                  } else if (parmp.player.startsWith( "Club GST" )) {

                     item = "1000001019";        
                     cost = "0"; 

                  } else if (parmp.player.startsWith( "PGA Comp" )) {

                     item = "1080001001";        
                     cost = "0"; 

                  } else if (parmp.player.startsWith( "Family Links" )) {

                     item = "1000001018";        
                     cost = "0"; 

                  } else if (parmp.player.startsWith( "NJ State Seniors" )) {

                     item = "1000001020";        
                     cost = "0"; 

                  } else if (parmp.player.startsWith( "Mayors Day" )) {

                     item = "1012001001";        
                     cost = "0"; 

                  } else if (parmp.player.startsWith( "NCAA" ) || parmp.player.startsWith( "WMGA" ) || parmp.player.startsWith( "GCSAA" ) || 
                             parmp.player.startsWith( "BGC Invitational" ) || parmp.player.startsWith( "Carter Cup" ) || 
                             parmp.player.startsWith( "Junior Interclub" ) || parmp.player.startsWith( "Dayton High" ) ) {

                     item = "1000001019";        
                     cost = "0"; 
                  }
               }

            } else {   // NOT a custom

               loop3:
               while (i < parmp.MAX_Guests) {

                  if (parmp.player.startsWith( parmp.gtype[i] )) {

                     salestax = parmp.salestaxg[i];            // get the sales tax rate for this guest type

                     if (parmp.p9 == 1) {                      // if 9 holes
                        item = parmp.gst9I[i];                 // set guest item group #
                        cost = parmp.g9pos[i];                 // get Item Fee
                     } else {
                        item = parmp.gstI[i];                  // set guest item group #
                        cost = parmp.gpos[i];                  // get Item Fee
                     }
                     break loop3;
                  }
                  i++;
               }
            }       // end of IF custom

            if (!item.equals( "" ) && !item.equals( "0" )) {    // if pos charge found

               fee = Double.parseDouble(cost);               // convert the item cost
               
               if (salestax != 0 && !cost.equals( "0" )) {      // if sales tax required

                  salestax = (fee * (salestax / 100));          // calculate the sales tax amount
                  salestax = roundST(salestax);                 // round to dd.cc value
               }

               // add the charge to parmp
               addCharge(parmp, posid, item, fee, salestax, 1);

               // indicate charge sent
               done = 1;

               // save charge data in pos_hist for reports
               parmp.hist_posid = posid;
               parmp.hist_player = parmp.player;          // use guest name
               parmp.hist_price = "$" + cost;
               parmp.hist_item_name = "Guest Fee";
               parmp.hist_item_num = item;

               add_POS_hist(parmp, con);       // go make the entry
            }
         }     // end of guest processing

      } catch (Exception exc) {

          Utilities.logError("Error2 in Proshop_sheet_pos.buildIBS for club: " + club + ", i=" +i+ ", tax=" +salestax+ ", Exc: " + exc.getMessage()+ ", Exc: " + exc.toString());
         
      }
   }

   return(done);

 } // end of buildIBS


 
 
 
 // ********************************************************************
 //  Process the ClubSoft POS charges for an individual member
 //
 //  Build an ASCII file containing the following:
 //
 //   Columns:
 //       1 Member Number
 //       2 Date of Tee Time (mm/dd/yyyy)
 //       3 Time of Tee Time (hh:mm)
 //       4 Batch Code (Item Code)
 //       5 Quantity (always 1)
 //
 //   File Name = ForeTeesnn.CSV (nn = 01, 02, 03, etc)
 //
 // ********************************************************************

 private static int buildClubSoft(parmPOS parmp, PrintWriter out, Connection con, String club) {


   ResultSet rs = null;

   String mship = "";
   String mnum = "";
   String posid = "";
   String fname = "";
   String lname = "";
   String tpos = "";
   String tposc = "";
   String mpos = "";
   String mposc = "";
   String gpos = "";
   String gtype = "";
   String tmode = "";
   String tmodea = "";
   String item = "";
   String line = "";
   String temp = "";

   int i = 0;
   int p9c = 0;
   int done = 0;

   long sdate = parmp.date - ((parmp.date / 10000) * 10000);       // get mmdd (short date)


   try {
      //
      //  get the member's mship info
      //
      PreparedStatement pstmtc = con.prepareStatement (
         "SELECT name_last, name_first, m_ship, memNum, posid FROM member2b WHERE username= ?");

      pstmtc.clearParameters();        // clear the parms
      pstmtc.setString(1, parmp.user);

      rs = pstmtc.executeQuery();

      if (rs.next()) {

         lname = rs.getString(1);
         fname = rs.getString(2);
         mship = rs.getString(3);
         mnum = rs.getString(4);       // get both mNum & posid in case we need to use the other
         posid = rs.getString(5);
      }
      pstmtc.close();

   }
   catch (Exception e1) {

      String errorMsg1 = "Error1 in Proshop_sheet_pos.buildClubSoft for club: " + club;
      errorMsg1 = errorMsg1 + ", Exception: " + e1.getMessage();      // build error msg

      SystemUtils.logError(errorMsg1);                                       // log it
   }

   if (posid.equals("")) {        // if POSID not present

      posid = mnum;               // use mNum
   }

   //
   //  Skip if no mNum/posid - otherwise entire file will fail
   //
   if (!posid.equals( "" )) {

      try {

         //
         //  Check if there is a charge amount associated with this member's mode of trans
         //
         i = 0;
         loop1:
         while (i < parmp.MAX_Tmodes) {

            if (parmp.tmodea[i].equals( parmp.pcw )) {     // if matching mode of trans found

               if (parmp.p9 == 1) {                    // if 9 holes
                  item = parmp.t9pos[i];               // get Item Group # for tmode
               } else {
                  item = parmp.tpos[i];                // get Item Group # for tmode
               }
               break loop1;
            }
            i++;
         }

         if (!item.equals( "" ) && !item.equals( "0" )) {   // if pos charge found for Mode of Trans selected

            //
            //  We can now build the charge string
            //
            StringBuffer tempSB = new StringBuffer(posid);           // put Member Id in string buffer
            tempSB.append(",");
            tempSB.append(parmp.sdate);                              // date of tee time (mm/dd/yyyy)
            tempSB.append(",");
            tempSB.append(parmp.stime);                              // time of tee time (hh:mm)
            tempSB.append(",");
            tempSB.append(item);                                     // Sales Item Code
            tempSB.append(",1");                                     // quantity

            line = tempSB.toString();                         // save as string value

            out.print(line);
            out.println();      // output the line

            done = 1;           // indicate charge sent

            //
            //  Save charge data in pos_hist for reports
            //
            parmp.hist_posid = posid;
            if (!parmp.player.equals( "" )) {
               parmp.hist_player = parmp.player;          // use guest name
            } else {
               parmp.hist_player = fname + " " + lname;   // use member name
            }
            parmp.hist_price = "";
            parmp.hist_item_name = parmp.pcw;
            parmp.hist_item_num = item;

            add_POS_hist(parmp, con);       // go make the entry
         }

         //
         //  get the mship class and charge amount, if any and if player is a member!
         //
         if (parmp.player.equals( "" )) {    // if member

            i = 0;
            item = "";
            loop2:
            while (i < parmp.MAX_Mships) {

               if (parmp.mship[i].equalsIgnoreCase( mship )) {     // if matching mode mship type

                  if (parmp.p9 == 1) {                      // if 9 holes
                     item = parmp.mship9I[i];               // get mship item group #
                  } else {
                     item = parmp.mshipI[i];                // get mship item group #
                  }
                  break loop2;
               }
               i++;
            }

            if (!item.equals( "" ) && !item.equals( "0" )) {   // if pos charge found for membership (non-golf mship charge)

               //
               //  We can now build the charge string
               //
               StringBuffer tempSB = new StringBuffer(posid);            // put Member Id in string buffer
               tempSB.append(",");
               tempSB.append(parmp.sdate);                              // date of tee time (mm/dd/yyyy)
               tempSB.append(",");
               tempSB.append(parmp.stime);                              // time of tee time (hh:mm)
               tempSB.append(",");
               tempSB.append(item);                                     // Sales Item Code
               tempSB.append(",1");                                     // quantity

               line = tempSB.toString();                         // save as string value

               out.print(line);
               out.println();      // output the line

               done = 1;           // indicate charge sent

               //
               //  Save charge data in pos_hist for reports
               //
               parmp.hist_posid = posid;
               parmp.hist_player = fname + " " + lname;   // use member name
               parmp.hist_price = "";
               parmp.hist_item_name = "Green Fee";
               parmp.hist_item_num = item;

               add_POS_hist(parmp, con);       // go make the entry

            }      // end of Mship Charge processing

         } else {

            //
            //  player passed is a guest - charge the member for this too
            //
            //
            //  First check if there is a charge amount associated with this guest type
            //
            i = 0;
            item = "";
            loop3:
            while (i < parmp.MAX_Guests) {

               if (parmp.player.startsWith( parmp.gtype[i] )) {

                  if (parmp.p9 == 1) {                      // if 9 holes
                     item = parmp.gst9I[i];                 // set guest item group #
                  } else {
                     item = parmp.gstI[i];                  // set guest item group #
                  }
                  break loop3;
               }
               i++;
            }

            if (!item.equals( "" ) && !item.equals( "0" )) {   // if pos charge found

               //
               //  We can now build the charge string
               //
               StringBuffer tempSB = new StringBuffer(posid);            // put Member Id in string buffer
               tempSB.append(",");
               tempSB.append(parmp.sdate);                              // date of tee time (mm/dd/yyyy)
               tempSB.append(",");
               tempSB.append(parmp.stime);                              // time of tee time (hh:mm)
               tempSB.append(",");
               tempSB.append(item);                                     // Sales Item Code
               tempSB.append(",1");                                     // quantity

               line = tempSB.toString();                         // save as string value

               out.print(line);
               out.println();      // output the line

               done = 1;           // indicate charge sent

               //
               //  Save charge data in pos_hist for reports
               //
               parmp.hist_posid = posid;
               parmp.hist_player = parmp.player;          // use guest name
               parmp.hist_price = "";
               parmp.hist_item_name = "Guest Fee";
               parmp.hist_item_num = item;

               add_POS_hist(parmp, con);       // go make the entry
            }
         }     // end of guest processing

      }
      catch (Exception e2) {

         String errorMsg2 = "Error2 in Proshop_sheet_pos.buildClubSoft for club: " +club;
         errorMsg2 = errorMsg2 + ", Exception: " + e2.getMessage();                 // build error msg

         SystemUtils.logError(errorMsg2);                                           // log it
      }
   }

   return(done);
 }                   // end of buildClubSoft

 
 
 
 
 
 // ********************************************************************
 //  Process the PCS Group POS for an individual member
 //
 //  Build an CSV file containing the following for every player:
 //
 //   Columns:
 //       1 Date
 //       2 Time
 //       3 Course
 //       4 Member Number
 //       5 Player
 //       6 Member/Guest Indicator (0 = member, 1 = guest)
 //       7 Mode of Trans
 //       8 9 Hole Indicator (1 = 9-hole)
 //
 //   File Name = ForeTees-yyyymmdd-hhmmss.CSV 
 //
 // ********************************************************************

 private static int buildPCS(parmPOS parmp, PrintWriter out, Connection con, String club) {


   ResultSet rs = null;

   String mnum = "";
   String lname = "";
   String fname = "";
   String mi = "";
   String player = "";
   int done = 0;

   try {
      //
      //  get the member's mship info
      //
      PreparedStatement pstmtc = con.prepareStatement (
         "SELECT name_last, name_first, name_mi, memNum FROM member2b WHERE username= ?");

      pstmtc.clearParameters();        // clear the parms
      pstmtc.setString(1, parmp.user);

      rs = pstmtc.executeQuery();

      if (rs.next()) {

         lname = rs.getString(1);    
         fname = rs.getString(2);    
         mi = rs.getString(3);    
         mnum = rs.getString(4);    
      }
      pstmtc.close();

   }
   catch (Exception e1) {

      String errorMsg1 = "Error1 in Proshop_sheet_pos.buildPCS for club: " + club;
      errorMsg1 = errorMsg1 + ", Exception: " + e1.getMessage();      // build error msg

      SystemUtils.logError(errorMsg1);                                       // log it
   }
   
   if (parmp.player.equals("")) {     // if member
   
      if (!mi.equals("")) {
         
         player = fname + " " + mi + " " + lname;
         
      } else {
         
         player = fname + " " + lname;
      }
      
   } else {
      
      player = parmp.player;       // get guest value
   }


   //
   //  Buikld the record
   //
   String temp = String.valueOf(parmp.date);         // get date of tee time
   StringBuffer tempSB = new StringBuffer(temp);           // put in string buffer
   tempSB.append(",");
   
   temp = String.valueOf(parmp.time);               // get time of tee time
   tempSB.append(temp);
   tempSB.append(",");
      
   tempSB.append(parmp.course);                    // course name
   tempSB.append(",");
   tempSB.append(mnum);                           
   tempSB.append(",");
   tempSB.append(player);                                   

   if (parmp.player.equals("")) {     // if member
   
      tempSB.append(",0,");        
      
   } else {           // guest
      
      tempSB.append(",1,");        
   }
   
   tempSB.append(parmp.pcw);                           
   
   if (parmp.p9 == 1) {     // if 9-hole round
   
      tempSB.append(",1");        
      
   } else {           // 18 hole
      
      tempSB.append(",0");        
   }
   
   String line = tempSB.toString();               // save as string value

   out.print(line);
   out.println();      // output the line

   done = 1;           // indicate charge sent

   return(done);
 }                   // end of buildPCS


 
 
 
 

 // ********************************************************************
 //  Process the CSG POS charges for an individual member
 //
 //  For AR UPLOAD interface
 //
 //  Build a file (arupload.mas) containing the following:
 //
 //   Columns:
 //       1 Account Number (mnum) - Required                   9 chars
 //       2 Dependent Number (optional) example = 01           2 chars                               
 //       3 Transaction Date (Required) YYMMDD                 6 chars
 //       4 Item Code (Required) example = P01                 3 chars
 //       5 Amount or Fee (Required) example = 85.00           11 chars
 //       6 Service Charge (optional)                          11 chars
 //       7 Sales Tax (optional)                               11 chars
 //       8 Number Served (optional) example = 001              3 chars
 //       9 Server #1 (optional) - employee #                   4 chars
 //       10 Server #2 (optional)                               4 chars
 //       11 Server #3 (optional)                               4 chars
 //       12 Chit or Check # (optional - use teecurrid)         8 chars 
 //       13 CR LF                                              2 chars
 //
 //    Check for charges and build the record
 // ********************************************************************

 private static int buildCSG(parmPOS parmp, PrintWriter out, Connection con, String club, int ttid, String caller) {


   ResultSet rs = null;

   String lname = "";
   String fname = "";
   String mship = "";
   String mnum = "";
   String mtype = "";
   String posid = "";
   String sub_type = "";
   String tpos = "";
   String mpos = "";
   String mposc = "";
   String gpos = "";
   String gtype = "";
   String tmode = "";
   String tmodea = "";
   String line = "";
   String item = "";
   String fee = "";
   String fee_hist = "";
   String amount = "       0.00";                              // space filled
   String dependent = "00";                                    // 00 (not used at this time)
   String numServed = "000";                                   // not used
   String serverNum = "0000";                                  // not used
   //String chit = "00000000";                                   // unused
   String chit = String.valueOf( ttid );                       // chit number - uses teecurrid
   String tax = "";                                            // sales tax value for file

   int i = 0;
   int len = 0;
   int p9c = 0;
   int done = 0;
   double salestax = 0;                          // tax rate from config
   double taxfee = 0;


   //
   //  Force the length of the chit (teecurrid) to 8 chars
   //
   len = chit.length();                   // get length of chit id

   if (len < 8) {                         // if < 8 characters

      while (len < 8) {

         chit = chit + " ";               // add a space filler (left justified)
         len++;
      }

   } else {

      if (len > 8) {                         // if > 8 characters

         while (len > 8) {

            chit = stripOne(chit);         // strip the first char from chit id
            len--;
         }
      }
   }


   try {
      //
      //  get the member's mship info
      //
      PreparedStatement pstmtc = con.prepareStatement (
         "SELECT name_last, name_first, m_ship, m_type, memNum, posid, msub_type " +
         "FROM member2b WHERE username= ?");

      pstmtc.clearParameters();        // clear the parms
      pstmtc.setString(1, parmp.user);

      rs = pstmtc.executeQuery();

      if (rs.next()) {

         lname = rs.getString(1);
         fname = rs.getString(2);
         mship = rs.getString(3);
         mtype = rs.getString(4);
         mnum = rs.getString(5);
         posid = rs.getString(6);
         sub_type = rs.getString(7);
      }
      pstmtc.close();

   }
   catch (Exception e1) {

      String errorMsg1 = "Error1 in Proshop_sheet_pos.buildCSG for club: " + club;
      errorMsg1 = errorMsg1 + ", Exception: " + e1.getMessage();      // build error msg

      SystemUtils.logError(errorMsg1);                                       // log it
   }

   //
   //  Use mnum if posid does not exist
   //
   if (posid.equals( "" )) posid = mnum;

   if (!posid.equals( "" )) {

      //
      //  Build the POS ID field (9 chars)
      //
      len = posid.length();                   // get length of pos id

      if (len < 9) {                         // if < 9 characters

         while (len < 9) {

            posid = posid + " ";             // add a space filler (left justified)
            len++;
         }

      } else {

         if (len > 9) {                         // if > 9 characters

            while (len > 9) {

               posid = stripOne(posid);         // strip the first char from id
               len--;
            }
         }
      }


      try {

         //
         //  First check if there is a charge amount associated with this player's mode of trans
         //
         i = 0;
         loop1:
         while (i < parmp.MAX_Tmodes) {

            if (parmp.tmodea[i].equals( parmp.pcw )) {     // if matching mode of trans found

               tmode = parmp.tmode[i];             // get full description of tmode
               if (parmp.p9 == 1) {                   // if 9 holes
                  item = parmp.t9pos[i];               // get Item Group # for tmode
                  fee = parmp.t9posc[i];               // get fee for tmode
               } else {
                  item = parmp.tpos[i];                // get Item Group # for tmode
                  fee = parmp.tposc[i];                // get fee for tmode
               }
               salestax = parmp.salestaxt[i];          // get sales tax rate if specified
               break loop1;
            }
            i++;
         }

         if (!item.equals( "" ) && !item.equals( " " ) && !item.equals( "0" )) {   // if pos charge found for Mode of Trans selected

            //
            //  Build the Item/SKU field (3 chars)
            //
            len = item.length();                   // get length of item code

            if (len < 3) {                         // if < 3 characters

               while (len < 3) {

                  item = item + " ";             // add a space filler (left justified)
                  len++;
               }

            } else {

               if (len > 3) {                         // if > 3 characters

                  while (len > 3) {

                     item = stripOne(item);         // strip the first char
                     len--;
                  }
               }
            }

            //
            //  Build the Item Amount field (11 chars) and associated sales tax amount 
            //
            if (fee.equals("") || fee.equals(" ") || fee.equals("0")) {
               
               fee = amount;      // use default if none provided
               fee_hist = "0";    // value to use in history
               tax = amount; 
               
            } else {
               
               fee = setFee(fee);                       // enasure dollar format (0.00)
            
               tax = calcSalesTax(salestax, fee);       // calculate the sales tax amount, if any

               len = fee.length();                      // get length of item fee

               if (len < 11) {                          // if < 11 characters

                  while (len < 11) {

                     fee = "0" + fee;                // add a filler (right justified, zero filled)
                     len++;
                  }

               } else {

                  if (len > 11) {                      // if > 11 characters

                     while (len > 11) {

                        fee = stripOne(fee);           // strip the first char
                        len--;
                     }
                  }
               }
               
               fee_hist = getHistFee(fee);             // value to use in history               
            }

            //
            //  Build the charge record
            //
            if (caller.equals("prtReceipt")) {           // if priniting a receipt for Olympic Club
               
               parmp.item += ";" +fname+ " " +lname+ "," +posid+ "," +tmode+ "," +fee+ "," +tax+ "," +chit; 
               
            } else {

               //
               //  We can now build the charge string
               //
               StringBuffer tempSB = new StringBuffer(posid);    // put member id in string buffer
               tempSB.append(dependent);                         // dependent id (00)
               tempSB.append(parmp.sdate);                       // date - yymmdd
               tempSB.append(item);                              // item code
               tempSB.append(fee);                               // charge amount
               tempSB.append(amount);                            // service charge (0)
               tempSB.append(tax);                               // sales tax
               tempSB.append(numServed);                         // number served (0)
               tempSB.append(serverNum);                         // server 1 employee id (0)
               tempSB.append(serverNum);                         // server 2 employee id (0)
               tempSB.append(serverNum);                         // server 3 employee id (0)
               tempSB.append(chit);                              // chit number (0)
              // tempSB.append("\r\n");                            // EOR = CR LF  -  removed to prevent dup!

               line = tempSB.toString();                         // save as string value

               if (caller.equals("timer")) {                  // if initiated by custom timer for Olympic Club

                  addOlyLine(line, parmp);                    // add charge to the file for this course

               } else {

                  out.print(line);
                  out.println();      // output the line
               }
            }

            done = 1;           // indicate charge sent

            //
            //  Save charge data in pos_hist for reports
            //
            parmp.hist_posid = posid;
            if (parmp.player.equals("")) {                // if player is a member
               parmp.hist_player = fname + " " + lname;
            } else {                                      // or guest
               parmp.hist_player = parmp.player;
            }
            parmp.hist_price = fee;
            parmp.hist_item_name = parmp.pcw;
            parmp.hist_item_num = item;

            add_POS_hist(parmp, con);       // go make the entry
         }
         
         

         //
         //  get the mship class and charge amount, if any and if player is a member!
         //
         if (parmp.player.equals( "" )) {      // if member

            i = 0;
            item = "";
            
            //
            //  Check for custom processing of mship types
            //
            if (club.equals( "olyclub" )) {        // if Olympic Club
               
               salestax = 0;                       // no sales tax for these charges
               
               if (parmp.course.equals( "Lake" )) {        // if the Lake course
                  
                  if (sub_type.equals("AP") || sub_type.equals("BG") || sub_type.equals("NP") || sub_type.equals("WG") || 
                      sub_type.equals("WN") || sub_type.equals("FJ") || sub_type.equals("FN") || sub_type.equals("IG") || 
                      sub_type.equals("JR")) {
                     
                     item = "402";         // Green Fee code
                     fee = "0.00";         // no charge        
                     item = "";            // suppress zero charges for now !!!  (per Ruby's request on 6/09/2011)
               
                  //} else if (mship.equals("MNHGP") && (sub_type.equals("MN") || sub_type.equals("NN") || sub_type.equals("GWL") || 
                  //           sub_type.equals("G80") || sub_type.equals("IM") || sub_type.equals("JJ"))) {
                  } else if (sub_type.equals("MN") || sub_type.equals("NN") || sub_type.equals("GWL") || 
                             sub_type.equals("G80") || sub_type.equals("IM") || sub_type.equals("JJ")) {
                     
                     item = "402";         // Green Fee code
                     fee = "95.00";        // fee amount
                  }
               
               } else if (parmp.course.equals( "Ocean" )) {     // if the Ocean course

                  if (sub_type.equals("GWJ")) {      // Junior GWL - per Ruby's instructions
                  
                     item = "495";         // Green Fee code
                     fee = "20.00";        // Jr GWL Rate fee amount
                  
                 } else if (sub_type.equals("MN") || sub_type.equals("NN") || sub_type.equals("GWL") || 
                      sub_type.equals("G80") || sub_type.equals("IM") || sub_type.equals("JJ")) {
                     
                     item = "495";         // Green Fee code
                     
                     // Check to see if we're in DST or not, and, if so, if it's before or after 9/01
                     int yy = 0;
                     int mm = 0;
                     int dd = 0;
                     int twilightTime = 0;

                     try {

                         yy = Integer.parseInt(parmp.sdate.substring(0,2));
                         yy += 2000;
                         mm = Integer.parseInt(parmp.sdate.substring(2,4));
                         mm = mm - 1;
                         dd = Integer.parseInt(parmp.sdate.substring(4));
                         
                     } catch (Exception exc) {
                         Utilities.logError("Proshop_sheet_pos.buildCSG - " + club + " - Error determining DST dates - Err: " + exc.toString());
                     }

                     Calendar cal = new GregorianCalendar();

                     cal.set(yy, mm, dd);

                     boolean isDST = false;

                     if (cal.get(Calendar.DST_OFFSET) != 0) {
                         isDST = true;
                     }

                     if (isDST) {

                         int shortDate = ((mm + 1) * 100) + dd;

                         if (shortDate <= 831) {
                             twilightTime = 1600;
                         } else {
                             twilightTime = 1500;
                         }

                     } else {
                         twilightTime = 1400;
                     }

                     if (parmp.time >= twilightTime) {   // if 2:00/3:00/4:00 PM or later (Twilight) - Time depends on DST and before/after 9/01

                        item = "497";
                        fee = "40.00";        // Twilight fee amount
                        
                     } else {
                        
                        fee = "76.00";        // normal fee amount
                     }
                     
                  /*   Remove these charges - Ruby Chin on 6/20/2011
                  } else if (parmp.time > 1559 && parmp.day.equals("Sunday") && (sub_type.equals("AP") || 
                             sub_type.equals("BG") || sub_type.equals("NP"))) {
                     
                     item = "495";         // Green Fee code
                     fee = "10.00";        // Family Rate fee amount

                  } else if (sub_type.equals("AP") || sub_type.equals("NP") || sub_type.equals("WG") || 
                             sub_type.equals("WN") || sub_type.equals("FJ") || sub_type.equals("FN") ||  
                             sub_type.equals("BG")) {
                     
                     item = "495";         // Green Fee code
                     fee = "0.00";         // no charge
                     item = "";            // suppress zero charges for now !!!  (per Ruby's request on 6/09/2011)  
                   */             
                  }
                    
               } else {         // Cliffs course
                  
                  if (sub_type.equals("AP") || sub_type.equals("NP") || sub_type.equals("WG") || 
                      sub_type.equals("WN") || sub_type.equals("FJ") || sub_type.equals("FN") ||  
                      sub_type.equals("BG")) {
                     
                     item = "496";         // Green Fee code
                     fee = "0.00";         // no charge
                     item = "";            // suppress zero charges for now !!!  (per Ruby's request on 6/09/2011)               
                     
                 // } else if (mship.equals("MNHGP") && (sub_type.equals("MN") || sub_type.equals("NN") || sub_type.equals("GWL") || 
                 //     sub_type.equals("G80") || sub_type.equals("IM") || sub_type.equals("JJ"))) {
                  } else if (sub_type.equals("MN") || sub_type.equals("NN") || sub_type.equals("GWL") || 
                      sub_type.equals("G80") || sub_type.equals("IM") || sub_type.equals("JJ")) {
                     
                     item = "496";         // Green Fee code
                     fee = "21.00";        // Green Fee Amount
                     
                  } else if (mship.equals("Jr Golf") && !sub_type.equals("JR")) {    // no charge for JR's
                     
                     item = "496";         // Green Fee code
                     fee = "15.75";        // Certified Juniors Green Fee Amount
                  }
               }
               
            } else {   // Not Olympic Club
            
               //
               //  no custom required - checked the mship config settings
               //
               loop2:
               while (i < parmp.MAX_Mships) {

                  if (parmp.mship[i].equalsIgnoreCase( mship )) {     // if matching mode mship type

                     if (parmp.p9 == 1) {                   // if 9 holes
                        item = parmp.mship9I[i];               // get mship item group #
                        fee = parmp.m9posc[i];                 // get Item Fee
                     } else {
                        item = parmp.mshipI[i];               // get mship item group #
                        fee = parmp.mposc[i];                 // get Item Fee
                     }
                     salestax = parmp.salestaxm[i];          // get sales tax rate if specified
                     break loop2;
                  }
                  i++;
               }
            }
            

            if (!item.equals( "" ) && !item.equals( " " ) && !item.equals( "0" )) {   // if pos charge found for mship

               //
               //  Build the Item/SKU field (3 chars)
               //
               len = item.length();                   // get length of item code

               if (len < 3) {                         // if < 3 characters

                  while (len < 3) {

                     item = item + " ";             // add a space filler (left justified)
                     len++;
                  }

               } else {

                  if (len > 3) {                         // if > 3 characters

                     while (len > 3) {

                        item = stripOne(item);         // strip the first char
                        len--;
                     }
                  }
               }

               //
               //  Build the Item Amount field (11 chars) and associated Sales Tax amount
               //
               if (fee.equals("") || fee.equals(" ") || fee.equals("0")) {
                  
                  fee = amount;             // use default if none provided
                  fee_hist = "0";           // value to use in history
                  tax = amount;
                  
               } else {

                  fee = setFee(fee);                       // enasure dollar format (0.00)
            
                  tax = calcSalesTax(salestax, fee);       // calculate the sales tax amount, if any

                  len = fee.length();                      // get length of item code

                  if (len < 11) {                          // if < 11 characters

                     while (len < 11) {

                        fee = "0" + fee;                // add a filler (right justified, zero filled)
                        len++;
                     }

                  } else {

                     if (len > 11) {                      // if > 11 characters

                        while (len > 11) {

                           fee = stripOne(fee);           // strip the first char
                           len--;
                        }
                     }
                  }
               
                  fee_hist = getHistFee(fee);             // value to use in history               
               }

               //
               //  Build the charge record
               //
               if (caller.equals("prtReceipt")) {           // if priniting a receipt for Olympic Club

                  parmp.item += ";" +fname+ " " +lname+ "," +posid+ ",Green Fee " +item+ "," +fee+ "," +tax+ "," +chit; 

               } else {

                  //
                  //  We can now build the charge string
                  //
                  StringBuffer tempSB = new StringBuffer(posid);    // put member id in string buffer
                  tempSB.append(dependent);                         // dependent id (00)
                  tempSB.append(parmp.sdate);                       // date - yymmdd
                  tempSB.append(item);                              // item code
                  tempSB.append(fee);                               // charge amount
                  tempSB.append(amount);                            // service charge (0)
                  tempSB.append(tax);                               // sales tax 
                  tempSB.append(numServed);                         // number served (0)
                  tempSB.append(serverNum);                         // server 1 employee id (0)
                  tempSB.append(serverNum);                         // server 2 employee id (0)
                  tempSB.append(serverNum);                         // server 3 employee id (0)
                  tempSB.append(chit);                              // chit number (0)
                //  tempSB.append("\r\n");                            // EOF = CR LF  -  removed to prevent dup!

                  line = tempSB.toString();                         // save as string value

                  if (caller.equals("timer")) {           // if initiated by custom timer for Olympic Club

                     addOlyLine(line, parmp);                    // add charge to the file for this course

                  } else {

                     out.print(line);
                     out.println();      // output the line
                  }
               }

               done = 1;           // indicate charge sent

               //
               //  Save charge data in pos_hist for reports
               //
               parmp.hist_posid = posid;
               parmp.hist_player = fname + " " + lname;
               parmp.hist_price = fee;
               parmp.hist_item_name = "Green Fee";
               parmp.hist_item_num = item;

               add_POS_hist(parmp, con);       // go make the entry

            }      // end of Mship Charge processing

         } else {

            //
            //  player passed is a guest - charge the member for this too
            //
            //
            //  First check if there is a charge amount associated with this guest type
            //
            i = 0;
            item = "";
            
            //
            //  Check for custom processing of guest types
            //
            if (club.equals( "olyclub" )) {        // if Olympic Club
               
               salestax = 0;                       // no sales tax for these charges
               
               if (parmp.course.equals( "Lake" )) {        // if the Lake course
                  
                  //if (parmp.player.startsWith("MHGP w/guest") && (sub_type.equals("AP") || sub_type.equals("BG") || sub_type.equals("NP"))) {
                  if (parmp.player.startsWith("MHGP w/guest")) {
                     
                     item = "402";           // Green Fee code
                     fee = "110.00";         // guest fee charge
               
                  //} else if (parmp.player.startsWith("Unacc Gst") && sub_type.equals("UG")) {
                  } else if (parmp.player.startsWith("Unacc Gst")) {
                     
                     item = "402";         // Green Fee code
                     fee = "360.00";       // fee amount
                     
                  //} else if (parmp.player.startsWith("Unacc Low Fee") && sub_type.equals("UL")) {
                  } else if (parmp.player.startsWith("Unacc Low Fee")) {
                     
                     item = "402";         // Green Fee code
                     fee = "110.00";       // fee amount
                     
                  /*
                  } else if ((parmp.player.startsWith("Discretionary") && sub_type.equals("CY")) || 
                             (parmp.player.startsWith("PGA") && sub_type.equals("PG")) || 
                             (parmp.player.startsWith("Clergy") && sub_type.equals("CL")) || 
                             (parmp.player.startsWith("Fireman/Pol") && sub_type.equals("FP")) || 
                             (parmp.player.startsWith("Employee") && sub_type.equals("EE")) || 
                             (parmp.player.startsWith("GM/Super") && sub_type.equals("GS")) || 
                             (parmp.player.startsWith("USGA") && sub_type.equals("US"))) { 
                   */  
                  } else if (parmp.player.startsWith("Discretionary") || 
                             parmp.player.startsWith("PGA") || 
                             parmp.player.startsWith("Clergy") || 
                             parmp.player.startsWith("Fireman/Pol") || 
                             parmp.player.startsWith("Employee") || 
                             parmp.player.startsWith("GM/Super") || 
                             parmp.player.startsWith("USGA")) {   
                     
                     item = "402";         // Green Fee code
                     fee = "0.00";         // no charge
                     item = "";            // suppress zero charges for now !!!  (per Ruby's request on 6/09/2011)               
                  }
               
               } else if (parmp.course.equals( "Ocean" )) {     // if the Ocean course
               
                  //if (parmp.player.startsWith("MHGP w/guest") && (sub_type.equals("AP") || sub_type.equals("BG") || sub_type.equals("NP"))) {
                  if (parmp.player.startsWith("MHGP w/guest")) {
                     
                     item = "495";           // Green Fee code
                     fee = "96.00";          // guest fee charge
               
                  //} else if (parmp.player.startsWith("MNHGP w/guest") && (sub_type.equals("MN") || sub_type.equals("NN") || sub_type.equals("GWL"))) {
                  } else if (parmp.player.startsWith("MNHGP w/guest")) {
                     
                     item = "495";         // Green Fee code
                     fee = "96.00";        // fee amount
                     
                  //} else if (parmp.player.startsWith("MHGP Guest Outing") && (sub_type.equals("AP") || sub_type.equals("BG") || sub_type.equals("NP"))) {
                  } else if (parmp.player.startsWith("MHGP Guest Outing")) {
                     
                     item = "498";         // Green Fee code    *** was 495 - changed per Ruby Chin 6/19/2011
                     fee = "90.00";        // fee amount
                     
                  //} else if (parmp.player.startsWith("Twilight Gst") && (sub_type.equals("AP") || sub_type.equals("BG") || sub_type.equals("NP") || 
                  //           sub_type.equals("MN") || sub_type.equals("NN") || sub_type.equals("GWL"))) {
                  } else if (parmp.player.startsWith("Twilight Gst")) {
                     
                     item = "497";         // Green Fee code   *** was 495 - changed per Ruby Chin 6/19/2011
                     fee = "40.00";        // fee amount
                     
                  //} else if (parmp.player.startsWith("Coach Staff") && sub_type.equals("CS")) {
                  } else if (parmp.player.startsWith("Coach Staff")) {
                     
                     item = "495";         // Green Fee code
                     fee = "76.00";        // fee amount
                     
                  //} else if (parmp.player.startsWith("Unacc Gst") && sub_type.equals("UG")) {
                  } else if (parmp.player.startsWith("Unacc Gst")) {
                     
                     item = "495";         // Green Fee code
                     fee = "235.00";       // fee amount
                     
                  //} else if (parmp.player.startsWith("Unacc Low Fee") && sub_type.equals("UL")) {
                  } else if (parmp.player.startsWith("Unacc Low Fee")) {
                     
                     item = "495";         // Green Fee code
                     fee = "96.00";        // fee amount
                     
                  /*   Removed per Ruby Chin's request on 6/20/2011
                  } else if (parmp.player.startsWith("Junior GWL")) {
                     
                     item = "495";         // Green Fee code
                     fee = "20.00";        // fee amount
                   */
                     
                  } else if (parmp.player.startsWith("Family Rate")) {
                     
                     item = "495";         // Green Fee code
                     fee = "10.00";        // fee amount
                     
                  /*
                  } else if ((parmp.player.startsWith("Discretionary") && sub_type.equals("CY")) || 
                             (parmp.player.startsWith("PGA") && sub_type.equals("PG")) || 
                             (parmp.player.startsWith("Clergy") && sub_type.equals("CL")) || 
                             (parmp.player.startsWith("Fireman/Pol") && sub_type.equals("FP")) || 
                             (parmp.player.startsWith("Employee") && sub_type.equals("EE")) || 
                             (parmp.player.startsWith("GM/Super") && sub_type.equals("GS")) || 
                             (parmp.player.startsWith("USGA") && sub_type.equals("US"))) {   
                   */
                  } else if (parmp.player.startsWith("Discretionary") || 
                             parmp.player.startsWith("PGA") || 
                             parmp.player.startsWith("Clergy") || 
                             parmp.player.startsWith("Fireman/Pol") || 
                             parmp.player.startsWith("Employee") || 
                             parmp.player.startsWith("GM/Super") || 
                             parmp.player.startsWith("USGA")) {   
                     
                     item = "495";         // Green Fee code
                     fee = "0.00";         // no charge
                     item = "";            // suppress zero charges for now !!!  (per Ruby's request on 6/09/2011)               
                  }
                    
               } else {         // Cliffs course
                  
                  //if (parmp.player.startsWith("MHGP w/guest") && (sub_type.equals("AP") || sub_type.equals("BG") || sub_type.equals("NP"))) {
                  if (parmp.player.startsWith("MHGP w/guest")) {
                     
                     item = "496";           // Green Fee code  (changed from 493 on 6/16/11 per Ruby Chin)
                     fee = "26.00";          // guest fee charge
               
                  //} else if (parmp.player.startsWith("MNHGP w/guest") && (sub_type.equals("MN") || sub_type.equals("NN") || sub_type.equals("GWL"))) {
                  } else if (parmp.player.startsWith("MNHGP w/guest")) {
                     
                     item = "496";         // Green Fee code
                     fee = "26.00";        // fee amount
                     
                  /*
                  } else if ((parmp.player.startsWith("Discretionary") && sub_type.equals("CY")) || 
                             (parmp.player.startsWith("PGA") && sub_type.equals("PG")) || 
                             (parmp.player.startsWith("Fireman/Pol") && sub_type.equals("FP")) || 
                             (parmp.player.startsWith("Employee") && sub_type.equals("EE")) || 
                             (parmp.player.startsWith("GM/Super") && sub_type.equals("GM"))) { 
                   */  
                  } else if (parmp.player.startsWith("Discretionary") || 
                             parmp.player.startsWith("PGA") || 
                             parmp.player.startsWith("Fireman/Pol") || 
                             parmp.player.startsWith("Employee") || 
                             parmp.player.startsWith("GM/Super")) {   
                     
                     item = "495";         // Green Fee code
                     fee = "0.00";         // no charge
                     item = "";            // suppress zero charges for now !!!  (per Ruby's request on 6/09/2011)               
                  }
               }
               
            } else {   // Not Olympic Club
            
               loop3:
               while (i < parmp.MAX_Guests) {

                  if (parmp.player.startsWith( parmp.gtype[i] )) {

                     gtype = parmp.gtype[i];               // set guest type description
                     if (parmp.p9 == 1) {                   // if 9 holes
                        item = parmp.gst9I[i];                 // set guest item group #
                        fee = parmp.g9pos[i];                  // get Item Fee
                     } else {
                        item = parmp.gstI[i];                  // set guest item group #
                        fee = parmp.gpos[i];                   // get Item Fee
                     }
                     salestax = parmp.salestaxg[i];            // get sales tax rate if specified
                     break loop3;
                  }
                  i++;
               }
            }

            if (!item.equals( "" ) && !item.equals( " " ) && !item.equals( "0" )) {   // if pos charge found for guest

               //
               //  Build the Item/SKU field (3 chars)
               //
               len = item.length();                   // get length of item code

               if (len < 3) {                         // if < 3 characters

                  while (len < 3) {

                     item = item + " ";             // add a space filler (left justified)
                     len++;
                  }

               } else {

                  if (len > 3) {                         // if > 3 characters

                     while (len > 3) {

                        item = stripOne(item);         // strip the first char
                        len--;
                     }
                  }
               }

               //
               //  Build the Item Amount field (11 chars) and associated Sales Tax amount
               //
               if (fee.equals("") || fee.equals(" ") || fee.equals("0")) {
                  
                  fee = amount;      // use default if none provided
                  fee_hist = "0";    // value to use in history
                  tax = amount;
                  
               } else {

                  fee = setFee(fee);                       // enasure dollar format (0.00)
            
                  tax = calcSalesTax(salestax, fee);       // calculate the sales tax amount, if any

                  len = fee.length();                      // get length of item code

                  if (len < 11) {                          // if < 11 characters

                     while (len < 11) {

                        fee = "0" + fee;                // add a filler (right justified, zero filled)
                        len++;
                     }

                  } else {

                     if (len > 11) {                      // if > 11 characters

                        while (len > 11) {

                           fee = stripOne(fee);           // strip the first char
                           len--;
                        }
                     }
                  }
               
                  fee_hist = getHistFee(fee);             // value to use in history               
               }

               //
               //  Build the charge record
               //
               if (caller.equals("prtReceipt")) {           // if priniting a receipt for Olympic Club

                  parmp.item += ";" +fname+ " " +lname+ "," +posid+ "," +parmp.player+ "," +fee+ "," +tax+ "," +chit; 

               } else {

                  //
                  //  We can now build the charge string
                  //
                  StringBuffer tempSB = new StringBuffer(posid);    // put member id in string buffer
                  tempSB.append(dependent);                         // dependent id (00)
                  tempSB.append(parmp.sdate);                       // date - yymmdd
                  tempSB.append(item);                              // item code
                  tempSB.append(fee);                               // charge amount
                  tempSB.append(amount);                            // service charge (0)
                  tempSB.append(tax);                               // sales tax
                  tempSB.append(numServed);                         // number served (0)
                  tempSB.append(serverNum);                         // server 1 employee id (0)
                  tempSB.append(serverNum);                         // server 2 employee id (0)
                  tempSB.append(serverNum);                         // server 3 employee id (0)
                  tempSB.append(chit);                              // chit number (0)
              //    tempSB.append("\r\n");                            // EOF = CR LF  -  removed to prevent dup!

                  line = tempSB.toString();                         // save as string value

                  if (caller.equals("timer")) {           // if initiated by custom timer for Olympic Club

                     addOlyLine(line, parmp);                    // add charge to the file for this course

                  } else {

                     out.print(line);
                     out.println();      // output the line
                  }
               }

               done = 1;           // indicate charge sent

               //
               //  Save charge data in pos_hist for reports
               //
               parmp.hist_posid = posid;
               parmp.hist_player = parmp.player;
               parmp.hist_price = fee;
               parmp.hist_item_name = "Guest Fee";
               parmp.hist_item_num = item;

               add_POS_hist(parmp, con);       // go make the entry

            }
         }     // end of guest processing

      }
      catch (Exception e2) {

         String errorMsg2 = "Error2 in Proshop_sheet_pos.buildCSG for club: " +club;
         errorMsg2 = errorMsg2 + ", Exception: " + e2.getMessage();                 // build error msg

         SystemUtils.logError(errorMsg2);                                           // log it
      }
   }

   return(done);
 }                   // end of buildCSG


 // ********************************************************************
 //  CSG - Convert Item Fee or Sales Tax amount to 0.00 format
 // ********************************************************************

 private static String setFee(String fee) {

   BigDecimal bd = new BigDecimal(fee);    // convert fee to a big decimal value
   
   bd = bd.setScale(2, RoundingMode.HALF_UP);   // force value to 2 decimal digits, rounded up
   
   fee = String.valueOf( bd );            // create back to string value

   return(fee);
 }                   // end of setFee
 
 
 
 
 // ********************************************************************
 //  CSG - reduce the length of the fee string so it fits in the POS History table
 // ********************************************************************

 private static String getHistFee(String fee) {

   fee = fee.trim();               // trim any spaces
              
   int len = fee.length();         // get length of item fee
   
   while (len > 8) {
      
      stripOne(fee);               // strip a char from the start of the value (should be zeros)      
      len--;  
   }

   return(fee);
 }                   // end of setFee
 
 


 // ********************************************************************
 //  CSG - Calculate the sales tax amount
 // ********************************************************************

 private static String calcSalesTax(double salestax, String fee) {

   String tax = "";
   String amount = "       0.00";          // default tax amount - space filled
   double taxfee = 0;

   if (salestax != 0) {                     // if sales tax rate specified
      
      salestax = salestax/100;                // convert percentage to decimal value (i.e.  6.5% = .0065)

      taxfee = Double.parseDouble(fee);       // convert the fee to a double for the math

      taxfee = (taxfee * salestax);           // calculate the sales tax amount (item cost x the tax rate)

      tax = String.valueOf( taxfee );         // create string value of the sales tax amount

      tax = setFee(tax);                      // Round the tax amount to 00.00 value

      int len = tax.length();                 // get length of sales tax

      if (len < 11) {                         // if < 11 characters

         while (len < 11) {

            tax = "0" + tax;                // add a filler (right justified, zero filled)
            len++;
         }

      } else {

         if (len > 11) {                      // if > 11 characters

            while (len > 11) {

               tax = stripOne(tax);           // strip the first char
               len--;
            }
         }
      }

   } else {

      tax = amount; 
   }

   return(tax);
 }                   // end of calcSalesTax


 // *********************************************************
 //   Round the sales tax amount to dd.cc (used in IBS POS)
 // *********************************************************
 //
 private static double roundST(double salestax) {


    if (salestax != 0) {

       // round up or leave alone (cc.dd)

       salestax = (salestax * 100);       // increment for rounding to work

       salestax = Math.round(salestax);   // round to whole number

       salestax = (salestax / 100);       // convert back to dd.cc
    }

    return(salestax);
 }

 
 
 // ********************************************************************
 //  Process the NorthStar POS charges for an individual member
 //
 //  Build an ASCII file containing the following (this will build one record):
 //
 //
 //      mm/dd/yyyy hh:mm:ss                    (current date & time)
 //      mNum, mm/dd/yyyy, pos item#, quantity  (one record per charge)
 //      #                                      (total # of records included)
 //      EOF
 //
 //
 //    Check the mode of trans for charges
 // ********************************************************************

 private static int buildLineNS(parmPOS parmp, String filename, PrintWriter out, Connection con) {


   ResultSet rs = null;

   String mship = "";
   String posid = "";
   String fname = "";
   String lname = "";
   String tpos = "";
   String mpos = "";
   String mposc = "";
   String gpos = "";
   String gtype = "";
   String tmode = "";
   String tmodea = "";
   String item = "";
   String line = "";

   int i = 0;
   int p9c = 0;
   int done = 0;


   try {
      //
      //  get the member's mship info
      //
      PreparedStatement pstmtc = con.prepareStatement (
         "SELECT name_last, name_first, m_ship, posid FROM member2b WHERE username= ?");

      pstmtc.clearParameters();        // clear the parms
      pstmtc.setString(1, parmp.user);

      rs = pstmtc.executeQuery();

      if (rs.next()) {

         lname = rs.getString(1);
         fname = rs.getString(2);
         mship = rs.getString(3);
         posid = rs.getString(4);
      }
      pstmtc.close();

      //
      //  Skip if no posid - otherwise entire file will fail
      //
      if (!posid.equals( "" )) {

         //
         //  First check if there is a charge amount associated with this player's mode of trans
         //
         i = 0;
         loop1:
         while (i < parmp.MAX_Tmodes) {

            if (parmp.tmodea[i].equals( parmp.pcw )) {     // if matching mode of trans found

               tmode = parmp.tmode[i];                // get full description of tmode
               if (parmp.p9 == 1) {                   // if 9 holes
                  item = parmp.t9pos[i];              // get Item Group # for tmode
               } else {
                  item = parmp.tpos[i];               // get Item Group # for tmode
               }
               break loop1;
            }
            i++;
         }

         if (!item.equals( "" ) && !item.equals( "0" )) {   // if pos charge found for Mode of Trans selected

            if (parmp.count == 0) {                         // if first item to be charged

               addHdrNS(parmp, filename);                   // go create the file and build the header
            }

            //
            //  We can now build the charge string
            //
            StringBuffer tempSB = new StringBuffer(posid);     // put member's posid in string buffer
            tempSB.append(",");
            tempSB.append(parmp.sdate);                        // date (mm/dd/yyyy)
            tempSB.append(",");
            tempSB.append(item);                               // item's POS Id
            tempSB.append(",1");                               // quantity = 1

            line = tempSB.toString();                         // save as string value

            addLineNS(filename, line);                        // go add this record

            parmp.count++;      // bump record counter

            done = 1;           // indicate charge sent

            //
            //  Save charge data in pos_hist for reports
            //
            parmp.hist_posid = posid;
            if (!parmp.player.equals( "" )) {
               parmp.hist_player = parmp.player;          // if guest
            } else {
               parmp.hist_player = fname + " " + lname;   // else use member name
            }
            parmp.hist_price = "";
            parmp.hist_item_name = parmp.pcw;
            parmp.hist_item_num = item;

            add_POS_hist(parmp, con);       // go make the entry
         }

         //
         //  get the mship class and charge amount, if any and if player is a member!
         //
         if (parmp.player.equals( "" )) {     // if player is a member

            i = 0;
            item = "";

            if (parmp.club.equals( "baltimore" )) {

               //
               //  Baltimore CC - certain mship types are charged at all times based on the course
               //
               if (mship.equals( "No Package" ) || mship.equals( "Non Golf" )) {

                  if (parmp.course.startsWith( "West" )) {

                     item = "1620450185";          // West Course Code

                  } else {

                     item = "1785145609";          // East Course Code
                  }

               } else {

                  if (mship.equals( "Non Resident No Package" )) {

                     if (parmp.course.startsWith( "West" )) {

                        item = "1897823435";          // West Course Code

                     } else {

                        item = "997456107";          // East Course Code
                     }

                  } else {

                     if (mship.equals( "Non Season Golfer" )) {

                        if (parmp.course.startsWith( "West" )) {

                           if (parmp.p9 == 1) {                // if 9 holes

                              item = "603561154";              // West Course Code - 9 holes

                           } else {

                              item = "1801649527";              // West Course Code - 18 holes
                           }

                        } else {

                           if (parmp.p9 == 1) {                // if 9 holes

                              item = "1421916998";             // East Course Code - 9 holes

                           } else {

                              item = "1225472267";              // East Course Code - 18 holes
                           }
                        }
                     }
                  }
               }

            } else if (parmp.club.equals( "philcricket" )) {

               //
               //  Philly Cricket Club - certain mship types are charged at all times based on the course and day
               //
               if (mship.equals( "Golf Stm Ind." ) || mship.equals( "Golf Stm Family" ) || mship.equals( "No Golf" )) {

                  if (parmp.course.equals( "Wissahickon" )) {

                     item = "WWKND";     // Weekend Code        

                     if (parmp.day.equals( "Tuesday" ) || parmp.day.equals( "Wednesday" ) || parmp.day.equals( "Thursday" )) {
                     
                        item = "WWKDY";     // Weekday Code
                     }

                  } else if (parmp.course.equals( "Militia Hill" )) {

                     item = "MHWKND";     // Weekend Code        

                     if (parmp.day.equals( "Tuesday" ) || parmp.day.equals( "Wednesday" ) || parmp.day.equals( "Thursday" )) {
                     
                        item = "MHWKDY";     // Weekday Code
                     }

                  } else if (parmp.course.equals( "St Martins" ) && mship.equals( "No Golf" )) {

                     item = "STMWKND";     // Weekend Code        

                     if (parmp.day.equals( "Tuesday" ) || parmp.day.equals( "Wednesday" ) || parmp.day.equals( "Thursday" )) {
                     
                        item = "STMWKDY";     // Weekday Code
                     }
                  }
               }

            } else {   // NOT Baltimore or Philly Cricket

               loop2:
               while (i < parmp.MAX_Mships) {

                  if (parmp.mship[i].equalsIgnoreCase( mship )) {     // if matching mode mship type

                     if (parmp.p9 == 1) {                   // if 9 holes
                        item = parmp.mship9I[i];               // get mship item group #
                     } else {
                        item = parmp.mshipI[i];               // get mship item group #
                     }
                     break loop2;
                  }
                  i++;
               }
            }

            if (!item.equals( "" ) && !item.equals( "0" )) {   // if pos charge found for membership (non-golf mship charge)

               if (parmp.count == 0) {                         // if first item to be charged

                  addHdrNS(parmp, filename);                   // go create the file and build the header
               }

               //
               //  We can now build the charge string
               //
               StringBuffer tempSB = new StringBuffer(posid);     // put member's posid in string buffer
               tempSB.append(",");
               tempSB.append(parmp.sdate);                        // date (mm/dd/yyyy)
               tempSB.append(",");
               tempSB.append(item);                               // item's POS Id
               tempSB.append(",1");                               // quantity = 1

               line = tempSB.toString();                         // save as string value

               addLineNS(filename, line);                        // go add this record

               parmp.count++;      // bump record counter

               done = 1;           // indicate charge sent

               //
               //  Save charge data in pos_hist for reports
               //
               parmp.hist_posid = posid;
               parmp.hist_player = fname + " " + lname;   // else use member name
               parmp.hist_price = "";
               parmp.hist_item_name = "Green Fee";
               parmp.hist_item_num = item;

               add_POS_hist(parmp, con);       // go make the entry

            }      // end of Mship Charge processing

         } else {

            //
            //  player passed is a guest - charge the member for this too
            //

            //
            //  First check if there is a charge amount associated with this guest type
            //
            i = 0;
            item = "";
            
            if (parmp.club.equals( "philcricket" )) {

               //
               //  Philly Cricket Club - certain guest types are charged at all times based on the course and day
               //
               if (parmp.player.startsWith( "Wkday" )) {

                  if (parmp.course.equals( "Wissahickon" )) {

                     item = "WWKDY";         

                  } else if (parmp.course.equals( "Militia Hill" )) {

                     item = "MHWKDY"; 
                     
                  } else {
                     
                     item = "STMWKDY";     // St Martins
                  }
                  
               } else if (parmp.player.startsWith( "Wkend" )) {

                  if (parmp.course.equals( "Wissahickon" )) {

                     item = "WWKND";           

                  } else if (parmp.course.equals( "Militia Hill" )) {

                     item = "MHWKND";          
                     
                  } else {
                     
                     item = "STMWKND";     // St Martins
                  }
                  
               } else if (parmp.player.startsWith( "*Wkdayfam" )) {

                  if (parmp.course.equals( "Wissahickon" )) {

                     item = "WWKDYFG";         

                  } else if (parmp.course.equals( "Militia Hill" )) {

                     item = "MHWKDYFG";          
                     
                  } else {
                     
                     item = "STMWKDYFG";     // St Martins
                  }
                  
               } else if (parmp.player.startsWith( "*Wkendfam" )) {

                  if (parmp.course.equals( "Wissahickon" )) {

                     item = "WWKNDFG";     // Weekend Code        

                  } else if (parmp.course.equals( "Militia Hill" )) {

                     item = "MHWKNDFG";     // Weekend Code        
                     
                  } else {
                     
                     item = "STMWKNDFG";     // St Martins
                  }
                  
               } else if (parmp.player.startsWith( "Unaccweekday" )) {

                  if (parmp.course.equals( "Wissahickon" )) {

                     item = "WWKDYUN";        

                  } else if (parmp.course.equals( "Militia Hill" )) {

                     item = "MHWKDYUN";           
                     
                  } else {
                     
                     item = "STMWKDY";     // St Martins
                  }
                  
               } else if (parmp.player.startsWith( "Unaccwkend" )) {

                  if (parmp.course.equals( "Wissahickon" )) {

                     item = "WWKNDUN";     

                  } else if (parmp.course.equals( "Militia Hill" )) {

                     item = "MHWKNDUN";        
                     
                  } else {
                     
                     item = "STMWKND";     // St Martins
                  }
                  
               } else if (parmp.player.startsWith( "Recip" )) {

                  if (parmp.course.equals( "Wissahickon" )) {

                     item = "WRECIP";         

                  } else if (parmp.course.equals( "Militia Hill" )) {

                     item = "MHRECIP";         
                  }
                  
               } else if (parmp.player.startsWith( "JrWkday" )) {

                  if (parmp.course.equals( "Wissahickon" )) {

                     item = "WWKDYJR";    

                  } else if (parmp.course.equals( "Militia Hill" )) {

                     item = "MHWKDYJR";           
                     
                  } else {
                     
                     item = "STMWKDYJR";     // St Martins
                  }
                  
               } else if (parmp.player.startsWith( "JrWkend" )) {

                  if (parmp.course.equals( "Wissahickon" )) {

                     item = "WWKNDJR";    

                  } else if (parmp.course.equals( "Militia Hill" )) {

                     item = "MHWKNDJR";           
                     
                  } else {
                     
                     item = "STMWKNDJR";     // St Martins
                  }                  
               }

            } else {    // end of IF Philly Cricket            
            
               //
               //   All others - check guest type
               //
               loop3:
               while (i < parmp.MAX_Guests) {

                  if (parmp.player.startsWith( parmp.gtype[i] )) {

                     gtype = parmp.gtype[i];               // set guest type description
                     if (parmp.p9 == 1) {                   // if 9 holes
                        item = parmp.gst9I[i];                 // set guest item group #
                     } else {
                        item = parmp.gstI[i];                 // set guest item group #
                     }
                     break loop3;
                  }
                  i++;
               }
            }

            if (!item.equals( "" ) && !item.equals( "0" )) {   // if pos charge found

               if (parmp.count == 0) {                         // if first item to be charged

                  addHdrNS(parmp, filename);                   // go create the file and build the header
               }

               //
               //  We can now build the charge string
               //
               StringBuffer tempSB = new StringBuffer(posid);     // put member's posid in string buffer
               tempSB.append(",");
               tempSB.append(parmp.sdate);                        // date (mm/dd/yyyy)
               tempSB.append(",");
               tempSB.append(item);                               // item's POS Id
               tempSB.append(",1");                               // quantity = 1

               line = tempSB.toString();                         // save as string value

               addLineNS(filename, line);                        // go add this record

               parmp.count++;      // bump record counter

               done = 1;           // indicate charge sent

               //
               //  Save charge data in pos_hist for reports
               //
               parmp.hist_posid = posid;
               parmp.hist_player = parmp.player;          // if guest
               parmp.hist_price = "";
               parmp.hist_item_name = "Guest Fee";
               parmp.hist_item_num = item;

               add_POS_hist(parmp, con);       // go make the entry
            }
         }     // end of guest processing

      }        // end of IF no posid

   }
   catch (Exception e1) {

      String errorMsg1 = "Error1 in Proshop_sheet_pos.buildLineNS: ";
      errorMsg1 = errorMsg1 + e1.getMessage();                                // build error msg

      SystemUtils.logError(errorMsg1);                                       // log it
   }

   return(done);
 }                   // end of buildLineNS


 // ********************************************************************
 //
 //  NorthStar POS - Create a new ASCII file and add the header.
 //
 // ********************************************************************

 private static void addHdrNS(parmPOS parmp, String filename) {


    addLineNS(filename, parmp.sdate);                // go create file and add header

    //
    //  Now strip the time stamp from sdate so we can use the date for each record
    //
    //   "mm/dd/yyyy hh:mm:ss" -> "mm/dd/yyyy"
    //
    StringTokenizer tok = new StringTokenizer( parmp.sdate, " " );     // delimiters are space

    parmp.sdate = tok.nextToken();        // date only
 }


 // *********************************************************
 //  Create POS History entry in pos_hist table
 // *********************************************************

 private static void add_POS_hist(parmPOS parmp, Connection con) {


   //
   //   Use the info in parmp to create a history entry
   try {

      PreparedStatement pstmt = con.prepareStatement (
        "INSERT INTO pos_hist (date, time, course, fb, member_id, player, " +
        "item_num, item_name, price, p9, date_time) " +
        "VALUES (?,?,?,?,?,?,?,?,?,?,now())");

      pstmt.clearParameters();        // clear the parms
      pstmt.setLong(1, parmp.date);
      pstmt.setInt(2, parmp.time);
      pstmt.setString(3, parmp.course);
      pstmt.setInt(4, parmp.hist_fb);
      pstmt.setString(5, parmp.hist_posid);
      pstmt.setString(6, parmp.hist_player);
      pstmt.setString(7, parmp.hist_item_num);
      pstmt.setString(8, parmp.hist_item_name);
      pstmt.setString(9, parmp.hist_price);
      pstmt.setInt(10, parmp.p9);

      pstmt.executeUpdate();          // execute the prepared stmt

      pstmt.close();   // close the stmt

   }
   catch (Exception exc) {

     SystemUtils.logError("Proshop_sheet_pos - exception in add_POS_hist. Error = " +exc.getMessage());
     return;
   }

 }



 //************************************************************************
 //  addLineNS - create a text file (if not already done) and add a line to it.
 //
 //  Text file = clubname__.txt for NorthStar POS charges (__ is date and time)
 //
 //    The file is built as "clubname__.temp".  Once it is complete it is renamed.
 //    This prevents the possibility of NS picking up the file before it is complete.
 //
 //************************************************************************

 private static void addLineNS(String fname, String line) {

   String dirname = "//home//northstar//pos//";  // create directory name
   String filename = fname + ".temp";            // create full file name (temp file)
   String filename2 = fname + ".txt";            // create full file name (complete file)
   String fileDest = dirname + filename;         // destination (temp file)
   String fileDest2 = dirname + filename2;       // destination (complete file)


   try {
      //
      //  Dir path for the real server
      //
      PrintWriter fout1 = new PrintWriter(new FileWriter(fileDest, true));

      //
      //  Put header line in text file
      //
      fout1.print(line);
      fout1.println();                            // output the line

      fout1.close();

      //
      //  Rename the file if this is the end
      //
      if (line.equals( "EOF" )) {                  // if end of the file

         File tempf = new File(fileDest);          // get temp file
         File tempf2 = new File(fileDest2);        // get complete file name
         tempf.renameTo(tempf2);                   // rename it (file is now complete and ready)
      }

   }
   catch (Exception e2) {

      Utilities.logError("Proshop_sheet_pos.addLineNS: Error adding line to file (NorthStar POS).  Exception=" + e2.getMessage() + ", " + e2.toString());
   }

 }  // end of addLineNS


 
 //************************************************************************
 //  addOlyLine - create a text file (if not already done) and add a line to it.
 //
 //  Text file = arupload.mas (one per course) - for The Olympic Club
 //
 //  Each night we process the POS charges for each course and store
 //  a file.  The club then FTPs in and pulls the files down to process.
 //
 //************************************************************************

 private static void addOlyLine(String line, parmPOS parmp) {

    
   String buname = "";                           // backup file name
   String folder = "cliffs";                     // folder for these charges (one per course under the webapps/olyclub folder)
   
   if (parmp.course.equals("Lake")) {
      
      folder = "lakes";
      
   } else if (parmp.course.equals("Ocean")) {
      
      folder = "ocean";
   }
   
   Calendar cal = new GregorianCalendar();       // get todays date
   int year = cal.get(Calendar.YEAR);
   int month = cal.get(Calendar.MONTH) +1;
   int day = cal.get(Calendar.DAY_OF_MONTH);

   //
   //  Use the date/time to create an extension for the backup file name
   //
   buname = "arupload_" +year+ "-" +month+ "-" +day+ ".txt";  
   
   
   String fileDest1 = "//home//olyclubpos//" +folder+ "//arupload.mas";           // destination for real files

   String fileDest2 = "//home//olyclubpos//archive//" +folder+ "//" +buname;      // destination for backup files


   try {
      
      //
      //  Dir path for the original files
      //
      PrintWriter fout1 = new PrintWriter(new FileWriter(fileDest1, true));

      //
      //  Put line in mas file
      //
      fout1.print(line);
      fout1.println();                            // output the line

      fout1.close();

      //
      //  Dir path for the backup files
      //
      fout1 = new PrintWriter(new FileWriter(fileDest2, true));

      //
      //  Put line in backup text file
      //
      fout1.print(line);
      fout1.println();                            // output the line

      fout1.close();

   }
   catch (Exception e2) {

      Utilities.logError("Proshop_sheet_pos.addOlyLine: Error adding line to file (Olympic Club POS).  Exception=" + e2.getMessage() + ", " + e2.toString());
   }

 }  // end of addOlyLine


 
 //
 //  Add charges to POS array for IBS I/F
 //
 private static void addCharge(parmPOS parm, String posid, String invNumber, double price, double tax, int qty) {

    try {

        //int x = (parm.charges.size() > 0) ? parm.charges.size() - 1 : 0;

        if (parm.charges.size() == 0) {

            parm.charges.add(new ArrayList<String>());
            parm.charges.get(0).add(posid);

        } else {

            // there are already charges in the array so let's check the last posid and see if it's the same as this incoming one
            if (posid != parm.charges.get(parm.charges.size() - 1).get(0)) {

                // it's a different posid than the last one
                parm.charges.add(new ArrayList<String>());
                parm.charges.get(parm.charges.size() - 1).add(posid);
            }

        }
 /*
        if (posid != null) {

            parm.charges.add(new ArrayList<String>());

            parm.charges.get(x).add(posid); // parm.charges.size() - 1

        }
*/
        parm.charges.get(parm.charges.size() - 1).add(invNumber + "|" + price + "|" + tax + "|" + qty);
        //Utilities.logError("addCharge(" + (parm.charges.size() - 1) + ") - Adding: " + invNumber + "|" + price + "|" + tax + "|" + qty);

    } catch (Exception exc) {

        Utilities.logError("Proshop_sheet_pos.addCharge(): Error adding charge to ArrayList.  Exception=" + exc.getMessage() + ", " + exc.toString());
        
    }
 }       // end of IBS addCharge

 
 
 
 // ********************************************************************
 //  Print a receipt for the Olympic Club
 // ********************************************************************

 public static void printReceipt(HttpServletRequest req, HttpServletResponse resp, PrintWriter out, HttpSession session,
                           Connection con) {
    
    printReceipt(req, resp, out, session, con, false);      // go process for current tee sheet
 }
 

 public static void printReceipt(HttpServletRequest req, HttpServletResponse resp, PrintWriter out, HttpSession session,
                           Connection con, boolean oldsheets) {

   Statement stmt = null;
   PreparedStatement pstmt2s = null;

   ResultSet rs = null;

   String player1 = "";
   String player2 = "";
   String player3 = "";
   String player4 = "";
   String player5 = "";
   String user1 = "";
   String user2 = "";
   String user3 = "";
   String user4 = "";
   String user5 = "";
   String p1cw = "";
   String p2cw = "";
   String p3cw = "";
   String p4cw = "";
   String p5cw = "";
   String userg1 = "";
   String userg2 = "";
   String userg3 = "";
   String userg4 = "";
   String userg5 = "";
   String mNum1 = "";
   String mNum2 = "";
   String mNum3 = "";
   String mNum4 = "";
   String mNum5 = "";
   String course = "";
   String temp = "";
   String day = "";
   String ampm = "";
   String stime = "";
   String tee_id = "";

   int guest = 0;
   int p91 = 0;
   int p92 = 0;
   int p93 = 0;
   int p94 = 0;
   int p95 = 0;
   int show1 = 0;
   int show2 = 0;
   int show3 = 0;
   int show4 = 0;
   int show5 = 0;
   int i = 0;
   int ttid = 0;
   int fb = 0;
   int time = 0;
   int time2 = 0;
   int hr = 0;
   int min = 0;
   int charges1 = 0;
   int charges2 = 0;
   int charges3 = 0;
   int charges4 = 0;
   int charges5 = 0;
   int mm = 0;
   int dd = 0;
   int yy = 0;
   long date = 0;
   
   boolean checkP1 = false;
   boolean checkP2 = false;
   boolean checkP3 = false;
   boolean checkP4 = false;
   boolean checkP5 = false;
   boolean checkAll = false;
   
   String caller = "prtReceipt";
   
   String club = (String)session.getAttribute("club");      // get club name

   //
   //  Get the tee time parms passed
   //
   if (req.getParameter("teecurr_id") != null) {
      
      tee_id = req.getParameter("teecurr_id");
      
   } else if (req.getParameter("teepast_id") != null) {
      
      tee_id = req.getParameter("teepast_id");
   }   
   
   ttid = Integer.parseInt(tee_id);

   //
   //  parm block to hold the club parameters
   //
   parmClub parm = new parmClub(0, con);

   //
   //  parm block to hold the POS parameters
   //
   parmPOS parmp = new parmPOS();

   try {
      //
      // Get the Guest Types from the club db
      //
      getClub.getParms(con, parm);        // get the club parms

      //
      //  Get the POS System Parameters for this Club & Course
      //
      getClub.getPOS(con, parmp, course);

   }
   catch (Exception e1) {
   }

   //
   //   Save club name in parmp
   //
   parmp.club = club;

   parmp.count = 0;                 // init record counter
   
   
   //
   //  Determine if this is the first call (check for charges & prompt) or 2nd call (list the charges for selected players)
   //
   if (req.getParameter("prtReceipt2") != null) {
      
      checkAll = false;
      
      //  get the players to list
      
      if (req.getParameter("p1") != null && req.getParameter("p1").equalsIgnoreCase("1")) {
         
         checkP1 = true;
      }
      if (req.getParameter("p2") != null && req.getParameter("p2").equalsIgnoreCase("1")) {
         
         checkP2 = true;
      }
      if (req.getParameter("p3") != null && req.getParameter("p3").equalsIgnoreCase("1")) {
         
         checkP3 = true;
      }
      if (req.getParameter("p4") != null && req.getParameter("p4").equalsIgnoreCase("1")) {
         
         checkP4 = true;
      }
      if (req.getParameter("p5") != null && req.getParameter("p5").equalsIgnoreCase("1")) {
         
         checkP5 = true;
      }          
      
   } else {     // this is the 1st call
      
      checkAll = true;      // check all players for charges and prompt user 
   }

      
   //
   //  Get the players for this tee time and then get their charges
   //
   try {

      if (oldsheets == false) {
         
         pstmt2s = con.prepareStatement (
            "SELECT * " +
            "FROM teecurr2 WHERE teecurr_id = ?");

      } else {
         
         pstmt2s = con.prepareStatement (
            "SELECT * " +
            "FROM teepast2 WHERE teepast_id = ?");
      }
         
      pstmt2s.clearParameters();        // clear the parms
      pstmt2s.setInt(1, ttid);

      rs = pstmt2s.executeQuery();      // execute the prepared stmt

      if (rs.next()) {

         date = rs.getLong("date");
         mm = rs.getInt("mm");
         dd = rs.getInt("dd");
         yy = rs.getInt("yy");
         day = rs.getString("day");
         hr = rs.getInt("hr");
         min = rs.getInt("min");
         time = rs.getInt("time");
         player1 = rs.getString("player1");
         player2 = rs.getString("player2");
         player3 = rs.getString("player3");
         player4 = rs.getString("player4");
         user1 = rs.getString("username1");
         user2 = rs.getString("username2");
         user3 = rs.getString("username3");
         user4 = rs.getString("username4");
         p1cw = rs.getString("p1cw");
         p2cw = rs.getString("p2cw");
         p3cw = rs.getString("p3cw");
         p4cw = rs.getString("p4cw");
         show1 = rs.getInt("show1");
         show2 = rs.getInt("show2");
         show3 = rs.getInt("show3");
         show4 = rs.getInt("show4");
         fb = rs.getInt("fb");
         player5 = rs.getString("player5");
         user5 = rs.getString("username5");
         p5cw = rs.getString("p5cw");
         course = rs.getString("courseName");
         show5 = rs.getInt("show5");
         userg1 = rs.getString("userg1");
         userg2 = rs.getString("userg2");
         userg3 = rs.getString("userg3");
         userg4 = rs.getString("userg4");
         userg5 = rs.getString("userg5");
         mNum1 = rs.getString("mNum1");
         mNum2 = rs.getString("mNum2");
         mNum3 = rs.getString("mNum3");
         mNum4 = rs.getString("mNum4");
         mNum5 = rs.getString("mNum5");
         p91 = rs.getInt("p91");
         p92 = rs.getInt("p92");
         p93 = rs.getInt("p93");
         p94 = rs.getInt("p94");
         p95 = rs.getInt("p95");

         parmp.day = day;       // save tee time values in parmp
         parmp.time = time;
         parmp.date = date;
         parmp.sdate = String.valueOf((date-20000000));              // yymmdd
         parmp.course = course;
         parmp.item = "";                // use this field for the player charge information
   
         //
         //  Process one player at a time to determine any charges
         //
         if (!player1.equalsIgnoreCase( "x" ) && !player1.equals( "" ) && (checkAll == true || checkP1 == true)) {

            //
            //  Check if player name is member or guest
            //
            i = 0;
            guest = 0;

            if (user1.equals( "" )) {            // if no username for this player

               ploop1:
               while (i < parm.MAX_Guests) {
                  if (player1.startsWith( parm.guest[i] )) {

                     guest = 1;       // indicate player1 is a guest name
                     break ploop1;
                  }
                  i++;
               }
            }
            parmp.pcw = p1cw;
            parmp.p9 = p91;

            if (guest == 0) {        // if member

               if (!user1.equals( "" )) {      // skip if no user name found or already processed

                  parmp.player = "";           // indicate member
                  parmp.user = user1;

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     charges1 = buildCSG(parmp, out, con, club, ttid, caller);
                  }
               }

            } else {          // else guest

               if (!userg1.equals( "" )) {      // skip if no member associated with this guest

                  parmp.player = player1;       // indicate guest - pass the guest type
                  parmp.user = userg1;

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     charges1 = buildCSG(parmp, out, con, club, ttid, caller);
                  }
               }
            }   // end of IF member or guest
         }      // end of IF player not X and not null

         if (!player2.equalsIgnoreCase( "x" ) && !player2.equals( "" ) && (checkAll == true || checkP2 == true)) {

            //
            //  Check if player name is member or guest
            //
            i = 0;
            guest = 0;

            if (user2.equals( "" )) {            // if no username for this player

               ploop1:
               while (i < parm.MAX_Guests) {
                  if (player2.startsWith( parm.guest[i] )) {

                     guest = 1;       // indicate player1 is a guest name
                     break ploop1;
                  }
                  i++;
               }
            }
            parmp.pcw = p2cw;
            parmp.p9 = p92;

            if (guest == 0) {        // if member

               if (!user2.equals( "" )) {      // skip if no user name found or already processed

                  parmp.player = "";           // indicate member
                  parmp.user = user2;

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     charges2 = buildCSG(parmp, out, con, club, ttid, caller);
                  }
               }

            } else {          // else guest

               if (!userg2.equals( "" )) {      // skip if no member associated with this guest

                  parmp.player = player2;       // indicate guest - pass the guest type
                  parmp.user = userg2;

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     charges2 = buildCSG(parmp, out, con, club, ttid, caller);
                  }
               }
            }   // end of IF member or guest
         }      // end of IF player not X and not null

         if (!player3.equalsIgnoreCase( "x" ) && !player3.equals( "" ) && (checkAll == true || checkP3 == true)) {

            //
            //  Check if player name is member or guest
            //
            i = 0;
            guest = 0;

            if (user3.equals( "" )) {            // if no username for this player

               ploop1:
               while (i < parm.MAX_Guests) {
                  if (player3.startsWith( parm.guest[i] )) {

                     guest = 1;       // indicate player1 is a guest name
                     break ploop1;
                  }
                  i++;
               }
            }
            parmp.pcw = p3cw;
            parmp.p9 = p93;

            if (guest == 0) {        // if member

               if (!user3.equals( "" )) {      // skip if no user name found or already processed

                  parmp.player = "";           // indicate member
                  parmp.user = user3;

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     charges3 = buildCSG(parmp, out, con, club, ttid, caller);
                  }
               }

            } else {          // else guest

               if (!userg3.equals( "" )) {      // skip if no member associated with this guest

                  parmp.player = player3;       // indicate guest - pass the guest type
                  parmp.user = userg3;

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     charges3 = buildCSG(parmp, out, con, club, ttid, caller);
                  }
               }
            }   // end of IF member or guest
         }      // end of IF player not X and not null

         if (!player4.equalsIgnoreCase( "x" ) && !player4.equals( "" ) && (checkAll == true || checkP4 == true)) {

            //
            //  Check if player name is member or guest
            //
            i = 0;
            guest = 0;

            if (user4.equals( "" )) {            // if no username for this player

               ploop1:
               while (i < parm.MAX_Guests) {
                  if (player4.startsWith( parm.guest[i] )) {

                     guest = 1;       // indicate player1 is a guest name
                     break ploop1;
                  }
                  i++;
               }
            }
            parmp.pcw = p4cw;
            parmp.p9 = p94;

            if (guest == 0) {        // if member

               if (!user4.equals( "" )) {      // skip if no user name found or already processed

                  parmp.player = "";           // indicate member
                  parmp.user = user4;

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     charges4 = buildCSG(parmp, out, con, club, ttid, caller);
                  }
               }

            } else {          // else guest

               if (!userg4.equals( "" )) {      // skip if no member associated with this guest

                  parmp.player = player4;       // indicate guest - pass the guest type
                  parmp.user = userg4;

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     charges4 = buildCSG(parmp, out, con, club, ttid, caller);
                  }
               }
            }   // end of IF member or guest
         }      // end of IF player not X and not null

         if (!player5.equalsIgnoreCase( "x" ) && !player5.equals( "" ) && (checkAll == true || checkP5 == true)) {

            //
            //  Check if player name is member or guest
            //
            i = 0;
            guest = 0;

            if (user5.equals( "" )) {            // if no username for this player

               ploop1:
               while (i < parm.MAX_Guests) {
                  if (player5.startsWith( parm.guest[i] )) {

                     guest = 1;       // indicate player1 is a guest name
                     break ploop1;
                  }
                  i++;
               }
            }
            parmp.pcw = p5cw;
            parmp.p9 = p95;

            if (guest == 0) {        // if member

               if (!user5.equals( "" )) {      // skip if no user name found or already processed

                  parmp.player = "";           // indicate member
                  parmp.user = user5;

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     charges5 = buildCSG(parmp, out, con, club, ttid, caller);
                  }
               }

            } else {          // else guest

               if (!userg5.equals( "" )) {      // skip if no member associated with this guest

                  parmp.player = player5;       // indicate guest - pass the guest type
                  parmp.user = userg5;

                  if (parmp.posType.equals( "ClubSystems Group" )) {

                     charges5 = buildCSG(parmp, out, con, club, ttid, caller);
                  }
               }
            }   // end of IF member or guest
         }      // end of IF player not X and not null
   
      }     // end of IF teecurr2 data

      pstmt2s.close();

   }
   catch (Exception e1) {

      String errorMsg1 = "Error1 in Proshop_sheet_pos.printReceipt: ";
      errorMsg1 = errorMsg1 + e1.getMessage();                                // build error msg

      SystemUtils.logError(errorMsg1);                                       // log it
   }

   //
   //  Output the receipt if any charges found
   //
   //    parmp.item contains the charge info - each charge preceeded by an ";" and fields separated by commas
   //
   out.println(SystemUtils.HeadTitle("Proshop Print Receipt"));
   out.println("<body bgcolor=\"#FFFFFF\" text=\"#000000\">");
   out.println("<font face=\"Arial, Helvetica, Sans-serif\"><center>");

   if (!parmp.item.equals("")) {      // if any charges found
      
      if (checkAll == true) {
         
         // display a list of players that have charges and prompt user to select the ones they want on the receipt
         
         if (oldsheets == false) {
         
            out.println("<form action=\"/" +rev+ "/servlet/Proshop_sheet\" method=\"post\">");
            out.println("<input type=\"hidden\" name=\"teecurr_id\" value=\"" +ttid+ "\">");  // 2nd call
            
         } else {
            
            out.println("<form action=\"/" +rev+ "/servlet/Proshop_oldsheets\" method=\"post\">");
            out.println("<input type=\"hidden\" name=\"teepast_id\" value=\"" +ttid+ "\">");  // 2nd call
         }
         out.println("<input type=\"hidden\" name=\"prtReceipt\" value=\"yes\">");   // this will get us back here
         out.println("<input type=\"hidden\" name=\"prtReceipt2\" value=\"yes\">");  // 2nd call
         out.println("<font size=\"3\">");
         out.println("<b>Charges Found</b>");
         out.println("</font>");
         out.println("<font size=\"2\"><br><br>Please select the players to include on the receipt.<br><br>");
         out.println("Player 1 in this group is <b>" +player1+ "</b>.<br><br>");
         
         out.println("<table border=\"0\" valign=\"top\" align=\"center\" width=\"240\">");    
         out.println("<tr><td align=\"left\"><font size=\"2\">");

         if (charges1 > 0) {
            out.println("&nbsp;&nbsp;&nbsp;<input type=\"checkbox\" name=\"p1\" value=\"1\">&nbsp;&nbsp;&nbsp;" +player1+ "<BR>");
         }
         if (charges2 > 0) {
            out.println("&nbsp;&nbsp;&nbsp;<input type=\"checkbox\" name=\"p2\" value=\"1\">&nbsp;&nbsp;&nbsp;" +player2+ "<BR>");
         }
         if (charges3 > 0) {
            out.println("&nbsp;&nbsp;&nbsp;<input type=\"checkbox\" name=\"p3\" value=\"1\">&nbsp;&nbsp;&nbsp;" +player3+ "<BR>");
         }
         if (charges4 > 0) {
            out.println("&nbsp;&nbsp;&nbsp;<input type=\"checkbox\" name=\"p4\" value=\"1\">&nbsp;&nbsp;&nbsp;" +player4+ "<BR>");
         }
         if (charges5 > 0) {
            out.println("&nbsp;&nbsp;&nbsp;<input type=\"checkbox\" name=\"p5\" value=\"1\">&nbsp;&nbsp;&nbsp;" +player5+ "<BR>");
         }
         
         out.println("</font></td></tr>");        
         out.println("</table>");
         
         out.println("<table border=\"0\" valign=\"top\">");       // table for main page
         out.println("<tr><td align=\"center\">");
         out.println("<input type=\"submit\" value=\"Continue\" style=\"text-decoration:underline; background:#8B8970\"></form>");
         out.println("</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
         out.println("</td><td align=\"center\">");
         out.println("<form><br>");
         out.println("<input type=\"button\" style=\"text-decoration:underline; background:#8B8970\" Value=\"Close\" onClick='self.close()' alt=\"Close\">");
         out.println("</form>");
         out.println("</td></tr></table>");
         
         
      } else {
         
         StringTokenizer tok = null;         
         StringTokenizer tok2 = null;      
         
         double subtotal = 0;
         double taxtotal = 0;
         double grandtotal = 0;
         
         String fee = "";
         String tax = "";
         String charge = "";
         String lastPlayer = "";
         String price = "";
         
         String [] playerA = new String [10];     // allow for 2 charges per player
         String [] posidA = new String [10];
         String [] itemA = new String [10];
         double [] feeA = new double [10];
         double [] taxA = new double [10];
         
         for (i=0; i<10; i++) {
            
            playerA[i] = "";      // init the arrays
            posidA[i] = "";
            itemA[i] = "";
            feeA[i] = 0;
            taxA[i] = 0;
         }         
         
         i = 0;
         
         //
         //  Parse the charges from parmp.item 
         //
         //    Format:   charge1;charge2;charge3;....etc
         //
         //           charges:  member name, posid, item description, fee, tax
         //
         tok = new StringTokenizer( parmp.item, ";" );     // delimiter between charges is a colon

         int tokcount = tok.countTokens();
         
         while (tokcount > 0) {          // get all charges
            
            charge = tok.nextToken();
            
            if (!charge.equals("")) {     // if anything there
               
               tok2 = new StringTokenizer( charge, "," );     // delimiter between charge fields is a comma
               
               playerA[i] = tok2.nextToken();
               posidA[i] = tok2.nextToken();
               itemA[i] = tok2.nextToken();
               fee = tok2.nextToken();
               tax = tok2.nextToken();   
               if (fee.equals("0") || fee.equals("       0.00")) {
                  feeA[i] = 0.00;                                 
               } else {
                  fee = setFee(fee);                     // ensure dollar value (i.e.  2.34 or 0.00)
                  feeA[i] = Double.parseDouble(fee);
               }
               if (tax.equals("0") || tax.equals("       0.00")) {
                  taxA[i] = 0.00;                                 
               } else {
                  tax = setFee(tax);
                  taxA[i] = Double.parseDouble(tax);               
               }
            }            
            i++;
            tokcount--;
         }
         
         if (hr > 12) hr = hr - 12;
         
         stime = hr + ":" + SystemUtils.ensureDoubleDigit(min);
         

         out.println("<font size=\"2\">");
         out.println("<table border=\"0\" valign=\"top\" align=\"center\" width=\"250\">");    
         out.println("<tr><td align=\"left\" colspan=\"2\"><font size=\"2\">");
         out.println("The Olympic Club<BR>Tee Time: " +mm+ "/" +dd+ "/" +yy+ "&nbsp;&nbsp;&nbsp;" +day+ "&nbsp;&nbsp;&nbsp;" +course+ "&nbsp;&nbsp;&nbsp;" +stime+ "<BR><BR>");
         out.println("</font></td></tr>");
         //
         //  Add each individual charge
         //
         for (i=0; i<10; i++) {
            
            if (!playerA[i].equals("")) {
            
               out.println("<tr><td align=\"left\"><font size=\"2\">");
               if (playerA[i].equals(lastPlayer)) {
                  out.println("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" +itemA[i]);
                  out.println("</font></td><td align=\"right\"><font size=\"2\">");
                  price = String.valueOf(feeA[i]);  
                  price = setFee(price);
                  out.println("$" +price+ "<BR>");
                  out.println("</font></td></tr>");
               } else {
                  out.println(playerA[i]+ " - " +posidA[i]+ "<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" +itemA[i]);
                  lastPlayer = playerA[i];
                  out.println("</font></td><td align=\"right\"><font size=\"2\">");
                  price = String.valueOf(feeA[i]);  
                  price = setFee(price);
                  out.println("<BR>$" +price+ "<BR>");
                  out.println("</font></td></tr>");
               }
               
               subtotal += feeA[i];
               taxtotal += taxA[i];
            }
         }
         
         grandtotal = subtotal + taxtotal;
         
         out.println("<tr><td align=\"left\"><font size=\"2\">");          // totals
         out.println("&nbsp;");
         out.println("</font></td><td align=\"right\"><font size=\"2\">");
         out.println("<BR>_________");
         out.println("</font></td></tr>");
         out.println("<tr><td align=\"left\"><font size=\"2\">");          // sub total
         out.println("Sub Total:");
         out.println("</font></td><td align=\"right\"><font size=\"2\">");
         price = String.valueOf(subtotal);  
         price = setFee(price);
         out.println("$" +price);
         out.println("</font></td></tr>");
         out.println("<tr><td align=\"left\"><font size=\"2\">");          // tax
         out.println("Tax:");
         out.println("</font></td><td align=\"right\"><font size=\"2\">");
         price = String.valueOf(taxtotal);  
         price = setFee(price);
         out.println("$" +price);
         out.println("</font></td></tr>");
         out.println("<tr><td align=\"left\"><font size=\"2\">");          // grand total
         out.println("Total:");
         out.println("</font></td><td align=\"right\"><font size=\"2\">");
         price = String.valueOf(grandtotal);  
         price = setFee(price);
         out.println("$" +price);
         out.println("</font></td></tr>");
         
         out.println("<tr><td align=\"left\" colspan=\"2\"><font size=\"2\">");
         out.println("<BR><BR><BR>Signature______________________________");
         out.println("<BR><BR>Welcome to The Olympic Club");
         out.println("<BR><BR><a href=\"#\" onclick=\"javascript:self.print()\">Have a Nice Day!</a>");
         out.println("</font></td></tr>");        
         out.println("</table></font>");
      }
      
   } else {     // no charges to report
   
      out.println("<font size=\"3\">");
      out.println("<b>No Charges Found</b>");
      out.println("</font>");
      out.println("<font size=\"2\"><br><br>");
      out.println("There were no charges found for this tee time.<br><br>");
      out.println("<form><input type=\"button\" style=\"text-decoration:underline; background:#8B8970\" Value=\"Close\" onClick='self.close()' alt=\"Close\">");
      out.println("</form>");
   }

   out.println("</center></font></body></html>");
   out.close();
      
 }  // end of printReceipt




 // *********************************************************
 //  Strip 1 char from the start of a string
 // *********************************************************

 private final static String stripOne( String s ) {

      char[] ca = s.toCharArray();
      char[] ca2 = new char [ca.length - 1];


      for ( int i=0; i<(ca.length-1); i++ ) {
         char oldLetter = ca[i+1];
         ca2[i] = oldLetter;
      }

      return new String (ca2);

 } // end stripOne


 // *********************************************************
 //  Strip 1 char from the END of a string
 // *********************************************************

 private final static String stripLast( String s ) {

      char[] ca = s.toCharArray();
      char[] ca2 = new char [ca.length - 1];


      for ( int i=0; i<(ca.length-1); i++ ) {
         char oldLetter = ca[i];
         ca2[i] = oldLetter;
      }

      return new String (ca2);

 } // end stripLast
 
}
